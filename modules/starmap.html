<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Elite: Dark Frontier — Star Map</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap');
:root{
 --pri:#f0a030;--pri-b:#ffe088;--pri-d:#8a5a10;
 --bg:#08060e;--glass:rgba(12,8,20,.88);
 --grn:#40ff80;--red:#ff5050;--blu:#40a0ff;--cyn:#00e8ff;
 --font:'Share Tech Mono',monospace;--font-t:'Orbitron',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:var(--bg);font-family:var(--font);color:#d0c090}
canvas{display:block}
#crt{position:fixed;inset:0;pointer-events:none;z-index:99999;
 background:repeating-linear-gradient(0deg,rgba(255,200,100,.012) 0px,rgba(0,0,0,.05) 1px,transparent 2px);
 mix-blend-mode:multiply}
#hud-top{position:fixed;top:0;left:0;right:0;height:42px;z-index:8000;
 display:flex;align-items:center;padding:0 16px;gap:12px;
 background:linear-gradient(180deg,rgba(8,6,14,.95),rgba(8,6,14,.7));
 border-bottom:1px solid rgba(240,160,48,.15);backdrop-filter:blur(12px)}
.hud-left{display:flex;align-items:center;gap:10px}
.logo{font-family:var(--font-t);font-size:11px;font-weight:700;color:var(--pri-b);
 letter-spacing:3px;text-shadow:0 0 16px rgba(240,160,48,.5)}
#star-count{font-size:11px;color:var(--pri-d);letter-spacing:1px}
.hud-center{flex:1;text-align:center;font-family:var(--font-t);font-size:12px;
 color:var(--pri-b);letter-spacing:2px;text-shadow:0 0 10px rgba(240,160,48,.3)}
.hud-right{display:flex;align-items:center;gap:16px}
.hud-stat{display:flex;align-items:center;gap:5px}
.hud-stat .lab{font-size:10px;color:var(--pri-d);letter-spacing:1px}
.hud-stat .val{font-size:14px;color:var(--pri-b);font-weight:bold;text-shadow:0 0 8px rgba(255,200,0,.2)}
#drawer{position:fixed;top:42px;right:-380px;width:370px;height:calc(100vh - 42px);
 background:var(--glass);border-left:1px solid rgba(240,160,48,.15);
 backdrop-filter:blur(16px);z-index:7000;transition:right .35s cubic-bezier(.4,0,.2,1);
 display:flex;flex-direction:column}
#drawer.open{right:0}
.dtabs{display:flex;border-bottom:1px solid rgba(240,160,48,.1);overflow-x:auto;scrollbar-width:none;flex-shrink:0}
.dtabs::-webkit-scrollbar{display:none}
.dtab{background:none;border:none;color:var(--pri-d);padding:10px 12px;font-family:var(--font);
 font-size:12px;cursor:pointer;white-space:nowrap;letter-spacing:1px;text-transform:uppercase;
 transition:all .2s;border-bottom:2px solid transparent}
.dtab:hover{color:var(--pri)}
.dtab.act{color:var(--pri-b);border-bottom-color:var(--pri);text-shadow:0 0 8px rgba(240,160,48,.3)}
#drawer-body{flex:1;overflow-y:auto;padding:14px;font-size:14px;scrollbar-width:thin;scrollbar-color:var(--pri) transparent}
#drawer-body::-webkit-scrollbar{width:4px}
#drawer-body::-webkit-scrollbar-thumb{background:var(--pri);border-radius:2px}
.d-close{position:absolute;top:6px;right:10px;background:none;border:none;color:var(--pri-d);
 font-size:20px;cursor:pointer;z-index:2;transition:color .2s}
.d-close:hover{color:var(--pri)}
.d-title{font-family:var(--font-t);font-size:11px;color:var(--pri-b);letter-spacing:2px;
 margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid rgba(240,160,48,.1)}
.d-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(240,160,48,.04)}
.d-row .lab{color:var(--pri-d)} .d-row .val{color:var(--pri-b);font-weight:bold}
.d-btn{background:rgba(240,160,48,.1);border:1px solid rgba(240,160,48,.3);color:var(--pri-b);
 padding:8px 14px;cursor:pointer;font-family:var(--font);font-size:13px;border-radius:4px;
 transition:all .2s;text-transform:uppercase;letter-spacing:1px;width:100%;margin-top:6px}
.d-btn:hover{background:rgba(240,160,48,.2);border-color:var(--pri)}
.d-btn:disabled{opacity:.3;cursor:not-allowed}
.d-btn-grn{border-color:rgba(64,255,128,.3);color:var(--grn)}
.d-btn-red{border-color:rgba(255,80,80,.3);color:var(--red)}
.d-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0}
.d-card{background:rgba(240,160,48,.03);border:1px solid rgba(240,160,48,.08);
 border-radius:4px;padding:8px;text-align:center}
.d-card .num{font-size:18px;color:var(--pri-b)} .d-card .lab{font-size:10px;color:var(--pri-d)}
.trade-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;
 border-bottom:1px solid rgba(240,160,48,.05)}
.trade-btns{display:flex;gap:4px}
.trade-btns button{background:rgba(240,160,48,.08);border:1px solid rgba(240,160,48,.2);
 color:var(--pri);padding:3px 8px;cursor:pointer;font-family:var(--font);font-size:11px;
 border-radius:3px;transition:all .15s}
.trade-btns button:hover{background:rgba(240,160,48,.2)}
.nasa-img{width:100%;border-radius:4px;margin-bottom:8px;border:1px solid rgba(240,160,48,.1)}
.neo-item{padding:6px 0;border-bottom:1px solid rgba(240,160,48,.04)}
.neo-name{color:var(--pri-b);font-weight:bold} .neo-info{font-size:12px;color:var(--pri-d)}
#actions{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:6000;
 display:flex;gap:6px;padding:6px 10px;background:var(--glass);
 border:1px solid rgba(240,160,48,.12);border-radius:24px;backdrop-filter:blur(12px)}
.act-btn{width:40px;height:40px;border-radius:50%;background:rgba(240,160,48,.06);
 border:1px solid rgba(240,160,48,.2);color:var(--pri);font-size:16px;cursor:pointer;
 display:flex;align-items:center;justify-content:center;transition:all .2s}
.act-btn:hover{background:rgba(240,160,48,.15);border-color:var(--pri);box-shadow:0 0 12px rgba(240,160,48,.15)}
.act-btn.active{background:rgba(240,160,48,.2);border-color:var(--pri)}
#search{position:fixed;inset:0;background:rgba(8,6,14,.85);z-index:9000;
 display:flex;align-items:flex-start;justify-content:center;padding-top:15vh;
 backdrop-filter:blur(8px);transition:opacity .2s}
#search.hidden{opacity:0;pointer-events:none}
.search-box{width:90%;max-width:500px}
#search-input{width:100%;background:var(--glass);border:1px solid rgba(240,160,48,.3);
 color:var(--pri-b);padding:14px 18px;font-family:var(--font);font-size:16px;
 border-radius:8px;outline:none;letter-spacing:1px;box-shadow:0 8px 32px rgba(0,0,0,.4)}
#search-input:focus{border-color:var(--pri)}
#search-input::placeholder{color:var(--pri-d)}
#search-results{max-height:40vh;overflow-y:auto;margin-top:4px;border-radius:8px;
 background:var(--glass);border:1px solid rgba(240,160,48,.1)}
.sr-item{padding:10px 16px;cursor:pointer;border-bottom:1px solid rgba(240,160,48,.05);
 transition:background .15s;font-size:14px}
.sr-item:hover{background:rgba(240,160,48,.08)}
.sr-item .sr-name{color:var(--pri-b)} .sr-item .sr-sub{color:var(--pri-d);font-size:11px}
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:9500;
 background:var(--glass);border:1px solid rgba(240,160,48,.2);border-radius:8px;
 padding:10px 20px;color:var(--pri-b);font-size:14px;backdrop-filter:blur(12px);
 transition:all .3s;white-space:nowrap}
#toast.hidden{opacity:0;transform:translateX(-50%) translateY(20px);pointer-events:none}
#route-sel{position:fixed;top:50px;left:50%;transform:translateX(-50%);z-index:6500;
 background:var(--glass);border:1px solid rgba(240,160,48,.2);border-radius:8px;
 padding:16px 20px;text-align:center;backdrop-filter:blur(12px);min-width:300px;transition:all .3s}
#route-sel.hidden{opacity:0;pointer-events:none;transform:translateX(-50%) translateY(-20px)}
#route-sel h3{font-family:var(--font-t);font-size:11px;color:var(--pri-b);letter-spacing:2px;margin-bottom:8px}
.rp{display:inline-block;padding:4px 12px;border:1px solid rgba(240,160,48,.2);border-radius:4px;margin:4px;font-size:12px}
.rp.start{border-color:rgba(64,255,128,.3);color:var(--grn)}
.rp.end{border-color:rgba(64,160,255,.3);color:var(--blu)}
#route-sel .d-btn{margin-top:8px;width:auto;display:inline-block;padding:6px 16px}
#hover{position:fixed;pointer-events:none;z-index:7500;background:var(--glass);
 border:1px solid rgba(240,160,48,.2);border-radius:6px;padding:10px 14px;max-width:280px;
 font-size:13px;backdrop-filter:blur(10px);opacity:0;transition:opacity .15s}
#hover.show{opacity:1}
#hover .h-name{font-family:var(--font-t);font-size:11px;color:var(--pri-b);letter-spacing:1px;margin-bottom:4px}
#help{position:fixed;inset:0;background:rgba(8,6,14,.94);z-index:50000;
 display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;
 backdrop-filter:blur(6px)}
#help h1{font-family:var(--font-t);font-size:20px;color:var(--pri-b);
 text-shadow:0 0 30px rgba(240,160,48,.6);letter-spacing:5px;margin-bottom:12px}
#help p{color:#a09070;font-size:17px;text-align:center;max-width:500px;line-height:1.6}
#help .keys{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:20px 0;max-width:500px}
#help .keys span{background:rgba(240,160,48,.06);border:1px solid rgba(240,160,48,.15);
 padding:6px 12px;border-radius:4px;font-size:13px;color:#b0a080}
#help .keys b{color:var(--pri-b)}
#help .hint{color:var(--pri-d);font-size:14px;animation:blink 1.5s ease-in-out infinite;letter-spacing:2px;margin-top:20px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
#mob-toggle{display:none;position:fixed;top:50px;right:8px;z-index:6000;width:36px;height:36px;
 border-radius:50%;background:var(--glass);border:1px solid rgba(240,160,48,.2);
 color:var(--pri);font-size:16px;cursor:pointer}
#mob-controls{display:none;position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
 z-index:6000;gap:6px;flex-wrap:wrap;justify-content:center}
.touch-btn{width:44px;height:44px;background:rgba(240,160,48,.08);
 border:1px solid rgba(240,160,48,.25);color:var(--pri);font-size:16px;
 display:flex;align-items:center;justify-content:center;border-radius:10px;
 -webkit-tap-highlight-color:transparent;touch-action:manipulation;user-select:none;transition:all .15s}
.touch-btn:active{background:rgba(240,160,48,.3);border-color:var(--pri)}
.star-label{font-family:var(--font);font-size:11px;color:var(--grn);
 text-shadow:0 0 6px rgba(64,255,128,.3);background:rgba(0,30,15,.7);
 border:1px solid rgba(64,255,128,.3);padding:2px 7px;white-space:nowrap;pointer-events:none;border-radius:3px}
.ship-tag{font-family:var(--font);font-size:10px;color:#ffe8a0;
 background:rgba(20,12,0,.8);border:1px solid rgba(240,160,48,.3);
 padding:2px 6px;white-space:nowrap;pointer-events:none;border-radius:3px}
@media(max-width:768px){
 .logo{font-size:9px;letter-spacing:1px}
 #star-count,.hud-center{display:none}
 #drawer{width:100%;right:-100%}
 #actions{bottom:60px;gap:4px;padding:4px 8px}
 .act-btn{width:36px;height:36px;font-size:14px}
 #mob-toggle{display:flex;align-items:center;justify-content:center}
 #help h1{font-size:14px}
 #route-sel{min-width:90vw}
}
</style>
</head>
<body>

<div id="crt"></div>
<div id="hud-top">
 <div class="hud-left"><span class="logo">ELITE: DARK FRONTIER</span><span id="star-count">...</span></div>
 <div class="hud-center" id="sys-display">SOL SYSTEM</div>
 <div class="hud-right">
  <div class="hud-stat"><span class="lab">CR</span><span class="val" id="h-cr">10000</span></div>
  <div class="hud-stat"><span class="lab">FUEL</span><span class="val" id="h-fuel">7.0</span></div>
  <div class="hud-stat"><span class="lab">CARGO</span><span class="val"><span id="h-cargo">0</span>/<span id="h-cmax">22</span></span></div>
  <div class="hud-stat"><span class="lab">RANK</span><span class="val" id="h-rank">Harmless</span></div>
 </div>
</div>
<div id="drawer">
 <button class="d-close" id="drawer-close">&times;</button>
 <div class="dtabs">
  <button class="dtab act" data-tab="info">&#x2139; SYSTEM</button>
  <button class="dtab" data-tab="trade">&#x1F4B0; TRADE</button>
  <button class="dtab" data-tab="ship">&#x1F680; SHIP</button>
  <button class="dtab" data-tab="route">&#x1F4CD; ROUTE</button>
  <button class="dtab" data-tab="nasa">&#x1F6F0; NASA</button>
 </div>
 <div id="drawer-body"></div>
</div>
<div id="actions">
 <button class="act-btn" id="act-solar">&#9788;</button>
 <button class="act-btn" id="act-trade">&#9889;</button>
 <button class="act-btn" id="act-route">&#128205;</button>
 <button class="act-btn" id="act-panel">&#9776;</button>
 <button class="act-btn" id="act-search">&#128269;</button>
 <button class="act-btn" id="act-nasa">&#128752;</button>
 <button class="act-btn" id="act-save">&#128190;</button>
</div>
<div id="search" class="hidden">
 <div class="search-box">
  <input id="search-input" placeholder="Search HIP stars..." autocomplete="off">
  <div id="search-results"></div>
 </div>
</div>
<div id="toast" class="hidden"></div>
<div id="route-sel" class="hidden">
 <h3>ROUTE PLANNER</h3>
 <div id="route-status">RMB on star = start point</div>
 <div><span class="rp start" id="rp-start">START: &mdash;</span><span class="rp end" id="rp-end">END: &mdash;</span></div>
 <button class="d-btn" id="route-calc" disabled>CALCULATE</button>
 <button class="d-btn d-btn-red" id="route-cancel">CANCEL</button>
</div>
<div id="hover"><div class="h-name" id="hv-name"></div><div id="hv-body"></div></div>
<div id="help">
 <h1>ELITE: DARK FRONTIER</h1>
 <p>5000 real Hipparcos stars &bull; NASA live data &bull; trade &amp; explore</p>
 <div class="keys">
  <span><b>WASD</b> move</span><span><b>Q/E</b> up/down</span>
  <span><b>Shift</b> boost</span><span><b>DblClick</b> fly to</span>
  <span><b>RMB</b> route point</span><span><b>/</b> search</span>
 </div>
 <p class="hint">[ CLICK TO START ]</p>
</div>
<button id="mob-toggle">&#9881;</button>
<div id="mob-controls">
 <button class="touch-btn" data-act="fwd">&#9650;</button>
 <button class="touch-btn" data-act="left">&#9664;</button>
 <button class="touch-btn" data-act="back">&#9660;</button>
 <button class="touch-btn" data-act="right">&#9654;</button>
 <button class="touch-btn" data-act="up">&#11014;</button>
 <button class="touch-btn" data-act="down">&#11015;</button>
 <button class="touch-btn" data-act="solar">&#9788;</button>
 <button class="touch-btn" data-act="fast">&#9889;</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/renderers/CSS2DRenderer.js"></script>
<script>
// ============================================================
//  DATA
// ============================================================
const ECON=["Poor Agri","Avg Agri","Rich Agri","Poor Ind","Avg Ind","Rich Ind","Poor Common","Avg Common"];
const GOV=["Anarchy","Feudal","Multi-gov","Dictatorship","Confederacy","Democracy","Corporate","Satori","Communist"];
const PTYPES=["rocky","gas_giant","ice","jungle","desert","ocean","dead","artificial","ruins","fungal","insectoid","cyber","magic"];
const GOODS=[
 {id:0,name:"Food",base:13,unit:4},{id:1,name:"Textiles",base:27,unit:4},
 {id:2,name:"Radioactives",base:1600,unit:1},{id:3,name:"Slaves",base:180,unit:4,illegal:true},
 {id:4,name:"Liquor",base:55,unit:4},{id:5,name:"Luxuries",base:150,unit:1},
 {id:6,name:"Narcotics",base:1000,unit:1,illegal:true},{id:7,name:"Computers",base:500,unit:1},
 {id:8,name:"Machinery",base:400,unit:2},{id:9,name:"Alloys",base:170,unit:4},
 {id:10,name:"Firearms",base:290,unit:2,illegal:true},{id:11,name:"Furs",base:220,unit:2},
 {id:12,name:"Minerals",base:53,unit:4},{id:13,name:"Gold",base:660,unit:1},
 {id:14,name:"Platinum",base:550,unit:1},{id:15,name:"Gem-Stones",base:2500,unit:1},
 {id:16,name:"Alien Items",base:192,unit:1}
];
const EQUIPMENT=[
 {id:1,name:"Pulse Lasers",cost:4000,effect:"improved lasers"},
 {id:2,name:"Beam Lasers",cost:10000,effect:"beam lasers"},
 {id:3,name:"E.C.M.",cost:6000,effect:"missile defense"},
 {id:4,name:"Fuel Scoops",cost:5250,effect:"fuel scooping"},
 {id:5,name:"Escape Pod",cost:10000,effect:"survival"},
 {id:6,name:"Energy Bomb",cost:9000,effect:"energy bomb"},
 {id:7,name:"Energy Unit",cost:15000,effect:"regen"},
 {id:8,name:"Dock Computer",cost:10000,effect:"auto-dock"},
 {id:9,name:"Galactic Drive",cost:50000,effect:"intergalactic jump"},
 {id:10,name:"Bio Update",cost:20000,effect:"reduce psychosis"}
];
const NEWS=[
 {t:'AXIOM captured Delta-7',d:'Corporation AXIOM seized sector Delta-7. He-3 deposits will power the fleet for 200 years.',s:'Delta-7'},
 {t:'Miner Strike',d:'Independent Miners Alliance shut 40% of Barnard mines.',s:'Barnard'},
 {t:'[FACT] 2 trillion galaxies',d:'Conselice et al. (2016): ~2 trillion galaxies in the observable universe.',s:'Universe'},
 {t:'Diamond planet 55 Cancri e',d:'Mass 8.6 Earths, 40 ly. Diamond mantle suspected.',s:'55 Cancri'},
 {t:'[FACT] 5700+ exoplanets',d:'NASA confirmed 5700+ exoplanets. TRAPPIST-1: 7 Earth-sized.',s:'TRAPPIST-1'},
 {t:'Pirates at Wolf 359',d:'"Dark Claw" attacked a convoy. Wolf 359 is a red dwarf at 7.86 ly.',s:'Wolf 359'},
 {t:'[FACT] Milky Way',d:'Spiral galaxy ~100,000 ly diameter, 100-400 billion stars, ~1 trillion planets.',s:'Milky Way'},
 {t:'Kepler-442b: 18 deposits',d:'Scout "Hawk-14" mapped 18 rare-earth deposits.',s:'Kepler-442'},
 {t:'[FACT] Neutron stars',d:'Density 10^17 kg/m3. A teaspoon weighs ~6 billion tons. Diameter ~20 km.',s:'Pulsar'},
 {t:'Ocean under Europa-9 ice',d:'Rovers found a sub-ice ocean. Real Europa: up to 100 km of ice.',s:'Europa-9'},
];
const PLANETS_DATA=[
 {name:'Mercury',r:5,sz:.4,col:0x8c8c8c,spd:.04,desc:'4879 km, -173/+427C'},
 {name:'Venus',r:7,sz:.6,col:0xe6b800,spd:.015,desc:'12104 km, 92 atm, +462C'},
 {name:'Earth',r:9,sz:.65,col:0x2288ff,spd:.01,desc:'12742 km, 71% water'},
 {name:'Mars',r:11,sz:.5,col:0xff6600,spd:.008,desc:'6779 km, Olympus 21.9 km'},
 {name:'Jupiter',r:15,sz:1.4,col:0xd2b48c,spd:.002,desc:'139820 km, 318 Earth masses'},
 {name:'Saturn',r:19,sz:1.2,col:0xf0d58c,spd:.0009,ring:true,desc:'116460 km, rings 99.9% ice'},
 {name:'Uranus',r:23,sz:1,col:0x4fd0e7,spd:.0004,desc:'50724 km, axis tilt 98'},
 {name:'Neptune',r:27,sz:1,col:0x4169e1,spd:.0002,desc:'49244 km, winds 2100 km/h'}
];

// ============================================================
//  PLAYER
// ============================================================
const player={credits:10000,fuel:7,maxFuel:7,
 cargo:new Array(GOODS.length).fill(0),cargoMax:22,
 kills:0,rank:'Harmless',psychosis:0,morale:100,
 equipment:EQUIPMENT.map(e=>({...e,equipped:false})),
 slots:new Array(5).fill(null),currentSystem:null,docked:false,flights:0};

// ============================================================
//  THREE.JS GLOBALS
// ============================================================
let scene,camera,renderer,labelRenderer,controls;
let starsMesh,glowMesh,starData=[];
let clock=new THREE.Clock();
let solarGroup,planets=[],sunMesh,solarMode=true;
let massiveStars=[],tradeVisible=false,tradeCurves=[],tradeLines=[],dynPoints=null,dynData=[],shipLabels=[];
let speed=200;
let moveF=0,moveB=0,moveL=0,moveR=0,moveU=0,moveD=0;
let traveling=false,travelTo=null,travelFrom=null,travelT=0;
let routeActive=false,routeStart=null,routeEnd=null,routeCalcing=false,routeStopped=false;
let routeLines=[],routeBest=null,routeAll=[],selRings=[],nameLabels=[];
const MAX_PATHS=10;
let nasaData={apod:null,neo:[]};
let activeTab='info';

// ============================================================
//  UTILS
// ============================================================
function toast(msg,warn=false,ms=3000){
 const t=document.getElementById('toast');
 t.textContent=msg;t.style.borderColor=warn?'rgba(255,80,80,.3)':'rgba(240,160,48,.2)';
 t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),ms);
}
function starName(i){const s=starData[i];return s&&s.hip?'HIP '+s.hip:'Star '+i;}
function systemProps(star,i){
 let s=i*75+74;s=(s*75+74)%65536;const econ=Math.floor(s/8192)%8;
 s=(s*75+74)%65536;const gov=Math.floor(s/7281)%9;
 s=(s*75+74)%65536;const tech=Math.min(14,Math.floor(s/4681)+(econ<3?2:4));
 s=(s*75+74)%65536;const pt=PTYPES[Math.floor(s/5041)%PTYPES.length];
 const prices=GOODS.map(g=>{let p=g.base+(tech-7)*5;if(econ>=3&&econ<=5)p=Math.floor(p*.9);return Math.max(1,p);});
 return{economy:econ,econName:ECON[econ],govName:GOV[gov],tech,planetType:pt,prices};
}
function starColor(mag){
 const bf=Math.max(.15,1-(mag+5)/20);
 const hue=.15+bf*.45;
 return new THREE.Color().setHSL(hue,.7,bf*.85);
}

// ============================================================
//  SPRITE TEXTURES
// ============================================================
function makeSprite(soft=false){
 const c=document.createElement('canvas');c.width=64;c.height=64;
 const x=c.getContext('2d');
 const g=x.createRadialGradient(32,32,0,32,32,32);
 if(soft){
  g.addColorStop(0,'rgba(255,255,255,.6)');
  g.addColorStop(.3,'rgba(255,220,140,.3)');
  g.addColorStop(.6,'rgba(200,150,80,.1)');
  g.addColorStop(1,'rgba(255,255,255,0)');
 }else{
  g.addColorStop(0,'rgba(255,255,255,1)');
  g.addColorStop(.25,'rgba(255,240,200,.8)');
  g.addColorStop(.5,'rgba(255,200,100,.3)');
  g.addColorStop(1,'rgba(255,255,255,0)');
 }
 x.fillStyle=g;x.fillRect(0,0,64,64);
 return new THREE.CanvasTexture(c);
}

// ============================================================
//  NEBULA
// ============================================================
function addNebulae(){
 const configs=[
  {r:100,g:50,b:160,px:2000,py:500,pz:-1500,sz:4000},
  {r:30,g:80,b:140,px:-1500,py:-800,pz:2000,sz:3500},
  {r:160,g:70,b:30,px:500,py:1200,pz:3000,sz:5000},
 ];
 configs.forEach(cfg=>{
  const c=document.createElement('canvas');c.width=256;c.height=256;
  const ctx=c.getContext('2d');
  for(let i=0;i<300;i++){
   const x=Math.random()*256,y=Math.random()*256,rad=Math.random()*60+20;
   const gr=ctx.createRadialGradient(x,y,0,x,y,rad);
   const a=(Math.random()*.025).toFixed(4);
   gr.addColorStop(0,`rgba(${cfg.r},${cfg.g},${cfg.b},${a})`);
   gr.addColorStop(1,'transparent');
   ctx.fillStyle=gr;ctx.fillRect(0,0,256,256);
  }
  const tex=new THREE.CanvasTexture(c);
  const mat=new THREE.MeshBasicMaterial({map:tex,transparent:true,opacity:.5,
   side:THREE.DoubleSide,depthWrite:false,blending:THREE.AdditiveBlending});
  const mesh=new THREE.Mesh(new THREE.PlaneGeometry(cfg.sz,cfg.sz),mat);
  mesh.position.set(cfg.px,cfg.py,cfg.pz);
  mesh.rotation.set(Math.random(),Math.random(),0);
  scene.add(mesh);
 });
}

// ============================================================
//  BACKGROUND TEXTURE
// ============================================================
function makeBgTexture(){
 const c=document.createElement('canvas');c.width=1024;c.height=1024;
 const ctx=c.getContext('2d');
 const g=ctx.createRadialGradient(512,512,0,512,512,700);
 g.addColorStop(0,'#0c0818');g.addColorStop(.5,'#080612');g.addColorStop(1,'#040308');
 ctx.fillStyle=g;ctx.fillRect(0,0,1024,1024);
 for(let i=0;i<800;i++){
  const x=Math.random()*1024,y=Math.random()*1024;
  const s=Math.random()*1.5+.5;
  const a=Math.random()*.4+.1;
  ctx.fillStyle=`rgba(200,180,150,${a})`;
  ctx.fillRect(x,y,s,s);
 }
 return new THREE.CanvasTexture(c);
}

// ============================================================
//  STAR LOADING
// ============================================================
async function loadStars(){
 try{const r=await fetch('../stars.json');if(!r.ok)throw new Error(r.status);return await r.json();}
 catch(e){
  console.warn('stars.json not found, generating synthetic:',e.message);
  const out=[];
  for(let i=0;i<5000;i++){
   const r=5000*Math.cbrt(Math.random()),th=Math.random()*Math.PI*2,ph=Math.acos(2*Math.random()-1);
   out.push({x:r*Math.sin(ph)*Math.cos(th),y:r*Math.sin(ph)*Math.sin(th),z:r*Math.cos(ph),mag:Math.random()*10-2,hip:i+1});
  }
  return out;
 }
}

// ============================================================
//  SOLAR SYSTEM
// ============================================================
function createSolarSystem(){
 sunMesh=new THREE.Mesh(new THREE.SphereGeometry(2,32,32),
  new THREE.MeshBasicMaterial({color:0xffcc44}));
 scene.add(sunMesh);
 solarGroup=new THREE.Group();
 PLANETS_DATA.forEach(d=>{
  const pts=[];
  for(let i=0;i<=128;i++){const a=i/128*Math.PI*2;pts.push(new THREE.Vector3(d.r*Math.cos(a),0,d.r*Math.sin(a)));}
  solarGroup.add(new THREE.LineLoop(new THREE.BufferGeometry().setFromPoints(pts),
   new THREE.LineBasicMaterial({color:0xf0a030,opacity:.2,transparent:true})));
  const mesh=new THREE.Mesh(new THREE.SphereGeometry(d.sz,16,16),new THREE.MeshBasicMaterial({color:d.col}));
  mesh.userData={name:d.name,radius:d.r,speed:d.spd,angle:Math.random()*6.28,desc:d.desc};
  solarGroup.add(mesh);planets.push(mesh);
  if(d.ring){
   const rp=[];
   for(let i=0;i<=64;i++){const a=i/64*Math.PI*2;rp.push(new THREE.Vector3(d.sz*1.8*Math.cos(a),0,d.sz*1.8*Math.sin(a)));}
   mesh.add(new THREE.LineLoop(new THREE.BufferGeometry().setFromPoints(rp),new THREE.LineBasicMaterial({color:0xf0a030})));
  }
 });
 solarGroup.visible=false;scene.add(solarGroup);
}
function enterSolar(){solarMode=true;document.getElementById('act-solar').classList.add('active');
 solarGroup.visible=true;controls.target.set(0,0,0);speed=10;}
function exitSolar(){solarMode=false;document.getElementById('act-solar').classList.remove('active');solarGroup.visible=false;}

// ============================================================
//  MASSIVE STARS & TRADE ROUTES
// ============================================================
function highlightMassive(){
 if(!starData.length)return;
 massiveStars=[...starData].sort((a,b)=>(a.mag||0)-(b.mag||0)).slice(0,80);
}
function bezier(p1,p2,off=.3){
 const dir=new THREE.Vector3().subVectors(p2,p1),len=dir.length();
 const mid=new THREE.Vector3().addVectors(p1,p2).multiplyScalar(.5);
 const perp=new THREE.Vector3(-dir.y,dir.x,dir.z).normalize();
 if(perp.length()<.1)perp.set(0,0,1);
 perp.multiplyScalar(len*off*(Math.random()*.5+.5));
 return new THREE.CubicBezierCurve3(p1,
  new THREE.Vector3().lerpVectors(p1,mid,.3).add(perp),
  new THREE.Vector3().lerpVectors(p2,mid,.3).add(perp),p2);
}
function buildTradeRoutes(){
 tradeLines.forEach(l=>scene.remove(l));if(dynPoints)scene.remove(dynPoints);
 shipLabels.forEach(s=>scene.remove(s));
 tradeLines=[];tradeCurves=[];dynData=[];shipLabels=[];
 if(!massiveStars.length)return;
 const sun=new THREE.Vector3(0,0,0);
 massiveStars.forEach(s=>tradeCurves.push(bezier(sun,s.position,.4)));
 for(let i=0;i<massiveStars.length-1;i++)tradeCurves.push(bezier(massiveStars[i].position,massiveStars[i+1].position,.3));
 const COLS=[new THREE.Color(1,1,1),new THREE.Color(1,.9,.5),new THREE.Color(1,.5,.5),new THREE.Color(.5,.8,1)];
 tradeCurves.forEach(c=>{
  const col=COLS[Math.floor(Math.random()*COLS.length)];
  const pts=c.getPoints(50);
  const line=new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),
   new THREE.LineBasicMaterial({color:col,opacity:.2,transparent:true}));
  line.visible=tradeVisible;scene.add(line);tradeLines.push(line);
 });
 const N=600;const pos=new Float32Array(N*3),cols=new Float32Array(N*3);
 for(let i=0;i<N;i++){
  const ci=Math.floor(Math.random()*tradeCurves.length),t=Math.random();
  const col=COLS[Math.floor(Math.random()*COLS.length)];
  const p=tradeCurves[ci].getPoint(t);
  pos[i*3]=p.x;pos[i*3+1]=p.y;pos[i*3+2]=p.z;
  cols[i*3]=col.r;cols[i*3+1]=col.g;cols[i*3+2]=col.b;
  dynData.push({curve:tradeCurves[ci],t,speed:(.03+Math.random()*.05)*.001});
 }
 const geo=new THREE.BufferGeometry();
 geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
 geo.setAttribute('color',new THREE.BufferAttribute(cols,3));
 dynPoints=new THREE.Points(geo,new THREE.PointsMaterial({size:2,vertexColors:true,transparent:true,
  blending:THREE.AdditiveBlending,depthWrite:false,sizeAttenuation:true}));
 dynPoints.visible=tradeVisible;scene.add(dynPoints);
 massiveStars.forEach(star=>{
  const cnt=2+Math.floor(Math.random()*5);
  for(let j=0;j<cnt;j++){
   const off=new THREE.Vector3((Math.random()-.5)*80,(Math.random()-.5)*80,(Math.random()-.5)*80);
   const div=document.createElement('div');div.className='ship-tag';
   div.textContent='\u26F4 '+Math.floor(Math.random()*9000+1000);
   const lbl=new THREE.CSS2DObject(div);lbl.position.copy(star.position).add(off);
   lbl.visible=tradeVisible;scene.add(lbl);shipLabels.push(lbl);
  }
 });
}
function toggleTrade(){
 tradeVisible=!tradeVisible;
 document.getElementById('act-trade').classList.toggle('active',tradeVisible);
 tradeLines.forEach(l=>l.visible=tradeVisible);
 if(dynPoints)dynPoints.visible=tradeVisible;
 shipLabels.forEach(s=>s.visible=tradeVisible);
}

// ============================================================
//  TRAVEL
// ============================================================
function flyTo(pos,offset=50){
 if(traveling)return;
 const dir=new THREE.Vector3().subVectors(pos,camera.position).normalize();
 travelFrom=camera.position.clone();
 travelTo=offset>0?pos.clone().sub(dir.multiplyScalar(offset)):pos.clone();
 travelT=0;traveling=true;player.flights++;updateHUD();
}

// ============================================================
//  HUD
// ============================================================
function updateHUD(){
 document.getElementById('h-cr').textContent=player.credits;
 document.getElementById('h-fuel').textContent=player.fuel.toFixed(1);
 document.getElementById('h-cargo').textContent=player.cargo.reduce((a,b)=>a+b,0);
 document.getElementById('h-cmax').textContent=player.cargoMax;
 document.getElementById('h-rank').textContent=player.rank;
 if(player.currentSystem!==null&&starData[player.currentSystem]){
  const s=starData[player.currentSystem];
  document.getElementById('sys-display').textContent=s.hip?'HIP '+s.hip:'SYSTEM';
 }
}

// ============================================================
//  SAVE / LOAD
// ============================================================
function saveProgress(){
 const d={player:{credits:player.credits,fuel:player.fuel,cargo:player.cargo,rank:player.rank,
  psychosis:player.psychosis,morale:player.morale,flights:player.flights}};
 localStorage.setItem('elite_progress',JSON.stringify(d));toast('Progress saved!');
}
function loadProgress(){
 const raw=localStorage.getItem('elite_progress');
 if(!raw){toast('No saves found',true);return;}
 try{const d=JSON.parse(raw);if(d.player)Object.assign(player,d.player);updateHUD();toast('Loaded!');}
 catch(e){toast('Load error',true);}
}

// ============================================================
//  DRAWER CONTENT RENDERERS
// ============================================================
function renderInfo(idx){
 if(idx===null||!starData[idx])return'<p style="color:var(--pri-d)">No system selected. Double-click a star.</p>';
 const s=starData[idx];
 return`<div class="d-title">${starName(idx)}</div>
 <div class="d-grid">
  <div class="d-card"><div class="num">${s.econName||'—'}</div><div class="lab">ECONOMY</div></div>
  <div class="d-card"><div class="num">${s.govName||'—'}</div><div class="lab">GOVERNMENT</div></div>
  <div class="d-card"><div class="num">${s.tech||'—'}</div><div class="lab">TECH LEVEL</div></div>
  <div class="d-card"><div class="num">${s.planetType||'—'}</div><div class="lab">PLANET TYPE</div></div>
 </div>
 <div class="d-row"><span class="lab">Distance</span><span class="val">${s.distance_pc?(s.distance_pc*3.26).toFixed(1)+' ly':'—'}</span></div>
 <div class="d-row"><span class="lab">Magnitude</span><span class="val">${s.mag!==undefined?s.mag.toFixed(3):'—'}</span></div>
 <button class="d-btn d-btn-grn" onclick="openTrade(${idx})">DOCK &amp; TRADE</button>
 <button class="d-btn" onclick="openEquipTab()">EQUIPMENT</button>`;
}
function renderTrade(idx){
 if(!player.docked||idx===null)return'<p style="color:var(--pri-d)">Dock at a station first (select system &rarr; DOCK).</p>';
 const s=starData[idx];
 let h=`<div class="d-title">STATION: ${starName(idx)}</div>`;
 GOODS.forEach((g,i)=>{
  h+=`<div class="trade-row"><span>${g.name}</span><span style="color:var(--pri-b)">${s.prices[i]} Cr</span>
  <div class="trade-btns"><button onclick="buyG(${i},${s.prices[i]})">BUY</button>
  <button onclick="sellG(${i},${s.prices[i]})">SELL</button></div>
  <span style="color:var(--cyn);min-width:20px;text-align:right">[${player.cargo[i]}]</span></div>`;
 });
 return h;
}
function renderShip(){
 let h=`<div class="d-title">SHIP STATUS</div>
 <div class="d-grid">
  <div class="d-card"><div class="num">${player.credits}</div><div class="lab">CREDITS</div></div>
  <div class="d-card"><div class="num">${player.fuel.toFixed(1)}</div><div class="lab">FUEL</div></div>
  <div class="d-card"><div class="num">${player.cargo.reduce((a,b)=>a+b,0)}/${player.cargoMax}</div><div class="lab">CARGO</div></div>
  <div class="d-card"><div class="num">${player.flights}</div><div class="lab">FLIGHTS</div></div>
 </div><div class="d-title" style="margin-top:14px">EQUIPMENT SLOTS</div>`;
 for(let i=0;i<5;i++){
  const eq=player.slots[i]?player.equipment.find(e=>e.id===player.slots[i]):null;
  h+=`<div class="d-row"><span class="lab">Slot ${i+1}</span><span class="val">${eq?eq.name:'— empty —'}</span></div>`;
 }
 h+=`<div class="d-title" style="margin-top:14px">SHOP</div>`;
 player.equipment.forEach(eq=>{
  if(!eq.equipped)h+=`<div class="d-row"><span>${eq.name} (${eq.cost} Cr)</span>
  <span class="trade-btns"><button onclick="buyEquip(${eq.id})">BUY</button></span></div>`;
 });
 return h;
}
function renderRoute(){
 if(!routeAll.length)return'<p style="color:var(--pri-d)">No routes calculated. Use the route button.</p>';
 let h=`<div class="d-title">ROUTES FOUND: ${routeAll.length}</div>`;
 if(routeBest)h+=`<div class="d-row"><span class="lab">Best distance</span><span class="val">${routeBest.totalDist.toFixed(1)} units</span></div>
  <div class="d-row"><span class="lab">Stars</span><span class="val">${routeBest.path.length}</span></div>
  <div class="d-row"><span class="lab">Fuel needed</span><span class="val">${(routeBest.totalDist*3.26*.5).toFixed(1)} t</span></div>`;
 routeAll.forEach((r,i)=>{
  h+=`<div class="d-row" style="cursor:pointer" onclick="selectRoute(${i})">
  <span style="color:${r.color}">#${i+1}</span>
  <span class="val">${r.totalDist.toFixed(1)} u / ${r.path.length} stars</span></div>`;
 });
 return h;
}
function renderNasa(){
 let h='<div class="d-title">NASA ASTRONOMY PICTURE OF THE DAY</div>';
 if(nasaData.apod){
  if(nasaData.apod._fallback)h+='<div style="font-size:10px;color:var(--pri-d);margin-bottom:6px;letter-spacing:1px">ARCHIVE &bull; Live data cached daily</div>';
  if(nasaData.apod.media_type==='video'){
   h+=`<iframe src="${nasaData.apod.url}" style="width:100%;height:200px;border:1px solid rgba(240,160,48,.1);border-radius:4px;margin-bottom:8px" allowfullscreen></iframe>`;
  }else{
   const imgUrl=nasaData.apod.hdurl||nasaData.apod.url;
   h+=`<img class="nasa-img" src="${imgUrl}" alt="APOD" onerror="this.onerror=null;this.src='https://apod.nasa.gov/apod/image/2401/EagleNebula_Hubble_960.jpg'">`;
  }
  h+=`<div style="color:var(--pri-b);font-weight:bold;margin-bottom:4px">${nasaData.apod.title||''}</div>
  <div style="font-size:12px;color:var(--pri-d);margin-bottom:8px;line-height:1.5">${(nasaData.apod.explanation||'').slice(0,300)}...</div>
  <div style="font-size:11px;color:var(--pri-d)">${nasaData.apod.date||''}</div>`;
 }else{
  h+='<p style="color:var(--pri-d)">Loading APOD...</p>';
 }
 h+='<div class="d-title" style="margin-top:16px">NEAR-EARTH OBJECTS</div>';
 if(nasaData.neo.length){
  nasaData.neo.forEach(n=>{
   h+=`<div class="neo-item"><div class="neo-name">${n.name}</div>
   <div class="neo-info">\u2300 ${n.size} m &bull; ${n.speed} km/s &bull; miss: ${Number(n.miss).toLocaleString()} km</div></div>`;
  });
 }else{
  h+='<p style="color:var(--pri-d)">Loading NEO data...</p>';
 }
 return h;
}
function refreshDrawer(){
 const body=document.getElementById('drawer-body');
 switch(activeTab){
  case'info':body.innerHTML=renderInfo(player.currentSystem);break;
  case'trade':body.innerHTML=renderTrade(player.currentSystem);break;
  case'ship':body.innerHTML=renderShip();break;
  case'route':body.innerHTML=renderRoute();break;
  case'nasa':body.innerHTML=renderNasa();break;
 }
}
function openDrawer(tab){
 if(tab)setTab(tab);
 document.getElementById('drawer').classList.add('open');
 refreshDrawer();
}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');}
function setTab(tab){
 activeTab=tab;
 document.querySelectorAll('.dtab').forEach(b=>{b.classList.toggle('act',b.dataset.tab===tab);});
 refreshDrawer();
}

// ============================================================
//  TRADING
// ============================================================
function openTrade(idx){
 player.docked=true;player.currentSystem=idx;updateHUD();
 openDrawer('trade');
}
window.buyG=function(id,price){
 if(player.cargo.reduce((a,b)=>a+b,0)+GOODS[id].unit>player.cargoMax){toast('No space',true);return;}
 if(player.credits<price){toast('No credits',true);return;}
 player.credits-=price;player.cargo[id]++;updateHUD();refreshDrawer();
};
window.sellG=function(id,price){
 if(player.cargo[id]<=0)return;
 player.credits+=price;player.cargo[id]--;updateHUD();refreshDrawer();
};
window.buyEquip=function(id){
 const eq=player.equipment.find(e=>e.id===id);if(!eq)return;
 if(player.credits<eq.cost){toast('Not enough credits',true);return;}
 const slot=player.slots.indexOf(null);if(slot===-1){toast('No empty slots',true);return;}
 player.credits-=eq.cost;eq.equipped=true;player.slots[slot]=eq.id;
 updateHUD();refreshDrawer();toast(eq.name+' installed!');
};
window.openEquipTab=function(){openDrawer('ship');};
window.selectRoute=function(i){
 routeLines.forEach(l=>scene.remove(l));routeLines=[];
 const r=routeAll[i];
 for(let s=0;s<r.path.length-1;s++){
  const a=starData[r.path[s]].position,b=starData[r.path[s+1]].position;
  const line=new THREE.Line(new THREE.BufferGeometry().setFromPoints([a,b]),
   new THREE.LineBasicMaterial({color:new THREE.Color(r.color),transparent:true,opacity:1}));
  scene.add(line);routeLines.push(line);
 }
 toast('Route #'+(i+1)+' selected');
};

// ============================================================
//  NASA (cached per day + fallback gallery)
// ============================================================
const APOD_FALLBACK=[
 {title:'Pillars of Creation',explanation:'One of the most iconic images from the Hubble Space Telescope: the Pillars of Creation in the Eagle Nebula (M16), 6500 light-years away. Columns of interstellar gas and dust where new stars are forming.',url:'https://apod.nasa.gov/apod/image/2401/EagleNebula_Hubble_960.jpg',date:'Hubble Heritage'},
 {title:'Pale Blue Dot',explanation:'Voyager 1 looked back at Earth from 6 billion km away on Feb 14, 1990. Our planet appears as a tiny bright pixel in a sunbeam. Carl Sagan: "Look again at that dot. That\'s here. That\'s home. That\'s us."',url:'https://apod.nasa.gov/apod/image/2002/PaleBlueDotRevisited_Voyager1_960.jpg',date:'Voyager 1'},
 {title:'The Crab Nebula',explanation:'Messier 1 (the Crab Nebula) is the remnant of a supernova explosion recorded by Chinese astronomers in 1054 AD. At its center spins a neutron star 30 times per second.',url:'https://apod.nasa.gov/apod/image/2310/M1_HubbleSchmidt_960.jpg',date:'Hubble/Schmidt'},
 {title:'Saturn from Cassini',explanation:'The Cassini spacecraft orbited Saturn from 2004 to 2017. Its rings are 99.9% water ice, spanning 282,000 km but only 10 meters thick.',url:'https://apod.nasa.gov/apod/image/1609/SaturnAbove_Cassini_960.jpg',date:'Cassini'},
 {title:'Andromeda Galaxy',explanation:'M31 is the nearest large galaxy, 2.5 million light-years away, containing roughly a trillion stars. It is approaching the Milky Way at 110 km/s and will merge with us in ~4.5 billion years.',url:'https://apod.nasa.gov/apod/image/2309/M31_HubbleSubaru_960.jpg',date:'Hubble/Subaru'},
];
const NEO_FALLBACK=[
 {name:'(99942) Apophis',size:370,speed:31,miss:31000},
 {name:'(101955) Bennu',size:490,speed:28,miss:7500000},
 {name:'2024 YR4',size:60,speed:18,miss:420000},
 {name:'(4179) Toutatis',size:4500,speed:35,miss:7000000},
 {name:'(3200) Phaethon',size:5100,speed:36,miss:12000000},
];

function nasaCacheKey(){return'nasa_'+new Date().toISOString().split('T')[0];}

async function fetchNASA(){
 const ck=nasaCacheKey();
 const cached=localStorage.getItem(ck);
 if(cached){
  try{const d=JSON.parse(cached);nasaData.apod=d.apod;nasaData.neo=d.neo;
   if(activeTab==='nasa')refreshDrawer();return;}catch(e){}
 }
 let apodOk=false,neoOk=false;
 try{
  const r=await fetch('https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY');
  if(r.ok){nasaData.apod=await r.json();apodOk=true;}
 }catch(e){}
 if(!apodOk){
  nasaData.apod=APOD_FALLBACK[Math.floor(Math.random()*APOD_FALLBACK.length)];
  nasaData.apod._fallback=true;
 }
 if(activeTab==='nasa')refreshDrawer();
 try{
  const today=new Date().toISOString().split('T')[0];
  const r=await fetch('https://api.nasa.gov/neo/rest/v1/feed?start_date='+today+'&api_key=DEMO_KEY');
  if(r.ok){
   const d=await r.json();
   const objs=Object.values(d.near_earth_objects||{}).flat();
   nasaData.neo=objs.slice(0,10).map(o=>({
    name:o.name,
    size:Math.round((o.estimated_diameter?.meters?.estimated_diameter_max||0)),
    speed:Math.round(o.close_approach_data?.[0]?.relative_velocity?.kilometers_per_second||0),
    miss:Math.round(o.close_approach_data?.[0]?.miss_distance?.kilometers||0)
   }));neoOk=true;
  }
 }catch(e){}
 if(!neoOk)nasaData.neo=NEO_FALLBACK;
 if(apodOk||neoOk){
  try{localStorage.setItem(ck,JSON.stringify({apod:nasaData.apod,neo:nasaData.neo}));}catch(e){}
 }
 if(activeTab==='nasa')refreshDrawer();
}

// ============================================================
//  ROUTE CALCULATION
// ============================================================
function startRouteSelect(){
 routeActive=true;routeStart=null;routeEnd=null;
 document.getElementById('route-sel').classList.remove('hidden');
 document.getElementById('route-status').textContent='RMB on star = start point';
 document.getElementById('route-calc').disabled=true;
 document.getElementById('rp-start').textContent='START: \u2014';
 document.getElementById('rp-end').textContent='END: \u2014';
 clearSelRings();clearNameLabels();
}
function cancelRouteSelect(){
 routeActive=false;routeStart=null;routeEnd=null;
 document.getElementById('route-sel').classList.add('hidden');
 clearSelRings();clearNameLabels();
}
function clearSelRings(){selRings.forEach(r=>scene.remove(r));selRings=[];}
function clearNameLabels(){nameLabels.forEach(l=>scene.remove(l));nameLabels=[];}
function addSelRing(pos,col){
 const ring=new THREE.Mesh(new THREE.RingGeometry(25,30,64),
  new THREE.MeshBasicMaterial({color:col,side:THREE.DoubleSide,transparent:true,opacity:.6}));
 ring.position.copy(pos);scene.add(ring);selRings.push(ring);
}
function addNameLabel(pos,name){
 const div=document.createElement('div');div.className='star-label';div.textContent=name;
 const lbl=new THREE.CSS2DObject(div);lbl.position.copy(pos);lbl.position.y+=20;
 scene.add(lbl);nameLabels.push(lbl);
}
function startCalc(){
 if(routeStart===null||routeEnd===null)return;
 routeCalcing=true;routeStopped=false;routeAll=[];routeBest=null;
 document.getElementById('route-sel').classList.add('hidden');
 routeLines.forEach(l=>scene.remove(l));routeLines=[];clearNameLabels();
 calcNext(0);
}
function calcNext(idx){
 if(routeStopped||idx>=MAX_PATHS){
  routeCalcing=false;if(routeBest)finalizeRoutes();
  toast('Route calculation complete');openDrawer('route');return;
 }
 const path=findPath(routeStart,routeEnd,idx);
 const hue=(idx*360/MAX_PATHS)%360;path.color=`hsl(${hue},70%,50%)`;
 routeAll.push(path);
 let seg=0;
 function drawSeg(){
  if(seg>=path.path.length-1){
   if(!routeBest||path.totalDist<routeBest.totalDist)routeBest=path;
   setTimeout(()=>calcNext(idx+1),30);return;
  }
  const a=starData[path.path[seg]].position,b=starData[path.path[seg+1]].position;
  const line=new THREE.Line(new THREE.BufferGeometry().setFromPoints([a,b]),
   new THREE.LineBasicMaterial({color:new THREE.Color(path.color),transparent:true,opacity:.4}));
  scene.add(line);routeLines.push(line);seg++;setTimeout(drawSeg,15);
 }
 drawSeg();
}
function findPath(si,ei,v){
 const path=[si];let cur=si;const visited=new Set([si]);let dist=0;
 const ep=starData[ei].position;const dd=starData[si].position.distanceTo(ep);
 for(let step=0;step<50&&cur!==ei;step++){
  const cp=starData[cur].position;let best=null,bestW=Infinity;const cands=[];
  for(let i=0;i<starData.length;i++){
   if(visited.has(i))continue;
   const d=cp.distanceTo(starData[i].position);
   const te=starData[i].position.distanceTo(ep);
   const w=d*(.5+te/dd*.5)*(1+(Math.random()-.5)*.2*v);
   cands.push({idx:i,w,d});
  }
  cands.sort((a,b)=>a.w-b.w);
  const pick=cands[Math.min(Math.floor(Math.random()*5),cands.length-1)];
  if(!pick)break;path.push(pick.idx);dist+=pick.d;visited.add(pick.idx);cur=pick.idx;
 }
 if(cur!==ei){dist+=starData[cur].position.distanceTo(ep);path.push(ei);}
 return{path,totalDist:dist,variation:v};
}
function finalizeRoutes(){
 routeLines.forEach(l=>{l.material.opacity=.15;});
 if(routeBest){
  addNameLabel(starData[routeBest.path[0]].position,starName(routeBest.path[0]));
  addNameLabel(starData[routeBest.path[routeBest.path.length-1]].position,starName(routeBest.path[routeBest.path.length-1]));
 }
}

// ============================================================
//  STAR PICKING
// ============================================================
function pickStar(ex,ey,threshold=30){
 let best=Infinity,bestI=-1;
 for(let i=0;i<starData.length;i++){
  const v=starData[i].position.clone().project(camera);
  if(v.z>1)continue;
  const sx=(v.x*.5+.5)*window.innerWidth,sy=(-v.y*.5+.5)*window.innerHeight;
  const d=Math.hypot(sx-ex,sy-ey);
  if(d<threshold&&d<best){best=d;bestI=i;}
 }
 return bestI;
}
function onDblClick(e){
 if(player.docked||routeActive)return;
 const idx=pickStar(e.clientX,e.clientY);
 if(idx!==-1){
  flyTo(starData[idx].position,50);
  player.currentSystem=idx;updateHUD();
  openDrawer('info');
  if(window.hubMsg)window.hubMsg({type:'location_update',system:starName(idx)});
 }
}
function onRightClick(e){
 if(!routeActive||e.target.closest('#drawer,.act-btn,#route-sel'))return;
 e.preventDefault();
 const idx=pickStar(e.clientX,e.clientY);if(idx===-1)return;
 if(routeStart===null){
  routeStart=idx;document.getElementById('rp-start').textContent='START: '+starName(idx);
  document.getElementById('route-status').textContent='RMB on star = end point';
  addSelRing(starData[idx].position,0x40ff80);
 }else if(routeEnd===null){
  routeEnd=idx;document.getElementById('rp-end').textContent='END: '+starName(idx);
  document.getElementById('route-status').textContent='Ready!';
  document.getElementById('route-calc').disabled=false;
  addSelRing(starData[idx].position,0x40a0ff);
 }
}

// ============================================================
//  HOVER
// ============================================================
let hoverTimer=null;
document.addEventListener('mousemove',e=>{
 if(hoverTimer)clearTimeout(hoverTimer);
 document.getElementById('hover').classList.remove('show');
 hoverTimer=setTimeout(()=>{
  if(!starData.length||!camera)return;
  const idx=pickStar(e.clientX,e.clientY,25);if(idx===-1)return;
  const s=starData[idx];
  document.getElementById('hv-name').textContent=starName(idx);
  let b=`<div class="d-row"><span class="lab">Economy</span><span class="val">${s.econName||'?'}</span></div>`;
  b+=`<div class="d-row"><span class="lab">Tech</span><span class="val">${s.tech||'?'}</span></div>`;
  if(s.distance_pc)b+=`<div class="d-row"><span class="lab">Dist</span><span class="val">${(s.distance_pc*3.26).toFixed(1)} ly</span></div>`;
  document.getElementById('hv-body').innerHTML=b;
  const hv=document.getElementById('hover');
  hv.style.left=Math.min(e.clientX+15,window.innerWidth-290)+'px';
  hv.style.top=Math.max(e.clientY-80,10)+'px';
  hv.classList.add('show');
 },300);
});

// ============================================================
//  SEARCH
// ============================================================
function toggleSearch(){
 const s=document.getElementById('search');
 s.classList.toggle('hidden');
 if(!s.classList.contains('hidden')){
  const inp=document.getElementById('search-input');inp.value='';inp.focus();
  document.getElementById('search-results').innerHTML='';
 }
}
document.getElementById('search-input').addEventListener('input',e=>{
 const q=e.target.value.trim().toLowerCase();
 const box=document.getElementById('search-results');
 if(!q){box.innerHTML='';return;}
 const hits=[];
 for(let i=0;i<starData.length&&hits.length<20;i++){
  if(starName(i).toLowerCase().includes(q))hits.push(i);
 }
 box.innerHTML=hits.map(idx=>{
  const s=starData[idx];
  return`<div class="sr-item" onclick="searchGo(${idx})"><div class="sr-name">${starName(idx)}</div>
  <div class="sr-sub">${s.econName} | Tech ${s.tech} | ${s.planetType}</div></div>`;
 }).join('');
});
window.searchGo=function(idx){
 toggleSearch();flyTo(starData[idx].position,50);
 player.currentSystem=idx;updateHUD();openDrawer('info');
};

// ============================================================
//  KEYBOARD
// ============================================================
document.addEventListener('keydown',e=>{
 if(e.target.tagName==='INPUT')return;
 if(e.key==='/'){e.preventDefault();toggleSearch();return;}
 if(e.key==='Escape'){
  if(!document.getElementById('search').classList.contains('hidden'))toggleSearch();
  else closeDrawer();return;
 }
 if(solarMode){
  if(e.code==='KeyW'){camera.position.lerp(controls.target,.05);e.preventDefault();}
  if(e.code==='KeyS'){camera.position.sub(new THREE.Vector3().subVectors(controls.target,camera.position).multiplyScalar(.05));e.preventDefault();}
  return;
 }
 switch(e.code){
  case'KeyW':moveF=1;e.preventDefault();break;case'KeyS':moveB=1;e.preventDefault();break;
  case'KeyA':moveL=1;e.preventDefault();break;case'KeyD':moveR=1;e.preventDefault();break;
  case'KeyQ':moveU=1;e.preventDefault();break;case'KeyE':moveD=1;e.preventDefault();break;
  case'ShiftLeft':speed*=3;e.preventDefault();break;
 }
});
document.addEventListener('keyup',e=>{
 if(solarMode)return;
 switch(e.code){
  case'KeyW':moveF=0;break;case'KeyS':moveB=0;break;
  case'KeyA':moveL=0;break;case'KeyD':moveR=0;break;
  case'KeyQ':moveU=0;break;case'KeyE':moveD=0;break;
  case'ShiftLeft':speed/=3;break;
 }
});

// ============================================================
//  ANIMATION
// ============================================================
function animate(){
 requestAnimationFrame(animate);
 const dt=Math.min(clock.getDelta(),.1);
 if(traveling&&travelTo&&travelFrom){
  travelT+=dt;let t=travelT;t=t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
  const cur=new THREE.Vector3().lerpVectors(travelFrom,travelTo,t);
  controls.target.copy(cur);camera.position.copy(cur.clone().add(new THREE.Vector3(0,30,60)));
  if(travelT>=1)traveling=false;
 }else if(solarMode){controls.target.set(0,0,0);}
 else{
  const fwd=new THREE.Vector3();camera.getWorldDirection(fwd);
  const right=new THREE.Vector3().crossVectors(fwd,camera.up).normalize();
  const mv=new THREE.Vector3();
  if(moveF)mv.addScaledVector(fwd,speed*dt);if(moveB)mv.addScaledVector(fwd,-speed*dt);
  if(moveR)mv.addScaledVector(right,speed*dt);if(moveL)mv.addScaledVector(right,-speed*dt);
  if(moveU)mv.y+=speed*dt;if(moveD)mv.y-=speed*dt;
  camera.position.add(mv);controls.target.add(mv);
 }
 controls.update();
 if(tradeVisible&&dynPoints){
  const arr=dynPoints.geometry.attributes.position.array;
  for(let i=0;i<dynData.length;i++){
   dynData[i].t+=dynData[i].speed*dt;if(dynData[i].t>1)dynData[i].t=0;
   const p=dynData[i].curve.getPoint(dynData[i].t);
   arr[i*3]=p.x;arr[i*3+1]=p.y;arr[i*3+2]=p.z;
  }
  dynPoints.geometry.attributes.position.needsUpdate=true;
  const cp=camera.position;
  shipLabels.forEach(s=>{const dx=s.position.x-cp.x,dy=s.position.y-cp.y,dz=s.position.z-cp.z;
   s.visible=tradeVisible&&(dx*dx+dy*dy+dz*dz<640000);});
 }
 if(solarGroup&&solarGroup.visible){
  planets.forEach(p=>{p.userData.angle+=p.userData.speed*dt;
   p.position.x=Math.cos(p.userData.angle)*p.userData.radius;
   p.position.z=Math.sin(p.userData.angle)*p.userData.radius;});
 }
 selRings.forEach(r=>r.quaternion.copy(camera.quaternion));
 renderer.render(scene,camera);
 labelRenderer.render(scene,camera);
}

// ============================================================
//  INIT
// ============================================================
async function init(){
 scene=new THREE.Scene();
 scene.background=makeBgTexture();
 camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e7);
 camera.position.set(0,500,2000);
 renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:'high-performance'});
 renderer.setSize(window.innerWidth,window.innerHeight);
 renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
 document.body.appendChild(renderer.domElement);
 labelRenderer=new THREE.CSS2DRenderer();
 labelRenderer.setSize(window.innerWidth,window.innerHeight);
 labelRenderer.domElement.style.cssText='position:absolute;top:0;left:0;pointer-events:none;z-index:500';
 document.body.appendChild(labelRenderer.domElement);

 const raw=await loadStars();
 document.getElementById('star-count').textContent=raw.length+' STARS';
 starData=raw.map((s,i)=>{
  const pos=new THREE.Vector3(s.x,s.y,s.z);
  const col=starColor(s.mag);
  const sz=Math.max(.5,2.5-(s.mag+5)/5);
  const props=systemProps(s,i);
  return{...s,position:pos,color:col,size:sz,...props};
 });

 // GLOW LAYER (large soft sprites)
 const gPos=new Float32Array(starData.length*3);
 const gCol=new Float32Array(starData.length*3);
 const gSiz=new Float32Array(starData.length);
 starData.forEach((s,i)=>{
  gPos[i*3]=s.x;gPos[i*3+1]=s.y;gPos[i*3+2]=s.z;
  gCol[i*3]=s.color.r*.6;gCol[i*3+1]=s.color.g*.6;gCol[i*3+2]=s.color.b*.6;
  gSiz[i]=s.size*3;
 });
 const gGeo=new THREE.BufferGeometry();
 gGeo.setAttribute('position',new THREE.BufferAttribute(gPos,3));
 gGeo.setAttribute('color',new THREE.BufferAttribute(gCol,3));
 glowMesh=new THREE.Points(gGeo,new THREE.PointsMaterial({
  size:30,vertexColors:true,map:makeSprite(true),transparent:true,
  blending:THREE.AdditiveBlending,depthWrite:false,sizeAttenuation:true,opacity:.4
 }));
 scene.add(glowMesh);

 // CORE LAYER (sharp bright sprites)
 const cPos=new Float32Array(starData.length*3);
 const cCol=new Float32Array(starData.length*3);
 starData.forEach((s,i)=>{
  cPos[i*3]=s.x;cPos[i*3+1]=s.y;cPos[i*3+2]=s.z;
  cCol[i*3]=s.color.r;cCol[i*3+1]=s.color.g;cCol[i*3+2]=s.color.b;
 });
 const cGeo=new THREE.BufferGeometry();
 cGeo.setAttribute('position',new THREE.BufferAttribute(cPos,3));
 cGeo.setAttribute('color',new THREE.BufferAttribute(cCol,3));
 starsMesh=new THREE.Points(cGeo,new THREE.PointsMaterial({
  size:12,vertexColors:true,map:makeSprite(false),transparent:true,
  blending:THREE.AdditiveBlending,depthWrite:false,sizeAttenuation:true
 }));
 scene.add(starsMesh);

 addNebulae();
 createSolarSystem();
 highlightMassive();

 controls=new THREE.OrbitControls(camera,renderer.domElement);
 controls.enableDamping=true;controls.dampingFactor=.08;
 controls.screenSpacePanning=true;controls.minDistance=5;controls.maxDistance=50000;
 controls.zoomSpeed=2;controls.rotateSpeed=.6;

 renderer.domElement.addEventListener('dblclick',onDblClick);
 renderer.domElement.addEventListener('contextmenu',onRightClick);
 renderer.domElement.addEventListener('click',e=>{
  if(!solarGroup||!solarGroup.visible)return;
  const mouse=new THREE.Vector2((e.clientX/window.innerWidth)*2-1,-(e.clientY/window.innerHeight)*2+1);
  const rc=new THREE.Raycaster();rc.setFromCamera(mouse,camera);
  const hits=rc.intersectObjects(planets);
  if(hits.length){
   const pl=hits[0].object;
   toast(pl.userData.name+': '+pl.userData.desc,false,5000);
   controls.target.copy(pl.position);
  }
 });

 // UI bindings
 document.getElementById('act-solar').onclick=()=>{solarMode?exitSolar():enterSolar();};
 document.getElementById('act-trade').onclick=()=>{if(solarMode)exitSolar();toggleTrade();};
 document.getElementById('act-route').onclick=()=>{if(solarMode)exitSolar();startRouteSelect();};
 document.getElementById('act-panel').onclick=()=>{
  document.getElementById('drawer').classList.contains('open')?closeDrawer():openDrawer();};
 document.getElementById('act-search').onclick=toggleSearch;
 document.getElementById('act-nasa').onclick=()=>{openDrawer('nasa');if(!nasaData.apod&&!nasaData.apodError)fetchNASA();};
 document.getElementById('act-save').onclick=()=>{saveProgress();};
 document.getElementById('drawer-close').onclick=closeDrawer;
 document.querySelectorAll('.dtab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
 document.getElementById('route-calc').onclick=startCalc;
 document.getElementById('route-cancel').onclick=cancelRouteSelect;
 document.getElementById('help').onclick=function(){this.style.display='none';};
 document.getElementById('search').addEventListener('click',e=>{if(e.target.id==='search')toggleSearch();});

 buildTradeRoutes();
 camera.position.set(100,80,100);controls.target.set(0,0,0);controls.update();
 updateHUD();fetchNASA();animate();

 // Mobile
 if('ontouchstart' in window||navigator.maxTouchPoints>0){
  document.getElementById('mob-toggle').addEventListener('click',()=>{
   const mc=document.getElementById('mob-controls');
   mc.style.display=mc.style.display==='flex'?'none':'flex';
  });
  const acts={fwd:'moveF',back:'moveB',left:'moveL',right:'moveR',up:'moveU',down:'moveD'};
  document.querySelectorAll('.touch-btn').forEach(btn=>{
   const act=btn.dataset.act;
   if(acts[act]){
    btn.addEventListener('touchstart',e=>{e.preventDefault();
     switch(act){case'fwd':moveF=1;break;case'back':moveB=1;break;case'left':moveL=1;break;
      case'right':moveR=1;break;case'up':moveU=1;break;case'down':moveD=1;break;}},{passive:false});
    btn.addEventListener('touchend',e=>{e.preventDefault();
     switch(act){case'fwd':moveF=0;break;case'back':moveB=0;break;case'left':moveL=0;break;
      case'right':moveR=0;break;case'up':moveU=0;break;case'down':moveD=0;break;}},{passive:false});
   }
   if(act==='solar')btn.addEventListener('click',()=>{solarMode?exitSolar():enterSolar();});
   if(act==='fast'){
    btn.addEventListener('touchstart',e=>{e.preventDefault();speed*=3;},{passive:false});
    btn.addEventListener('touchend',e=>{e.preventDefault();speed/=3;},{passive:false});
   }
  });
  let lastTap=0;
  document.addEventListener('touchend',e=>{
   const now=Date.now();
   if(now-lastTap<300){
    const touch=e.changedTouches[0];
    if(touch&&!e.target.closest('#drawer,.act-btn,.touch-btn,#mob-toggle,#mob-controls,#search,#route-sel')){
     const idx=pickStar(touch.clientX,touch.clientY,40);
     if(idx!==-1){flyTo(starData[idx].position,50);player.currentSystem=idx;updateHUD();openDrawer('info');}
    }
   }
   lastTap=now;
  });
 }
}

window.addEventListener('resize',()=>{
 camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();
 renderer.setSize(window.innerWidth,window.innerHeight);
 labelRenderer.setSize(window.innerWidth,window.innerHeight);
});

init().catch(console.error);
</script>
<script>
window._gs=null;
window.addEventListener('message',e=>{if(e.data&&e.data.type==='game_state')window._gs=e.data.state;});
if(window.parent!==window)window.parent.postMessage({type:'get_state'},'*');
window.hubMsg=function(msg){if(window.parent!==window)window.parent.postMessage(msg,'*');};
</script>
</body>
</html>