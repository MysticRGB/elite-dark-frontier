<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Elite: Dark Frontier â€” ĞšĞ°Ñ€Ñ‚Ğ° Ğ½ĞµĞ±Ğ°</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
:root {
  --amber: #ffaa00; --gold: #ffdd99; --dim: #664422;
  --panel-bg: rgba(0,0,0,0.85); --panel-border: 2px solid var(--amber);
  --glow: 0 0 10px #cc8800, inset 0 0 5px #442200;
  --font-title: 'Press Start 2P', cursive;
  --font-body: 'VT323', monospace;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { overflow:hidden; font-family:var(--font-body); background:#050510; color:var(--gold); }
canvas { display:block; }

/* CRT overlay */
#crt { position:fixed; inset:0; pointer-events:none; z-index:9999;
  background:repeating-linear-gradient(0deg,rgba(255,200,100,.03) 0px,rgba(0,0,0,.15) 2px,transparent 3px);
  mix-blend-mode:multiply; }

/* Panels base */
.panel { position:absolute; padding:12px 16px; border:var(--panel-border);
  box-shadow:var(--glow); background:var(--panel-bg); backdrop-filter:blur(3px);
  font-size:14px; z-index:2000; }
.panel h3, .panel h4 { font-family:var(--font-title); font-size:11px; color:#ffff88; margin-bottom:8px; }
.panel .lbl { color:#cc8800; } .panel .val { color:#ffff88; font-weight:bold; }

/* Buttons */
.btn { background:var(--dim); border:1px solid var(--amber); color:var(--gold);
  padding:6px 10px; cursor:pointer; font-family:var(--font-title); font-size:8px;
  text-transform:uppercase; transition:all .15s; }
.btn:hover { background:#aa6633; box-shadow:0 0 10px #ff8800; }
.btn.active { background:#aa6633; box-shadow:0 0 10px #ff8800; }
.btn:disabled { opacity:.4; cursor:not-allowed; }
.btn-full { width:100%; }
.btn-green { background:#3a6a3a; border-color:#55aa55; color:#fff; }
.btn-red { background:#6a3a3a; border-color:#aa5555; color:#ffaaaa; }

/* Info panel (top-left) */
#info { top:16px; left:16px; min-width:220px; }
#info h2 { font-family:var(--font-title); font-size:12px; color:#ffff88; margin-bottom:6px; }

/* Controls panel (top-right) */
#controls { top:16px; right:16px; width:260px; max-height:90vh; overflow-y:auto; }
#controls label { display:block; margin:8px 0 2px; font-size:13px; color:#cc8800; }
#controls input[type=range] { width:100%; accent-color:var(--amber); }

/* HUD (bottom) */
#hud { position:absolute; bottom:20px; left:16px; right:16px; display:flex; gap:10px; z-index:2000; pointer-events:none; }
.hud-block { flex:1; padding:10px 14px; border:var(--panel-border); box-shadow:var(--glow);
  background:var(--panel-bg); backdrop-filter:blur(3px);
  font-family:var(--font-title); font-size:9px; line-height:1.8; text-transform:uppercase; }

/* Hover tooltip */
#hover-info { position:absolute; background:#000; color:var(--gold); padding:10px;
  border:2px solid var(--amber); font-size:13px; pointer-events:none; max-width:300px;
  transform:translate(-50%,-110%); z-index:3000; display:none; }

/* Travel message */
#travel-msg { position:absolute; bottom:160px; left:16px; background:#000; color:var(--amber);
  padding:8px 16px; border:1px solid var(--amber); font-size:14px; pointer-events:none;
  opacity:0; transition:opacity .3s; z-index:2000; }

/* Quick travel */
#quicktravel { bottom:220px; left:16px; max-width:300px; }
.wp-btn { background:var(--dim); border:1px solid var(--amber); color:var(--gold);
  padding:4px 8px; margin:2px; font-size:11px; cursor:pointer; }
.wp-btn:hover { background:#aa6633; }
.wp-btn.locked { border-color:#ff6600; background:#553311; }

/* Modal panels (trade, equip, missions) */
.modal-panel { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  background:#000; border:4px solid var(--amber); padding:20px; color:var(--gold);
  width:680px; max-height:80vh; overflow-y:auto; display:none; z-index:3000; font-size:15px; }
.modal-panel h3 { font-family:var(--font-title); font-size:13px; color:#ffff88; margin-bottom:12px; }
.close-modal { width:100%; margin-top:12px; }

/* Route panel */
#route-panel { top:100px; left:16px; width:420px; max-height:75vh; overflow-y:auto; display:none; }
.route-progress { width:100%; height:12px; background:#222; border:1px solid var(--amber); margin:6px 0; }
.route-fill { height:100%; background:linear-gradient(90deg,var(--amber),#ffff88); width:0%; transition:width .3s; }
.route-stats { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin:8px 0; }
.route-stat { text-align:center; padding:5px; background:rgba(255,170,0,.05); border:1px solid #442200; }
.route-stat .lbl { font-size:9px; } .route-stat .val { font-size:13px; }
.route-item { display:flex; align-items:center; gap:8px; padding:6px; margin:4px 0;
  border:1px solid #442200; cursor:pointer; font-size:12px; background:rgba(255,170,0,.03); }
.route-item:hover { background:rgba(255,170,0,.12); }
.route-dot { width:10px; height:10px; border-radius:50%; border:1px solid #fff; flex-shrink:0; }

/* Star selection */
#star-select { top:16px; left:50%; transform:translateX(-50%); text-align:center; display:none; }
.sel-pt { display:inline-block; padding:3px 10px; margin:0 4px; border:1px solid var(--amber); font-size:11px; }
.sel-pt.start { background:rgba(100,150,50,.3); border-color:#88cc44; }
.sel-pt.end { background:rgba(50,100,150,.3); border-color:#4488cc; }

/* Fuel panel */
#fuel-panel { top:420px; left:16px; width:320px; border-color:#00ff88; color:#00ff88; display:none; }
#fuel-panel h4 { color:#00ff88; } #fuel-panel .lbl { color:#88cc66; } #fuel-panel .val { color:#00ff88; }
.fuel-row { display:flex; justify-content:space-between; margin:3px 0; }

/* News */
#news-widget { position:absolute; bottom:20px; right:300px; width:280px; z-index:2000; }
#news-widget h4 { cursor:pointer; }
.news-tick { max-height:110px; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--amber) #111; }
.news-item-sm { border-bottom:1px dashed #553311; padding:3px 0; font-size:12px; color:#cc8800; cursor:pointer; }
#news-modal { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:750px; max-height:80vh; overflow-y:auto; padding:20px; display:none;
  background:rgba(0,0,0,.96); border:4px solid var(--amber); z-index:4000; }

/* Star name labels */
.star-label { font-family:var(--font-body); font-size:12px; color:#00ff88;
  text-shadow:0 0 8px #00ff88; background:rgba(0,40,20,.7); border:1px solid #00ff88;
  padding:2px 6px; white-space:nowrap; pointer-events:none; }

/* Static ships */
.ship-tag { font-family:var(--font-body); font-size:12px; color:#ffffaa;
  text-shadow:0 0 5px #ff8800; background:rgba(30,15,0,.8); border:1px solid var(--amber);
  padding:1px 5px; white-space:nowrap; pointer-events:none; }

/* Help overlay */
#help { position:fixed; inset:0; background:rgba(0,0,0,.88); z-index:50000;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; gap:16px; }
#help .title { font-family:var(--font-title); font-size:18px; color:#ffff88; text-shadow:0 0 20px var(--amber); }
#help .body { color:var(--gold); font-size:20px; max-width:560px; text-align:center; line-height:1.6; }
#help .key { color:#88ff88; }
#help .hint { color:#886622; font-size:16px; animation:blink 1.2s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

/* Context menu */
#ctx-menu { position:absolute; background:#000; border:2px solid var(--amber); padding:4px;
  display:none; min-width:140px; z-index:5000; }
#ctx-menu button { display:block; width:100%; background:var(--dim); border:1px solid var(--amber);
  color:var(--gold); padding:5px 8px; margin:2px 0; cursor:pointer; font-size:12px; text-align:left; }
#ctx-menu button:hover { background:#aa6633; }

/* Mobile touch button */
#mobile-controls { display:none; position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  z-index:3000; gap:6px; flex-wrap:wrap; justify-content:center; }
.touch-btn { width:48px; height:48px; background:rgba(255,170,0,.15); border:2px solid var(--amber);
  color:var(--gold); font-size:18px; display:flex; align-items:center; justify-content:center;
  border-radius:8px; -webkit-tap-highlight-color:transparent; touch-action:manipulation;
  user-select:none; }
.touch-btn:active { background:rgba(255,170,0,.4); }
#mobile-toggle { display:none; position:absolute; top:10px; right:10px; z-index:3001;
  background:rgba(0,0,0,.8); border:2px solid var(--amber); color:var(--gold);
  padding:6px 10px; font-size:20px; border-radius:6px; cursor:pointer; }

/* â•â•â• MOBILE / iPHONE â•â•â• */
@media (max-width: 768px) {
  #info { top:8px; left:8px; padding:8px 10px; font-size:12px; max-width:55%; }
  #info h2 { font-size:9px; }

  #controls { display:none; top:8px; right:8px; width:200px; padding:8px; font-size:11px; }
  #controls.mob-open { display:block; }
  #controls h3 { font-size:8px; }
  #controls .btn { padding:4px 6px; font-size:7px; margin:2px 1px; }
  #controls label { font-size:11px; margin:4px 0 1px; }

  #hud { bottom:70px; left:8px; right:8px; gap:4px; }
  .hud-block { padding:6px 8px; font-size:7px; line-height:1.5; }

  #quicktravel { display:none; }
  #news-widget { display:none; }
  #hover-info { display:none !important; }

  .modal-panel { width:95vw; max-height:70vh; padding:12px; font-size:13px; }
  .modal-panel h3 { font-size:10px; }

  #route-panel { top:60px; left:6px; width:calc(100vw - 12px); max-height:60vh; padding:8px; }
  #star-select { top:60px; width:90vw; left:5vw; transform:none; padding:10px; }
  #fuel-panel { top:auto; bottom:80px; left:6px; width:calc(100vw - 12px); }

  #help .title { font-size:13px; }
  #help .body { font-size:15px; max-width:90vw; }
  #help .hint { font-size:14px; }

  #mobile-controls { display:flex; }
  #mobile-toggle { display:block; }

  .star-label { font-size:10px; padding:1px 4px; }
  .ship-tag { font-size:10px; }
}

@media (max-width: 480px) {
  #info { max-width:60%; }
  #info h2 { font-size:8px; }
  .hud-block { font-size:6px; padding:4px 6px; }
  #hud { bottom:65px; }
  .touch-btn { width:42px; height:42px; font-size:16px; }
}

@supports (padding-bottom: env(safe-area-inset-bottom)) {
  #mobile-controls { padding-bottom: env(safe-area-inset-bottom); }
  #hud { bottom: calc(70px + env(safe-area-inset-bottom)); }
}
</style>
</head>
<body>
<div id="crt"></div>

<!-- HELP OVERLAY -->
<div id="help">
  <div class="title">ĞšĞĞ Ğ¢Ğ Ğ—Ğ’ĞĞ—Ğ”ĞĞĞ“Ğ ĞĞ•Ğ‘Ğ</div>
  <div class="body">
    <div style="color:#88ccff;font-size:15px;margin-bottom:10px;">ĞšĞ°Ğ¶Ğ´Ğ°Ñ Ğ·Ğ²ĞµĞ·Ğ´Ğ° â€” Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ· ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ° HIP (Hipparcos).<br>Ğ’Ğ¾ Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ¾Ğ¹ ~2Ã—10Â²Â³ Ğ·Ğ²Ñ‘Ğ·Ğ´. Ğ—Ğ´ĞµÑÑŒ 5000 Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ñ….</div>
    <div><span class="key">Ğ›ĞšĞœ + Ñ‚ÑĞ½ÑƒÑ‚ÑŒ</span> â€” Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ</div>
    <div><span class="key">ĞŸĞšĞœ + Ñ‚ÑĞ½ÑƒÑ‚ÑŒ</span> â€” Ğ¿Ğ°Ğ½Ğ¾Ñ€Ğ°Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</div>
    <div><span class="key">ĞšĞ¾Ğ»ĞµÑĞ¾</span> â€” Ğ·ÑƒĞ¼</div>
    <div><span class="key">WASD / Q / E</span> â€” Ğ¿Ğ¾Ğ»Ñ‘Ñ‚</div>
    <div><span class="key">Shift</span> â€” ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ Ã—3</div>
    <div><span class="key">Ğ”Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ¹ ĞºĞ»Ğ¸Ğº</span> â€” Ğ¿ĞµÑ€ĞµĞ»Ñ‘Ñ‚ Ğº Ğ·Ğ²ĞµĞ·Ğ´Ğµ</div>
  </div>
  <div class="hint">[ ĞšĞ›Ğ˜ĞšĞĞ˜Ğ¢Ğ• Ğ§Ğ¢ĞĞ‘Ğ« ĞĞĞ§ĞĞ¢Ğ¬ ]</div>
</div>

<!-- INFO -->
<div id="info" class="panel">
  <h2>âœ¨ ELITE: DARK FRONTIER</h2>
  <div id="star-count">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  <div>Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ: <span id="cur-sys" class="val">â€”</span></div>
</div>

<!-- CONTROLS -->
<div id="controls" class="panel">
  <h3>âš™ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•</h3>
  <button class="btn btn-full" id="btn-solar">ğŸª Ğ¡ĞĞ›ĞĞ•Ğ§ĞĞĞ¯ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ</button>
  <button class="btn" id="btn-sun">â˜€ Ğ¡ĞĞ›ĞĞ¦Ğ•</button>
  <button class="btn" id="btn-lines">ğŸ”— Ğ›Ğ˜ĞĞ˜Ğ˜ ĞœĞĞ¡Ğ¡Ğ˜Ğ’ĞĞ«Ğ¥</button>
  <button class="btn btn-full" id="btn-trade">ğŸš€ Ğ¢ĞĞ Ğ“ĞĞ’Ğ«Ğ• ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ«</button>
  <button class="btn btn-full" id="btn-route">ğŸ§® ĞŸĞ ĞĞ¡Ğ§ĞĞ¢ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ</button>
  <button class="btn btn-full" id="btn-save">ğŸ’¾ Ğ¡ĞĞ¥Ğ ĞĞĞ˜Ğ¢Ğ¬</button>
  <button class="btn btn-full" id="btn-load">ğŸ“‚ Ğ—ĞĞ“Ğ Ğ£Ğ—Ğ˜Ğ¢Ğ¬</button>
  <button class="btn" id="btn-equip">ğŸ›  Ğ¡ĞĞĞ Ğ¯Ğ–Ğ•ĞĞ˜Ğ•</button>
  <button class="btn" id="btn-missions">ğŸ“‹ ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ˜</button>
  <label>â­ Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ·Ğ²Ñ‘Ğ·Ğ´ <span id="v-size" class="val">13</span></label>
  <input type="range" id="sl-size" min="1" max="30" step="0.5" value="13">
  <label>ğŸš€ Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ <span id="v-speed" class="val">200</span></label>
  <input type="range" id="sl-speed" min="1" max="10000" step="1" value="200">
  <label>ğŸ”† Ğ¯Ñ€ĞºĞ¾ÑÑ‚ÑŒ <span id="v-bright" class="val">1.0</span></label>
  <input type="range" id="sl-bright" min="0.2" max="2.0" step="0.1" value="1.0">
  <p style="font-size:11px;color:#886622;margin-top:8px;">WASD â€” Ğ¿Ğ¾Ğ»Ñ‘Ñ‚ Â· Q/E â€” Ğ²Ğ²ĞµÑ€Ñ…/Ğ²Ğ½Ğ¸Ğ· Â· Shift â€” Ã—3</p>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-block">
    <div><span class="lbl">ĞšĞ Ğ•Ğ”Ğ˜Ğ¢Ğ«:</span> <span class="val" id="h-cred">10000</span></div>
    <div><span class="lbl">Ğ¢ĞĞŸĞ›Ğ˜Ğ’Ğ:</span> <span class="val" id="h-fuel">7.0</span>/7.0 Ñ‚</div>
    <div><span class="lbl">Ğ“Ğ Ğ£Ğ—:</span> <span class="val" id="h-cargo">0</span>/<span id="h-cmax">22</span> Ñ‚</div>
    <div><span class="lbl">ĞŸĞĞ›ĞĞ¢ĞĞ’:</span> <span class="val" id="h-flights">0</span></div>
  </div>
  <div class="hud-block" style="text-align:center;">
    <div><span class="lbl">Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“:</span> <span class="val" id="h-rank">Harmless</span></div>
    <div><span class="lbl">ĞœĞĞ ĞĞ›Ğ¬:</span> <span class="val" id="h-morale">ĞĞĞ ĞœĞ</span></div>
  </div>
  <div class="hud-block" style="text-align:right;">
    <div><span class="lbl">Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ:</span> <span class="val" id="h-sys">â€”</span></div>
    <div><span class="lbl">ĞŸĞ›ĞĞĞ•Ğ¢Ğ:</span> <span class="val" id="h-planet">â€”</span></div>
    <div><span class="lbl">Ğ­ĞšĞĞĞĞœĞ˜ĞšĞ:</span> <span class="val" id="h-econ">â€”</span></div>
  </div>
</div>

<!-- QUICK TRAVEL -->
<div id="quicktravel" class="panel">
  <h4>âš¡ Ğ‘Ğ«Ğ¡Ğ¢Ğ Ğ«Ğ™ ĞŸĞ•Ğ Ğ•Ğ›ĞĞ¢</h4>
  <div id="wp-list"></div>
  <button class="btn btn-green" id="btn-addwp" style="margin-top:6px;">+ ĞœĞ•Ğ¢ĞšĞ</button>
</div>

<!-- TRAVEL MESSAGE -->
<div id="travel-msg"></div>

<!-- HOVER INFO -->
<div id="hover-info"></div>

<!-- NEWS WIDGET -->
<div id="news-widget" class="panel">
  <h4 id="news-toggle">ğŸ“° ĞĞĞ’ĞĞ¡Ğ¢Ğ˜ Ğ“ĞĞ›ĞĞšĞ¢Ğ˜ĞšĞ˜ â–¼</h4>
  <div class="news-tick" id="news-tick"></div>
</div>

<!-- NEWS MODAL -->
<div id="news-modal">
  <h3 style="font-family:var(--font-title);font-size:14px;color:#ffff88;text-align:center;">ğŸ“° Ğ“ĞĞ›ĞĞšĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• ĞĞĞ’ĞĞ¡Ğ¢Ğ˜</h3>
  <div id="news-full" style="margin-top:12px;"></div>
  <button class="btn btn-full" id="news-close" style="margin-top:12px;">Ğ—ĞĞšĞ Ğ«Ğ¢Ğ¬</button>
</div>

<!-- TRADE PANEL -->
<div class="modal-panel" id="trade-panel">
  <h3>Ğ¡Ğ¢ĞĞĞ¦Ğ˜Ğ¯: <span id="st-name"></span></h3>
  <div id="trade-items"></div>
  <button class="btn close-modal" id="close-trade">Ğ—ĞĞšĞ Ğ«Ğ¢Ğ¬</button>
</div>

<!-- EQUIPMENT PANEL -->
<div class="modal-panel" id="equip-panel">
  <h3>ğŸ›  Ğ¡ĞĞĞ Ğ¯Ğ–Ğ•ĞĞ˜Ğ•</h3>
  <div id="equip-slots" style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:10px 0;"></div>
  <button class="btn close-modal" id="close-equip">Ğ—ĞĞšĞ Ğ«Ğ¢Ğ¬</button>
</div>

<!-- MISSIONS PANEL -->
<div class="modal-panel" id="missions-panel">
  <h3>ğŸ“‹ ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ˜</h3>
  <div id="missions-list"><p style="color:#886622;">ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ¼Ğ¸ÑÑĞ¸Ğ¹ Ğ² ÑÑ‚Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.</p></div>
  <button class="btn close-modal" id="close-missions">Ğ—ĞĞšĞ Ğ«Ğ¢Ğ¬</button>
</div>

<!-- ROUTE PANEL -->
<div id="route-panel" class="panel">
  <h3>ğŸ§® ĞŸĞ ĞĞ¡Ğ§ĞĞ¢ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ</h3>
  <div style="margin:6px 0;">
    <div>Ğ’Ñ…Ğ¾Ğ´: <span id="r-start" style="color:#88cc44;">â€”</span></div>
    <div>Ğ’Ñ‹Ñ…Ğ¾Ğ´: <span id="r-end" style="color:#4488cc;">â€”</span></div>
  </div>
  <div class="route-progress"><div class="route-fill" id="r-fill"></div></div>
  <div class="route-stats">
    <div class="route-stat"><div class="lbl">ĞŸĞ£Ğ¢Ğ•Ğ™</div><div class="val" id="r-count">0/10</div></div>
    <div class="route-stat"><div class="lbl">Ğ›Ğ£Ğ§Ğ¨Ğ˜Ğ™</div><div class="val" id="r-best">â€”</div></div>
    <div class="route-stat"><div class="lbl">Ğ ĞĞ¡Ğ¡Ğ¢ĞĞ¯ĞĞ˜Ğ•</div><div class="val" id="r-dist">â€”</div></div>
    <div class="route-stat"><div class="lbl">Ğ—Ğ’ĞĞ—Ğ”</div><div class="val" id="r-stars">â€”</div></div>
  </div>
  <div id="route-list"></div>
  <button class="btn btn-full" id="close-route" style="margin-top:6px;">Ğ¡ĞšĞ Ğ«Ğ¢Ğ¬</button>
  <button class="btn btn-red btn-full" id="stop-route" style="margin-top:4px;">â›” ĞĞ¡Ğ¢ĞĞĞĞ’Ğ˜Ğ¢Ğ¬</button>
</div>

<!-- STAR SELECTION -->
<div id="star-select" class="panel">
  <h4>Ğ’Ğ«Ğ‘ĞĞ  Ğ—Ğ’ĞĞ—Ğ” Ğ”Ğ›Ğ¯ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ</h4>
  <div style="margin:8px 0;">
    <span class="sel-pt start">ğŸŸ¢ ĞŸĞšĞœ = Ğ’Ğ¥ĞĞ”</span>
    <span class="sel-pt end">ğŸ”µ ĞŸĞšĞœ = Ğ’Ğ«Ğ¥ĞĞ”</span>
  </div>
  <div id="sel-status">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ²Ñ…Ğ¾Ğ´Ğ° (ĞŸĞšĞœ Ğ¿Ğ¾ Ğ·Ğ²ĞµĞ·Ğ´Ğµ)</div>
  <button class="btn btn-green" id="sel-calc" disabled>ĞŸĞ ĞĞ¡Ğ§Ğ˜Ğ¢ĞĞ¢Ğ¬</button>
  <button class="btn" id="sel-cancel">ĞĞ¢ĞœĞ•ĞĞ</button>
</div>

<!-- FUEL PANEL -->
<div id="fuel-panel" class="panel">
  <h4>â›½ Ğ¢ĞĞŸĞ›Ğ˜Ğ’Ğ</h4>
  <div class="fuel-row"><span class="lbl">Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ:</span><span class="val" id="f-dist">â€”</span></div>
  <div class="fuel-row"><span class="lbl">ĞÑƒĞ¶Ğ½Ğ¾:</span><span class="val" id="f-need">â€”</span></div>
  <div class="fuel-row"><span class="lbl">Ğ•ÑÑ‚ÑŒ:</span><span class="val" id="f-have">â€”</span></div>
  <div class="fuel-row"><span class="lbl">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</span><span class="val" id="f-status">â€”</span></div>
  <button class="btn btn-full" id="close-fuel" style="margin-top:6px;">Ğ—ĞĞšĞ Ğ«Ğ¢Ğ¬</button>
</div>

<!-- MOBILE CONTROLS -->
<button id="mobile-toggle">âš™</button>
<div id="mobile-controls">
  <button class="touch-btn" data-act="fwd">â–²</button>
  <button class="touch-btn" data-act="left">â—€</button>
  <button class="touch-btn" data-act="back">â–¼</button>
  <button class="touch-btn" data-act="right">â–¶</button>
  <button class="touch-btn" data-act="up">â¬†</button>
  <button class="touch-btn" data-act="down">â¬‡</button>
  <button class="touch-btn" data-act="solar">ğŸª</button>
  <button class="touch-btn" data-act="fast">âš¡</button>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu">
  <button id="ctx-rename">âœ ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
  <button id="ctx-lock">ğŸ”’ Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
  <button id="ctx-unlock">ğŸ”“ Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
  <button id="ctx-delete">ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/renderers/CSS2DRenderer.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ECON = ["Poor Agri","Avg Agri","Rich Agri","Poor Ind","Avg Ind","Rich Ind","Poor Common","Avg Common"];
const GOV  = ["Anarchy","Feudal","Multi-gov","Dictatorship","Confederacy","Democracy","Corporate","Satori","Communist"];
const PTYPES = ["rocky","gas_giant","ice","jungle","desert","ocean","dead","artificial","ruins","fungal","insectoid","cyber","magic"];
const GOODS = [
  {id:0,name:"Food",base:13,unit:4},{id:1,name:"Textiles",base:27,unit:4},
  {id:2,name:"Radioactives",base:1600,unit:1},{id:3,name:"Slaves",base:180,unit:4,illegal:true},
  {id:4,name:"Liquor",base:55,unit:4},{id:5,name:"Luxuries",base:150,unit:1},
  {id:6,name:"Narcotics",base:1000,unit:1,illegal:true},{id:7,name:"Computers",base:500,unit:1},
  {id:8,name:"Machinery",base:400,unit:2},{id:9,name:"Alloys",base:170,unit:4},
  {id:10,name:"Firearms",base:290,unit:2,illegal:true},{id:11,name:"Furs",base:220,unit:2},
  {id:12,name:"Minerals",base:53,unit:4},{id:13,name:"Gold",base:660,unit:1},
  {id:14,name:"Platinum",base:550,unit:1},{id:15,name:"Gem-Stones",base:2500,unit:1},
  {id:16,name:"Alien Items",base:192,unit:1}
];
const EQUIPMENT = [
  {id:1,name:"Pulse Lasers",cost:4000,effect:"ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ñ‹Ğµ Ğ»Ğ°Ğ·ĞµÑ€Ñ‹"},
  {id:2,name:"Beam Lasers",cost:10000,effect:"Ğ»ÑƒÑ‡ĞµĞ²Ñ‹Ğµ Ğ»Ğ°Ğ·ĞµÑ€Ñ‹"},
  {id:3,name:"E.C.M.",cost:6000,effect:"Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ñ€Ğ°ĞºĞµÑ‚"},
  {id:4,name:"Fuel Scoops",cost:5250,effect:"ÑĞ±Ğ¾Ñ€ Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ°"},
  {id:5,name:"Escape Pod",cost:10000,effect:"ÑĞ¿Ğ°ÑĞµĞ½Ğ¸Ğµ"},
  {id:6,name:"Energy Bomb",cost:9000,effect:"ÑĞ½ĞµÑ€Ğ³Ğ¾Ğ±Ğ¾Ğ¼Ğ±Ğ°"},
  {id:7,name:"Energy Unit",cost:15000,effect:"Ñ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ"},
  {id:8,name:"Dock Computer",cost:10000,effect:"Ğ°Ğ²Ñ‚Ğ¾ÑÑ‚Ñ‹ĞºĞ¾Ğ²ĞºĞ°"},
  {id:9,name:"Galactic Drive",cost:50000,effect:"Ğ¼ĞµĞ¶Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ñ€Ñ‹Ğ¶Ğ¾Ğº"},
  {id:10,name:"Bio Update",cost:20000,effect:"ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ·"}
];

const NEWS = [
  {title:'AXIOM Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ¸Ğ»Ğ° Delta-7',text:'ĞšĞ¾Ñ€Ğ¿Ğ¾Ñ€Ğ°Ñ†Ğ¸Ñ AXIOM Ğ·Ğ°Ğ½ÑĞ»Ğ° ÑĞµĞºÑ‚Ğ¾Ñ€ Delta-7. Ğ—Ğ°Ğ»ĞµĞ¶Ğ¸ He-3 Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ°Ñ‚ Ñ„Ğ»Ğ¾Ñ‚ Ğ½Ğ° 200 Ğ»ĞµÑ‚.',sys:'Delta-7'},
  {title:'Ğ—Ğ°Ğ±Ğ°ÑÑ‚Ğ¾Ğ²ĞºĞ° ÑˆĞ°Ñ…Ñ‚Ñ‘Ñ€Ğ¾Ğ²',text:'ĞĞ»ÑŒÑĞ½Ñ ĞĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ñ… Ğ¨Ğ°Ñ…Ñ‚Ñ‘Ñ€Ğ¾Ğ² Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ğ» 40% Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ² ÑĞµĞºÑ‚Ğ¾Ñ€Ğµ Barnard.',sys:'Barnard'},
  {title:'[Ğ¤ĞĞšĞ¢] 2 Ñ‚Ñ€Ğ»Ğ½ Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ğº',text:'ĞŸĞ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ Conselice et al. (2016), Ğ²Ğ¾ Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ¾Ğ¹ â‰ˆ2 Ñ‚Ñ€Ğ»Ğ½ Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ğº.',sys:'Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ°Ñ'},
  {title:'ĞĞ»Ğ¼Ğ°Ğ·Ğ½Ğ°Ñ Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚Ğ° 55 Cancri e',text:'ĞœĞ°ÑÑĞ° 8.6 Ğ—ĞµĞ¼ĞµĞ»ÑŒ, 40 ÑĞ².Ğ»ĞµÑ‚. ĞŸÑ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ÑÑ Ğ°Ğ»Ğ¼Ğ°Ğ·Ğ½Ğ°Ñ Ğ¼Ğ°Ğ½Ñ‚Ğ¸Ñ.',sys:'55 Cancri'},
  {title:'[Ğ¤ĞĞšĞ¢] 5700+ ÑĞºĞ·Ğ¾Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚',text:'NASA Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ğ»Ğ¾ 5700+ ÑĞºĞ·Ğ¾Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚ (2024). TRAPPIST-1: 7 Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ¾Ğ¼ Ñ Ğ—ĞµĞ¼Ğ»Ñ.',sys:'TRAPPIST-1'},
  {title:'ĞŸĞ¸Ñ€Ğ°Ñ‚Ñ‹ Ñƒ Wolf 359',text:'Â«Ğ¢Ñ‘Ğ¼Ğ½Ñ‹Ğ¹ ĞšĞ¾Ğ³Ğ¾Ñ‚ÑŒÂ» Ğ°Ñ‚Ğ°ĞºĞ¾Ğ²Ğ°Ğ» ĞºĞ¾Ğ½Ğ²Ğ¾Ğ¹. Wolf 359 â€” ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹ ĞºĞ°Ñ€Ğ»Ğ¸Ğº, 7.86 ÑĞ².Ğ»ĞµÑ‚.',sys:'Wolf 359'},
  {title:'[Ğ¤ĞĞšĞ¢] ĞœĞ»ĞµÑ‡Ğ½Ñ‹Ğ¹ ĞŸÑƒÑ‚ÑŒ',text:'Ğ¡Ğ¿Ğ¸Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸ĞºĞ°, Ã˜ ~100 000 ÑĞ².Ğ»ĞµÑ‚, 100â€“400 Ğ¼Ğ»Ñ€Ğ´ Ğ·Ğ²Ñ‘Ğ·Ğ´, ~1 Ñ‚Ñ€Ğ»Ğ½ Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚.',sys:'Milky Way'},
  {title:'Kepler-442b: 18 Ğ¼ĞµÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğ¹',text:'Ğ¡Ğ¿ÑƒÑ‚Ğ½Ğ¸Ğº Â«Ğ—Ğ¾Ñ€ĞºĞ¸Ğ¹-14Â» Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ» ĞºĞ°Ñ€Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ. 18 Ğ¼ĞµÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğ¹ Ñ€ĞµĞ´ĞºĞ¾Ğ·ĞµĞ¼Ğ¾Ğ².',sys:'Kepler-442'},
  {title:'[Ğ¤ĞĞšĞ¢] ĞĞµĞ¹Ñ‚Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ²Ñ‘Ğ·Ğ´Ñ‹',text:'ĞŸĞ»Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ 10Â¹â· ĞºĞ³/Ğ¼Â³. Ğ§Ğ°Ğ¹Ğ½Ğ°Ñ Ğ»Ğ¾Ğ¶ĞºĞ° ~6 Ğ¼Ğ»Ñ€Ğ´ Ñ‚Ğ¾Ğ½Ğ½. Ã˜ ~20 ĞºĞ¼.',sys:'Pulsar'},
  {title:'ĞŸĞ¾Ğ´Ğ»Ñ‘Ğ´Ğ½Ñ‹Ğ¹ Ğ¾ĞºĞµĞ°Ğ½ Ğ•Ğ²Ñ€Ğ¾Ğ¿Ñ‹-9',text:'Ğ Ğ¾Ğ²ĞµÑ€Ñ‹ Â«ĞšĞ¸Ñ€Ğ¸Ğ»Ğ»Â» Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ»Ğ¸ Ğ¾ĞºĞµĞ°Ğ½. Ğ ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ•Ğ²Ñ€Ğ¾Ğ¿Ğ°: Ğ´Ğ¾ 100 ĞºĞ¼ Ğ»ÑŒĞ´Ğ°.',sys:'Europa-9'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const player = {
  credits:10000, fuel:7, maxFuel:7,
  cargo: new Array(GOODS.length).fill(0), cargoMax:22,
  kills:0, rank:'Harmless', psychosis:0, morale:100,
  equipment: EQUIPMENT.map(e=>({...e,equipped:false})),
  slots: new Array(5).fill(null),
  currentSystem:null, docked:false, flights:0,
  position: null
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scene, camera, renderer, labelRenderer, controls;
let starsMesh, starsMat, starData = [];
let clock = new THREE.Clock();
let solarGroup, planets = [], sunMesh;
let massiveStars = [], massiveRings = [], massiveLines = null, showMassive = false;
let tradeVisible = false, tradeLines = [], tradeCurves = [], dynPoints = null, dynData = [], shipLabels = [];
let speed = 200;
let moveF=false, moveB=false, moveL=false, moveR=false, moveU=false, moveD=false;
let traveling=false, travelTo=null, travelFrom=null, travelT=0;
let solarMode = true;
let waypoints = [], wpCount = 0;

// Route calculation
const MAX_PATHS = 10;
let routeActive=false, routeStart=null, routeEnd=null, routeCalcing=false, routeStopped=false;
let routeLines=[], routeBest=null, routeAll=[], selRings=[], nameLabels=[];

// DOM refs
const $hover = document.getElementById('hover-info');
const $travelMsg = document.getElementById('travel-msg');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAR LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStars() {
  try {
    const r = await fetch('../stars.json');
    if (!r.ok) throw new Error(r.status);
    return await r.json();
  } catch(e) {
    console.warn('stars.json Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ:', e.message);
    return genSynth(5000);
  }
}

function genSynth(n) {
  const out = [];
  for (let i=0;i<n;i++) {
    const r=5000*Math.cbrt(Math.random()), th=Math.random()*Math.PI*2, ph=Math.acos(2*Math.random()-1);
    out.push({x:r*Math.sin(ph)*Math.cos(th), y:r*Math.sin(ph)*Math.sin(th), z:r*Math.cos(ph), mag:Math.random()*10-2, bv:Math.random()*1.5-.3, hip:i+1});
  }
  return out;
}

function starColor(bv, mag) {
  if (bv===undefined||isNaN(bv)) {
    const bf = Math.max(.1, 1-(mag+5)/25);
    return new THREE.Color().setHSL(.6-bf*.3,.8,bf*.8);
  }
  const t=Math.max(-.4,Math.min(2,bv));
  let r,g,b;
  if (t<0){r=.8+t*.5;g=.9+t*.3;b=1;}
  else if(t<.6){r=1;g=1-t*.3;b=.9-t*.5;}
  else{r=1;g=.7-(t-.6)*.5;b=Math.max(0,.4-(t-.6)*.3);}
  const br=Math.max(.3,1-(mag+5)/20);
  return new THREE.Color(r*br,g*br,b*br);
}

function systemProps(star, i) {
  let s=i*75+74;
  s=(s*75+74)%65536; const econ=Math.floor(s/8192)%8;
  s=(s*75+74)%65536; const gov=Math.floor(s/7281)%9;
  s=(s*75+74)%65536; const tech=Math.min(14,Math.floor(s/4681)+(econ<3?2:4));
  s=(s*75+74)%65536; const pt=PTYPES[Math.floor(s/5041)%PTYPES.length];
  const prices=GOODS.map(g=>{
    let p=g.base+(tech-7)*5;
    if(econ>=3&&econ<=5) p=Math.floor(p*.9);
    return Math.max(1,p);
  });
  return {economy:econ, econName:ECON[econ], govName:GOV[gov], tech, planetType:pt, prices};
}

function starName(idx) {
  const s=starData[idx];
  return s.hip?`HIP ${s.hip}`:`Ğ—Ğ²ĞµĞ·Ğ´Ğ° ${idx}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPRITE TEXTURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeSprite() {
  const c=document.createElement('canvas'); c.width=64; c.height=64;
  const x=c.getContext('2d');
  const g=x.createRadialGradient(32,32,0,32,32,32);
  g.addColorStop(0,'rgba(255,255,255,1)');
  g.addColorStop(.4,'rgba(255,255,200,.9)');
  g.addColorStop(.7,'rgba(200,200,100,.5)');
  g.addColorStop(1,'rgba(255,255,255,0)');
  x.fillStyle=g; x.fillRect(0,0,64,64);
  return new THREE.CanvasTexture(c);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD() {
  document.getElementById('h-cred').textContent = player.credits;
  document.getElementById('h-fuel').textContent = player.fuel.toFixed(1);
  const used = player.cargo.reduce((a,b)=>a+b,0);
  document.getElementById('h-cargo').textContent = used;
  document.getElementById('h-cmax').textContent = player.cargoMax;
  document.getElementById('h-flights').textContent = player.flights;
  document.getElementById('h-rank').textContent = player.rank;
  document.getElementById('h-morale').textContent = player.morale>80?'Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™':player.morale<30?'ĞĞ˜Ğ—ĞšĞ˜Ğ™':'ĞĞĞ ĞœĞ';
  if (player.currentSystem!==null && starData[player.currentSystem]) {
    const s=starData[player.currentSystem];
    document.getElementById('h-sys').textContent = s.hip?`HIP ${s.hip}`:'SYN';
    document.getElementById('h-planet').textContent = s.planetType||'â€”';
    document.getElementById('h-econ').textContent = s.econName||'â€”';
    document.getElementById('cur-sys').textContent = s.hip?`HIP ${s.hip}`:'SYN';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE / LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveProgress() {
  const d={player:{credits:player.credits,fuel:player.fuel,cargo:player.cargo,rank:player.rank,
    psychosis:player.psychosis,morale:player.morale,flights:player.flights},waypoints,wpCount};
  localStorage.setItem('elite_progress',JSON.stringify(d));
  showMsg('ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½!');
}
function loadProgress() {
  const raw=localStorage.getItem('elite_progress');
  if(!raw){showMsg('ĞĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¹');return;}
  try {
    const d=JSON.parse(raw);
    if(d.player){Object.assign(player,d.player);}
    if(d.waypoints){waypoints=d.waypoints;wpCount=d.wpCount||0;waypoints.forEach(addWPButton);}
    updateHUD();showMsg('Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾!');
  }catch(e){showMsg('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸',true);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRAVEL & MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function flyTo(pos, offset=50) {
  if(traveling) return;
  const dir=new THREE.Vector3().subVectors(pos,camera.position).normalize();
  travelFrom=camera.position.clone();
  travelTo=offset>0?pos.clone().sub(dir.multiplyScalar(offset)):pos.clone();
  travelT=0; traveling=true; player.flights++; updateHUD();
}

function showMsg(txt, warn=false, ms=3000) {
  $travelMsg.style.opacity='1';
  $travelMsg.style.color=warn?'#ff6666':'#ffaa00';
  $travelMsg.textContent=txt;
  setTimeout(()=>{$travelMsg.style.opacity='0';},ms);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOLAR SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLANETS_DATA = [
  {name:'ĞœĞµÑ€ĞºÑƒÑ€Ğ¸Ğ¹',r:5,sz:.4,col:0x8c8c8c,spd:.04,
   desc:'â˜¿ Ã˜ 4879 ĞºĞ¼. T: -173/+427Â°C. ĞĞµÑ‚ Ğ°Ñ‚Ğ¼Ğ¾ÑÑ„ĞµÑ€Ñ‹.'},
  {name:'Ğ’ĞµĞ½ĞµÑ€Ğ°',r:7,sz:.6,col:0xe6b800,spd:.015,
   desc:'â™€ Ã˜ 12104 ĞºĞ¼. Ğ”Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ 92 Ğ°Ñ‚Ğ¼. T: +462Â°C.'},
  {name:'Ğ—ĞµĞ¼Ğ»Ñ',r:9,sz:.65,col:0x2288ff,spd:.01,
   desc:'â™ Ã˜ 12742 ĞºĞ¼. 71% Ğ²Ğ¾Ğ´Ğ°. 8 Ğ¼Ğ»Ñ€Ğ´ Ñ‡ĞµĞ».'},
  {name:'ĞœĞ°Ñ€Ñ',r:11,sz:.5,col:0xff6600,spd:.008,
   desc:'â™‚ Ã˜ 6779 ĞºĞ¼. T: -87Â°C. ĞĞ»Ğ¸Ğ¼Ğ¿ 21.9 ĞºĞ¼.'},
  {name:'Ğ®Ğ¿Ğ¸Ñ‚ĞµÑ€',r:15,sz:1.4,col:0xd2b48c,spd:.002,
   desc:'â™ƒ Ã˜ 139820 ĞºĞ¼. 318 Ğ¼Ğ°ÑÑ Ğ—ĞµĞ¼Ğ»Ğ¸. 95 ÑĞ¿ÑƒÑ‚Ğ½Ğ¸ĞºĞ¾Ğ².'},
  {name:'Ğ¡Ğ°Ñ‚ÑƒÑ€Ğ½',r:19,sz:1.2,col:0xf0d58c,spd:.0009,ring:true,
   desc:'â™„ Ã˜ 116460 ĞºĞ¼. ĞšĞ¾Ğ»ÑŒÑ†Ğ°: 99.9% Ğ»Ñ‘Ğ´. ĞŸĞ»Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ < Ğ²Ğ¾Ğ´Ñ‹.'},
  {name:'Ğ£Ñ€Ğ°Ğ½',r:23,sz:1,col:0x4fd0e7,spd:.0004,
   desc:'â›¢ Ã˜ 50724 ĞºĞ¼. ĞĞ°ĞºĞ»Ğ¾Ğ½ Ğ¾ÑĞ¸ 98Â°.'},
  {name:'ĞĞµĞ¿Ñ‚ÑƒĞ½',r:27,sz:1,col:0x4169e1,spd:.0002,
   desc:'â™† Ã˜ 49244 ĞºĞ¼. Ğ’ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ¾ 2100 ĞºĞ¼/Ñ‡.'}
];

function createSolarSystem() {
  sunMesh = new THREE.Mesh(
    new THREE.SphereGeometry(2,32,32),
    new THREE.MeshBasicMaterial({color:0xffcc44})
  );
  scene.add(sunMesh);

  solarGroup = new THREE.Group();
  PLANETS_DATA.forEach(d => {
    // orbit line
    const pts=[];
    for(let i=0;i<=128;i++){const a=i/128*Math.PI*2;pts.push(new THREE.Vector3(d.r*Math.cos(a),0,d.r*Math.sin(a)));}
    solarGroup.add(new THREE.LineLoop(
      new THREE.BufferGeometry().setFromPoints(pts),
      new THREE.LineBasicMaterial({color:0xffaa00,opacity:.3,transparent:true})
    ));
    // planet
    const mesh=new THREE.Mesh(
      new THREE.SphereGeometry(d.sz,16,16),
      new THREE.MeshBasicMaterial({color:d.col})
    );
    mesh.userData={name:d.name,radius:d.r,speed:d.spd,angle:Math.random()*6.28,desc:d.desc};
    solarGroup.add(mesh); planets.push(mesh);
    // ring
    if(d.ring){
      const rp=[];
      for(let i=0;i<=64;i++){const a=i/64*Math.PI*2;rp.push(new THREE.Vector3(d.sz*1.8*Math.cos(a),0,d.sz*1.8*Math.sin(a)));}
      mesh.add(new THREE.LineLoop(new THREE.BufferGeometry().setFromPoints(rp),new THREE.LineBasicMaterial({color:0xffaa00})));
    }
  });
  solarGroup.visible=false;
  scene.add(solarGroup);
}

function enterSolar(){solarMode=true;document.getElementById('btn-solar').classList.add('active');solarGroup.visible=true;controls.target.set(0,0,0);speed=10;document.getElementById('sl-speed').value=10;document.getElementById('v-speed').textContent='10';}
function exitSolar(){solarMode=false;document.getElementById('btn-solar').classList.remove('active');solarGroup.visible=false;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MASSIVE STARS & TRADE ROUTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeRing(r,col){
  const p=[];for(let i=0;i<=64;i++){const a=i/64*Math.PI*2;p.push(new THREE.Vector3(r*Math.cos(a),0,r*Math.sin(a)));}
  return new THREE.LineLoop(new THREE.BufferGeometry().setFromPoints(p),new THREE.LineBasicMaterial({color:col}));
}

function highlightMassive() {
  if(!starData.length)return;
  massiveStars=[...starData].sort((a,b)=>(a.mag||0)-(b.mag||0)).slice(0,100);
  massiveRings.forEach(r=>scene.remove(r));massiveRings=[];
  massiveStars.forEach(s=>{const ring=makeRing(30,0xffaa00);ring.position.copy(s.position);scene.add(ring);massiveRings.push(ring);});
}

function toggleMassiveLines(){
  showMassive=!showMassive;
  if(showMassive){
    if(massiveLines)scene.remove(massiveLines);
    const pos=[];
    for(let i=0;i<massiveStars.length-1;i++){
      const a=massiveStars[i].position,b=massiveStars[i+1].position;
      pos.push(a.x,a.y,a.z,b.x,b.y,b.z);
    }
    const g=new THREE.BufferGeometry();g.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
    massiveLines=new THREE.LineSegments(g,new THREE.LineBasicMaterial({color:0xffaa00,opacity:.5,transparent:true}));
    scene.add(massiveLines);
  } else { if(massiveLines){scene.remove(massiveLines);massiveLines=null;} }
}

function bezier(p1,p2,off=.3){
  const dir=new THREE.Vector3().subVectors(p2,p1),len=dir.length();
  const mid=new THREE.Vector3().addVectors(p1,p2).multiplyScalar(.5);
  const perp=new THREE.Vector3(-dir.y,dir.x,dir.z).normalize();
  if(perp.length()<.1)perp.set(0,0,1);
  const ofs=perp.multiplyScalar(len*off*(Math.random()*.5+.5));
  return new THREE.CubicBezierCurve3(p1,new THREE.Vector3().lerpVectors(p1,mid,.3).add(ofs),new THREE.Vector3().lerpVectors(p2,mid,.3).add(ofs),p2);
}

function buildTradeRoutes(){
  tradeLines.forEach(l=>scene.remove(l));if(dynPoints)scene.remove(dynPoints);
  shipLabels.forEach(s=>scene.remove(s));
  tradeLines=[];tradeCurves=[];dynData=[];shipLabels=[];
  if(!massiveStars.length)return;
  const sun=new THREE.Vector3(0,0,0);
  massiveStars.forEach(s=>tradeCurves.push(bezier(sun,s.position,.4)));
  for(let i=0;i<massiveStars.length-1;i++) tradeCurves.push(bezier(massiveStars[i].position,massiveStars[i+1].position,.3));

  const COLORS=[new THREE.Color(1,1,1),new THREE.Color(1,.9,.5),new THREE.Color(1,.5,.5),new THREE.Color(.5,.8,1)];
  tradeCurves.forEach(c=>{
    const col=COLORS[Math.floor(Math.random()*COLORS.length)];
    const pts=c.getPoints(50);
    const line=new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),new THREE.LineBasicMaterial({color:col,opacity:.25,transparent:true}));
    line.visible=tradeVisible;scene.add(line);tradeLines.push(line);
  });

  const N=800;
  const pos=new Float32Array(N*3),cols=new Float32Array(N*3);
  for(let i=0;i<N;i++){
    const ci=Math.floor(Math.random()*tradeCurves.length),t=Math.random();
    const col=COLORS[Math.floor(Math.random()*COLORS.length)];
    const p=tradeCurves[ci].getPoint(t);
    pos[i*3]=p.x;pos[i*3+1]=p.y;pos[i*3+2]=p.z;
    cols[i*3]=col.r;cols[i*3+1]=col.g;cols[i*3+2]=col.b;
    dynData.push({curve:tradeCurves[ci],t,speed:(.03+Math.random()*.05)*.001});
  }
  const geo=new THREE.BufferGeometry();
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  geo.setAttribute('color',new THREE.BufferAttribute(cols,3));
  dynPoints=new THREE.Points(geo,new THREE.PointsMaterial({size:2,vertexColors:true,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false,sizeAttenuation:true}));
  dynPoints.visible=tradeVisible;scene.add(dynPoints);

  massiveStars.forEach(star=>{
    const cnt=3+Math.floor(Math.random()*8);
    for(let j=0;j<cnt;j++){
      const off=new THREE.Vector3((Math.random()-.5)*80,(Math.random()-.5)*80,(Math.random()-.5)*80);
      const div=document.createElement('div');div.className='ship-tag';
      div.textContent=`â›´ ${Math.floor(Math.random()*9000+1000)}`;
      const lbl=new THREE.CSS2DObject(div);lbl.position.copy(star.position).add(off);
      lbl.visible=tradeVisible;scene.add(lbl);shipLabels.push(lbl);
    }
  });
}

function toggleTrade(){
  tradeVisible=!tradeVisible;
  tradeLines.forEach(l=>l.visible=tradeVisible);
  if(dynPoints)dynPoints.visible=tradeVisible;
  shipLabels.forEach(s=>s.visible=tradeVisible);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUICK TRAVEL & WAYPOINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initQuickTravel(){
  const box=document.getElementById('wp-list');box.innerHTML='';
  const sorted=[...starData].sort((a,b)=>a.position.length()-b.position.length());
  sorted.slice(0,8).forEach((s,i)=>{
    const btn=document.createElement('button');btn.className='wp-btn';
    btn.textContent=s.hip?`HIP ${s.hip}`:`Star ${i+1}`;
    btn.onclick=()=>flyTo(s.position,50);
    box.appendChild(btn);
  });
  const saved=localStorage.getItem('elite_waypoints');
  if(saved){waypoints=JSON.parse(saved);wpCount=waypoints.length;waypoints.forEach(addWPButton);}
}

function addWPButton(wp){
  const box=document.getElementById('wp-list');
  const btn=document.createElement('button');
  btn.className='wp-btn'+(wp.locked?' locked':'');
  btn.textContent=(wp.locked?'ğŸ”’ ':'')+wp.name;
  btn.dataset.wpId=wp.id;
  btn.onclick=()=>flyTo(new THREE.Vector3(wp.position.x,wp.position.y,wp.position.z),0);
  btn.oncontextmenu=e=>{e.preventDefault();showCtx(e,wp.id);};
  box.appendChild(btn);
}

function addWaypoint(){
  wpCount++;
  const p=camera.position;
  const wp={id:Date.now(),name:`ĞœĞµÑ‚ĞºĞ° ${wpCount}`,position:{x:p.x,y:p.y,z:p.z},locked:false};
  waypoints.push(wp);localStorage.setItem('elite_waypoints',JSON.stringify(waypoints));
  addWPButton(wp);showMsg(`ĞœĞµÑ‚ĞºĞ° "${wp.name}" ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°`);
}

let ctxWP=null;
function showCtx(e,wpId){
  ctxWP=wpId;const m=document.getElementById('ctx-menu');
  m.style.display='block';m.style.left=e.clientX+'px';m.style.top=e.clientY+'px';
  const wp=waypoints.find(w=>w.id===wpId);
  document.getElementById('ctx-lock').style.display=wp&&!wp.locked?'block':'none';
  document.getElementById('ctx-unlock').style.display=wp&&wp.locked?'block':'none';
}
function hideCtx(){document.getElementById('ctx-menu').style.display='none';ctxWP=null;}
document.addEventListener('click',e=>{if(!e.target.closest('#ctx-menu'))hideCtx();});
document.getElementById('ctx-rename').onclick=()=>{
  const wp=waypoints.find(w=>w.id===ctxWP);if(!wp)return hideCtx();
  const n=prompt('ĞĞ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ:',wp.name);if(n){wp.name=n;localStorage.setItem('elite_waypoints',JSON.stringify(waypoints));
  const b=document.querySelector(`[data-wp-id="${wp.id}"]`);if(b)b.textContent=(wp.locked?'ğŸ”’ ':'')+wp.name;}hideCtx();
};
document.getElementById('ctx-lock').onclick=()=>{
  const wp=waypoints.find(w=>w.id===ctxWP);if(wp){wp.locked=true;localStorage.setItem('elite_waypoints',JSON.stringify(waypoints));
  const b=document.querySelector(`[data-wp-id="${wp.id}"]`);if(b){b.classList.add('locked');b.textContent='ğŸ”’ '+wp.name;}}hideCtx();
};
document.getElementById('ctx-unlock').onclick=()=>{
  const wp=waypoints.find(w=>w.id===ctxWP);if(wp){wp.locked=false;localStorage.setItem('elite_waypoints',JSON.stringify(waypoints));
  const b=document.querySelector(`[data-wp-id="${wp.id}"]`);if(b){b.classList.remove('locked');b.textContent=wp.name;}}hideCtx();
};
document.getElementById('ctx-delete').onclick=()=>{
  const wp=waypoints.find(w=>w.id===ctxWP);if(wp&&!wp.locked){waypoints=waypoints.filter(w=>w.id!==ctxWP);
  localStorage.setItem('elite_waypoints',JSON.stringify(waypoints));
  const b=document.querySelector(`[data-wp-id="${ctxWP}"]`);if(b)b.remove();showMsg('ĞœĞµÑ‚ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°');}hideCtx();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTrade(idx){
  if(player.docked)return;player.docked=true;
  const s=starData[idx];
  document.getElementById('st-name').textContent=s.hip?`HIP ${s.hip}`:'Ğ¡Ñ‚Ğ°Ğ½Ñ†Ğ¸Ñ';
  let h='';GOODS.forEach((g,i)=>{
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #332200;">
    <span>${g.name} â€” ${s.prices[i]} Cr</span>
    <span><button class="btn" onclick="buyG(${i},${s.prices[i]})">ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ</button>
    <button class="btn" onclick="sellG(${i},${s.prices[i]})">ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ</button>
    <span class="val">[${player.cargo[i]}]</span></span></div>`;
  });
  document.getElementById('trade-items').innerHTML=h;
  document.getElementById('trade-panel').style.display='block';
}
window.buyG=function(id,price){
  if(player.cargo.reduce((a,b)=>a+b,0)+GOODS[id].unit>player.cargoMax){showMsg('ĞĞµÑ‚ Ğ¼ĞµÑÑ‚Ğ°',true);return;}
  if(player.credits<price){showMsg('ĞĞµÑ‚ Ğ´ĞµĞ½ĞµĞ³',true);return;}
  player.credits-=price;player.cargo[id]++;updateHUD();openTrade(player.currentSystem);
};
window.sellG=function(id,price){
  if(player.cargo[id]<=0)return;
  player.credits+=price;player.cargo[id]--;updateHUD();openTrade(player.currentSystem);
};

function openEquip(){
  let h='';
  for(let i=0;i<5;i++){
    const eq=player.slots[i]?player.equipment.find(e=>e.id===player.slots[i]):null;
    h+=`<div style="background:#111;border:2px solid ${eq?'#ffaa00':'#442200'};padding:8px;text-align:center;font-size:12px;min-height:50px;display:flex;align-items:center;justify-content:center;">${eq?eq.name:'â€”'}</div>`;
  }
  document.getElementById('equip-slots').innerHTML=h;
  document.getElementById('equip-panel').style.display='block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initNews(){
  const tick=document.getElementById('news-tick');
  tick.innerHTML=NEWS.slice(0,5).map(n=>`<div class="news-item-sm">ğŸ“${n.sys}: ${n.title}</div>`).join('');
  document.getElementById('news-toggle').onclick=()=>{
    const m=document.getElementById('news-modal');m.style.display=m.style.display==='block'?'none':'block';
    if(m.style.display==='block'){
      document.getElementById('news-full').innerHTML=NEWS.map(n=>
        `<div style="border-bottom:1px solid #553311;padding:8px 0;"><div style="color:#ffff88;font-weight:bold;">${n.title}</div><div style="font-size:11px;color:#886622;">ğŸ“ ${n.sys}</div><div style="font-size:13px;margin-top:4px;">${n.text}</div></div>`
      ).join('');
    }
  };
  document.getElementById('news-close').onclick=()=>{document.getElementById('news-modal').style.display='none';};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTE CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startRouteSelect(){
  routeActive=true;routeStart=null;routeEnd=null;
  document.getElementById('star-select').style.display='block';
  document.getElementById('sel-status').textContent='Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ²Ñ…Ğ¾Ğ´Ğ° (ĞŸĞšĞœ Ğ¿Ğ¾ Ğ·Ğ²ĞµĞ·Ğ´Ğµ)';
  document.getElementById('sel-calc').disabled=true;
  document.getElementById('r-start').textContent='â€”';
  document.getElementById('r-end').textContent='â€”';
  clearSelRings();clearNameLabels();
  showMsg('ĞŸĞšĞœ Ğ¿Ğ¾ Ğ·Ğ²ĞµĞ·Ğ´Ğµ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ‚Ğ¾Ñ‡ĞµĞº Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ°');
}
function cancelRouteSelect(){
  routeActive=false;routeStart=null;routeEnd=null;
  document.getElementById('star-select').style.display='none';
  clearSelRings();clearNameLabels();
}
function clearSelRings(){selRings.forEach(r=>scene.remove(r));selRings=[];}
function clearNameLabels(){nameLabels.forEach(l=>scene.remove(l));nameLabels=[];}

function addSelRing(pos,col){
  const ring=new THREE.Mesh(
    new THREE.RingGeometry(25,30,64),
    new THREE.MeshBasicMaterial({color:col,side:THREE.DoubleSide,transparent:true,opacity:.6})
  );
  ring.position.copy(pos);scene.add(ring);selRings.push(ring);
}
function addNameLabel(pos,name){
  const div=document.createElement('div');div.className='star-label';div.textContent=name;
  const lbl=new THREE.CSS2DObject(div);lbl.position.copy(pos);lbl.position.y+=20;
  scene.add(lbl);nameLabels.push(lbl);
}

function startCalc(){
  if(routeStart===null||routeEnd===null)return;
  routeCalcing=true;routeStopped=false;routeAll=[];routeBest=null;
  document.getElementById('star-select').style.display='none';
  document.getElementById('route-panel').style.display='block';
  document.getElementById('r-fill').style.width='0%';
  document.getElementById('r-count').textContent=`0/${MAX_PATHS}`;
  document.getElementById('r-best').textContent='â€”';
  document.getElementById('r-dist').textContent='â€”';
  document.getElementById('r-stars').textContent='â€”';
  document.getElementById('route-list').innerHTML='';
  routeLines.forEach(l=>scene.remove(l));routeLines=[];
  clearNameLabels();
  calcNext(0);
}

function stopCalc(){
  routeStopped=true;routeCalcing=false;
  document.getElementById('r-fill').style.width='100%';
  showMsg('ĞŸĞ¾Ğ¸ÑĞº Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½',true);
  if(routeBest)finalizeRoutes();
}

function calcNext(idx){
  if(routeStopped||idx>=MAX_PATHS){
    routeCalcing=false;
    document.getElementById('r-fill').style.width='100%';
    if(!routeStopped)showMsg('ĞŸÑ€Ğ¾ÑÑ‡Ñ‘Ñ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!');
    if(routeBest)finalizeRoutes();
    return;
  }
  const path=findPath(routeStart,routeEnd,idx);
  const hue=(idx*360/MAX_PATHS)%360;
  path.color=`hsl(${hue},70%,50%)`;
  routeAll.push(path);

  // animate path building quickly
  let seg=0;
  function drawSeg(){
    if(seg>=path.path.length-1){
      document.getElementById('r-count').textContent=`${idx+1}/${MAX_PATHS}`;
      document.getElementById('r-fill').style.width=((idx+1)/MAX_PATHS*100)+'%';
      if(!routeBest||path.totalDist<routeBest.totalDist){
        routeBest=path;
        document.getElementById('r-best').textContent=`#${idx+1}`;
        document.getElementById('r-dist').textContent=path.totalDist.toFixed(1)+' ĞµĞ´.';
        document.getElementById('r-stars').textContent=path.path.length;
      }
      renderRouteList();
      setTimeout(()=>calcNext(idx+1),50);
      return;
    }
    const a=starData[path.path[seg]].position,b=starData[path.path[seg+1]].position;
    const line=new THREE.Line(
      new THREE.BufferGeometry().setFromPoints([a,b]),
      new THREE.LineBasicMaterial({color:new THREE.Color(path.color),transparent:true,opacity:.4})
    );
    scene.add(line);routeLines.push(line);
    seg++;
    setTimeout(drawSeg,20);
  }
  drawSeg();
}

function findPath(startIdx,endIdx,variation){
  const path=[startIdx];let cur=startIdx;
  const visited=new Set([startIdx]);
  let dist=0;
  const endPos=starData[endIdx].position;
  const directDist=starData[startIdx].position.distanceTo(endPos);

  for(let step=0;step<50&&cur!==endIdx;step++){
    const curPos=starData[cur].position;
    let best=null,bestW=Infinity;
    const candidates=[];
    for(let i=0;i<starData.length;i++){
      if(visited.has(i))continue;
      const d=curPos.distanceTo(starData[i].position);
      const toEnd=starData[i].position.distanceTo(endPos);
      const w=d*(.5+toEnd/directDist*.5)*(1+(Math.random()-.5)*.2*variation);
      candidates.push({idx:i,w,d});
    }
    candidates.sort((a,b)=>a.w-b.w);
    const pick=candidates[Math.min(Math.floor(Math.random()*5),candidates.length-1)];
    if(!pick)break;
    path.push(pick.idx);dist+=pick.d;visited.add(pick.idx);cur=pick.idx;
  }
  if(cur!==endIdx){dist+=starData[cur].position.distanceTo(endPos);path.push(endIdx);}
  return {path,totalDist:dist,variation};
}

function renderRouteList(){
  const box=document.getElementById('route-list');box.innerHTML='';
  routeAll.forEach((r,i)=>{
    const div=document.createElement('div');div.className='route-item';
    const names=r.path.map(j=>starName(j)).join(' â†’ ');
    div.innerHTML=`<div class="route-dot" style="background:${r.color}"></div>
      <div style="flex:1;"><div style="font-size:11px;color:#cc8800;">#${i+1} Â· ${r.totalDist.toFixed(1)} ĞµĞ´. Â· ${r.path.length} Ğ·Ğ²Ñ‘Ğ·Ğ´</div>
      <div style="font-size:10px;color:#886622;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${names}">${names}</div></div>`;
    div.onclick=()=>{
      routeLines.forEach(l=>scene.remove(l));routeLines=[];
      for(let s=0;s<r.path.length-1;s++){
        const a=starData[r.path[s]].position,b=starData[r.path[s+1]].position;
        const line=new THREE.Line(new THREE.BufferGeometry().setFromPoints([a,b]),
          new THREE.LineBasicMaterial({color:new THREE.Color(r.color),transparent:true,opacity:1}));
        scene.add(line);routeLines.push(line);
      }
      showMsg(`ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚ #${i+1} Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½`);
    };
    box.appendChild(div);
  });
}

function finalizeRoutes(){
  routeLines.forEach(l=>{l.material.opacity=.2;});
  if(routeBest){
    addNameLabel(starData[routeBest.path[0]].position,starName(routeBest.path[0]));
    addNameLabel(starData[routeBest.path[routeBest.path.length-1]].position,starName(routeBest.path[routeBest.path.length-1]));
    showMsg(`Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹: ${routeBest.path.length} Ğ·Ğ²Ñ‘Ğ·Ğ´, ${routeBest.totalDist.toFixed(1)} ĞµĞ´.`,false,6000);
    // fuel panel
    const ly=routeBest.totalDist*3.26;
    const need=.5*ly*ly;
    document.getElementById('f-dist').textContent=ly.toFixed(1)+' ÑĞ².Ğ»ĞµÑ‚';
    document.getElementById('f-need').textContent=need.toFixed(2)+' Ñ‚';
    document.getElementById('f-have').textContent=player.fuel.toFixed(1)+' Ñ‚';
    const ok=need<=player.fuel;
    document.getElementById('f-status').textContent=ok?'âœ… Ğ”ĞĞ¡Ğ¢Ğ£ĞŸĞĞ':'âŒ ĞœĞĞ›Ğ';
    document.getElementById('f-status').style.color=ok?'#00ff88':'#ff4444';
    document.getElementById('fuel-panel').style.display='block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAR PICKING (double-click & right-click)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickStar(ex,ey,threshold=30){
  let best=Infinity,bestI=-1;
  for(let i=0;i<starData.length;i++){
    const v=starData[i].position.clone().project(camera);
    if(v.z>1)continue;
    const sx=(v.x*.5+.5)*window.innerWidth, sy=(-v.y*.5+.5)*window.innerHeight;
    const d=Math.hypot(sx-ex,sy-ey);
    if(d<threshold&&d<best){best=d;bestI=i;}
  }
  return bestI;
}

function onDblClick(e){
  if(player.docked||routeActive)return;
  const idx=pickStar(e.clientX,e.clientY);
  if(idx!==-1){
    flyTo(starData[idx].position,50);
    player.currentSystem=idx;updateHUD();
    if(window.hubMsg)window.hubMsg({type:'location_update',system:starName(idx)});
  }
}

function onRightClick(e){
  if(!routeActive||e.target.closest('.panel,.modal-panel'))return;
  e.preventDefault();
  const idx=pickStar(e.clientX,e.clientY);
  if(idx===-1)return;
  if(routeStart===null){
    routeStart=idx;
    document.getElementById('r-start').textContent=starName(idx);
    document.getElementById('sel-status').textContent='Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° (ĞŸĞšĞœ)';
    addSelRing(starData[idx].position,0x88cc44);
  } else if(routeEnd===null){
    routeEnd=idx;
    document.getElementById('r-end').textContent=starName(idx);
    document.getElementById('sel-status').textContent='Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!';
    document.getElementById('sel-calc').disabled=false;
    addSelRing(starData[idx].position,0x4488cc);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOVER INFO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hoverTimer=null;
document.addEventListener('mousemove',e=>{
  if(hoverTimer)clearTimeout(hoverTimer);
  $hover.style.display='none';
  hoverTimer=setTimeout(()=>{
    if(!starData.length||!camera)return;
    const idx=pickStar(e.clientX,e.clientY,25);
    if(idx===-1)return;
    const s=starData[idx];
    const name=s.hip?'HIP '+s.hip:(s.proper||'Ğ—Ğ²ĞµĞ·Ğ´Ğ° '+idx);
    const sp=s.spect||'â€”';
    const distPc=s.dist?s.dist.toFixed(1)+' Ğ¿Ğº':'â€”';
    const distLy=s.dist?(s.dist*3.2616).toFixed(1)+' ÑĞ².Ğ»ĞµÑ‚':'â€”';
    const mag=s.mag!==undefined?s.mag.toFixed(2):'â€”';
    let spInfo='';
    const c=(sp||'')[0];
    if(c==='O')spInfo='Ğ“Ğ¾Ñ€ÑÑ‡Ğ¸Ğ¹ Ğ³Ğ¾Ğ»ÑƒĞ±Ğ¾Ğ¹ Ğ³Ğ¸Ğ³Ğ°Ğ½Ñ‚ (>30000K)';
    else if(c==='B')spInfo='Ğ‘ĞµĞ»Ğ¾-Ğ³Ğ¾Ğ»ÑƒĞ±Ğ°Ñ (10000-30000K)';
    else if(c==='A')spInfo='Ğ‘ĞµĞ»Ğ°Ñ (7500-10000K)';
    else if(c==='F')spInfo='Ğ–Ñ‘Ğ»Ñ‚Ğ¾-Ğ±ĞµĞ»Ğ°Ñ (6000-7500K)';
    else if(c==='G')spInfo='Ğ–Ñ‘Ğ»Ñ‚Ñ‹Ğ¹ ĞºĞ°Ñ€Ğ»Ğ¸Ğº (5200-6000K)';
    else if(c==='K')spInfo='ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ğ°Ñ (3700-5200K)';
    else if(c==='M')spInfo='ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ ĞºĞ°Ñ€Ğ»Ğ¸Ğº (<3700K)';
    $hover.innerHTML=`<div style="color:#ffff88;font-weight:bold;">${name}</div>`+
      `<div>Ğ¡Ğ¿ĞµĞºÑ‚Ñ€: <span style="color:#ffff88">${sp}</span></div>`+
      (spInfo?`<div style="color:#88ccff;font-size:12px;">${spInfo}</div>`:'')+
      `<div>Ğ Ğ°ÑÑÑ‚.: ${distPc} (${distLy})</div>`+
      `<div>Ğ—Ğ². Ğ²ĞµĞ».: ${mag}</div>`;
    $hover.style.display='block';$hover.style.left=e.clientX+'px';$hover.style.top=(e.clientY-10)+'px';
  },350);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(solarMode){
    if(e.code==='KeyW'){camera.position.lerp(controls.target,.05);e.preventDefault();}
    if(e.code==='KeyS'){camera.position.sub(new THREE.Vector3().subVectors(controls.target,camera.position).multiplyScalar(.05));e.preventDefault();}
    return;
  }
  switch(e.code){
    case'KeyW':moveF=true;e.preventDefault();break;case'KeyS':moveB=true;e.preventDefault();break;
    case'KeyA':moveL=true;e.preventDefault();break;case'KeyD':moveR=true;e.preventDefault();break;
    case'KeyQ':moveU=true;e.preventDefault();break;case'KeyE':moveD=true;e.preventDefault();break;
    case'ShiftLeft':speed*=3;e.preventDefault();break;
  }
});
document.addEventListener('keyup',e=>{
  if(solarMode)return;
  switch(e.code){
    case'KeyW':moveF=false;break;case'KeyS':moveB=false;break;
    case'KeyA':moveL=false;break;case'KeyD':moveR=false;break;
    case'KeyQ':moveU=false;break;case'KeyE':moveD=false;break;
    case'ShiftLeft':speed/=3;break;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  scene=new THREE.Scene();scene.background=new THREE.Color(0x050510);
  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e7);
  camera.position.set(0,500,2000);
  renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:'high-performance'});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  document.body.appendChild(renderer.domElement);

  labelRenderer=new THREE.CSS2DRenderer();
  labelRenderer.setSize(window.innerWidth,window.innerHeight);
  labelRenderer.domElement.style.position='absolute';
  labelRenderer.domElement.style.top='0';
  labelRenderer.domElement.style.left='0';
  labelRenderer.domElement.style.pointerEvents='none';
  labelRenderer.domElement.style.zIndex='500';
  document.body.appendChild(labelRenderer.domElement);

  // Load stars
  const raw=await loadStars();
  document.getElementById('star-count').textContent=`Ğ—Ğ²Ñ‘Ğ·Ğ´: ${raw.length}`;
  starData=raw.map((s,i)=>{
    const pos=new THREE.Vector3(s.x,s.y,s.z);
    const col=starColor(s.bv,s.mag);
    const sz=Math.max(.5,2.5-(s.mag+5)/5);
    const props=systemProps(s,i);
    return {...s,position:pos,color:col,size:sz,...props};
  });

  // Points mesh
  const positions=new Float32Array(starData.length*3);
  const colors=new Float32Array(starData.length*3);
  const sizes=new Float32Array(starData.length);
  starData.forEach((s,i)=>{
    positions[i*3]=s.x;positions[i*3+1]=s.y;positions[i*3+2]=s.z;
    colors[i*3]=s.color.r;colors[i*3+1]=s.color.g;colors[i*3+2]=s.color.b;
    sizes[i]=s.size;
  });
  const geo=new THREE.BufferGeometry();
  geo.setAttribute('position',new THREE.BufferAttribute(positions,3));
  geo.setAttribute('color',new THREE.BufferAttribute(colors,3));
  geo.setAttribute('size',new THREE.BufferAttribute(sizes,1));
  starsMat=new THREE.PointsMaterial({size:13,vertexColors:true,map:makeSprite(),transparent:true,blending:THREE.AdditiveBlending,depthWrite:false,sizeAttenuation:true});
  starsMesh=new THREE.Points(geo,starsMat);
  scene.add(starsMesh);

  // Solar system & massive stars
  createSolarSystem();
  highlightMassive();

  // Controls
  controls=new THREE.OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true;controls.dampingFactor=.08;
  controls.screenSpacePanning=true;controls.minDistance=5;controls.maxDistance=50000;
  controls.zoomSpeed=2;controls.rotateSpeed=.6;controls.target.set(0,0,0);

  player.position=camera.position.clone();

  // Events
  renderer.domElement.addEventListener('dblclick',onDblClick);
  renderer.domElement.addEventListener('contextmenu',onRightClick);

  // Planet click
  renderer.domElement.addEventListener('click',e=>{
    if(!solarGroup||!solarGroup.visible)return;
    const mouse=new THREE.Vector2((e.clientX/window.innerWidth)*2-1,-(e.clientY/window.innerHeight)*2+1);
    const rc=new THREE.Raycaster();rc.setFromCamera(mouse,camera);
    const hits=rc.intersectObjects(planets);
    if(hits.length){
      const pl=hits[0].object,nm=pl.userData.name||'?';
      document.getElementById('h-planet').textContent=nm;
      showMsg('ğŸª '+nm+': '+pl.userData.desc,false,5000);
      controls.target.copy(pl.position);
      if(window.hubMsg){window.hubMsg({type:'location_update',system:'Sol',body:nm});window.hubMsg({type:'status_msg',text:'ğŸª '+nm});}
    }
  });

  // UI bindings
  document.getElementById('sl-size').oninput=e=>{starsMat.size=+e.target.value;document.getElementById('v-size').textContent=e.target.value;};
  document.getElementById('sl-speed').oninput=e=>{speed=+e.target.value;document.getElementById('v-speed').textContent=e.target.value;};
  document.getElementById('sl-bright').oninput=e=>{starsMat.opacity=+e.target.value;document.getElementById('v-bright').textContent=e.target.value;};
  document.getElementById('btn-sun').onclick=()=>{if(solarMode)exitSolar();flyTo(new THREE.Vector3(0,0,0),50);};
  document.getElementById('btn-solar').onclick=()=>{solarMode?exitSolar():enterSolar();};
  document.getElementById('btn-lines').onclick=()=>{if(solarMode)exitSolar();toggleMassiveLines();};
  document.getElementById('btn-trade').onclick=()=>{if(solarMode)exitSolar();toggleTrade();};
  document.getElementById('btn-route').onclick=()=>{if(solarMode)exitSolar();startRouteSelect();};
  document.getElementById('btn-save').onclick=saveProgress;
  document.getElementById('btn-load').onclick=loadProgress;
  document.getElementById('btn-equip').onclick=()=>{if(solarMode)exitSolar();openEquip();};
  document.getElementById('btn-missions').onclick=()=>{if(solarMode)exitSolar();document.getElementById('missions-panel').style.display='block';};
  document.getElementById('btn-addwp').onclick=addWaypoint;
  document.getElementById('sel-calc').onclick=startCalc;
  document.getElementById('sel-cancel').onclick=cancelRouteSelect;
  document.getElementById('close-route').onclick=()=>{document.getElementById('route-panel').style.display='none';};
  document.getElementById('stop-route').onclick=stopCalc;
  document.getElementById('close-fuel').onclick=()=>{document.getElementById('fuel-panel').style.display='none';};
  document.getElementById('close-trade').onclick=()=>{document.getElementById('trade-panel').style.display='none';player.docked=false;};
  document.getElementById('close-equip').onclick=()=>{document.getElementById('equip-panel').style.display='none';};
  document.getElementById('close-missions').onclick=()=>{document.getElementById('missions-panel').style.display='none';};

  // Start
  initQuickTravel();
  buildTradeRoutes();
  initNews();
  camera.position.set(100,80,100);controls.target.set(0,0,0);controls.update();
  updateHUD();
  animate();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANIMATION LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(clock.getDelta(),.1);

  if(traveling&&travelTo&&travelFrom){
    travelT+=dt/1.0;
    let t=travelT;t=t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
    const cur=new THREE.Vector3().lerpVectors(travelFrom,travelTo,t);
    controls.target.copy(cur);camera.position.copy(cur.clone().add(new THREE.Vector3(0,30,60)));
    if(travelT>=1)traveling=false;
  } else if(solarMode){
    controls.target.set(0,0,0);
  } else {
    const fwd=new THREE.Vector3();camera.getWorldDirection(fwd);
    const right=new THREE.Vector3().crossVectors(fwd,camera.up).normalize();
    const mv=new THREE.Vector3();
    if(moveF)mv.addScaledVector(fwd,speed*dt);
    if(moveB)mv.addScaledVector(fwd,-speed*dt);
    if(moveR)mv.addScaledVector(right,speed*dt);
    if(moveL)mv.addScaledVector(right,-speed*dt);
    if(moveU)mv.y+=speed*dt;
    if(moveD)mv.y-=speed*dt;
    camera.position.add(mv);controls.target.add(mv);
  }
  controls.update();

  // Trade route particles
  if(tradeVisible&&dynPoints){
    const arr=dynPoints.geometry.attributes.position.array;
    for(let i=0;i<dynData.length;i++){
      dynData[i].t+=dynData[i].speed*dt;if(dynData[i].t>1)dynData[i].t=0;
      const p=dynData[i].curve.getPoint(dynData[i].t);
      arr[i*3]=p.x;arr[i*3+1]=p.y;arr[i*3+2]=p.z;
    }
    dynPoints.geometry.attributes.position.needsUpdate=true;
    // cull distant ship labels
    const cp=camera.position;
    shipLabels.forEach(s=>{const dx=s.position.x-cp.x,dy=s.position.y-cp.y,dz=s.position.z-cp.z;s.visible=tradeVisible&&(dx*dx+dy*dy+dz*dz<640000);});
  }

  // Planets orbit
  if(solarGroup&&solarGroup.visible){
    planets.forEach(p=>{p.userData.angle+=p.userData.speed*dt;p.position.x=Math.cos(p.userData.angle)*p.userData.radius;p.position.z=Math.sin(p.userData.angle)*p.userData.radius;});
  }

  // Billboard rings
  massiveRings.forEach(r=>r.quaternion.copy(camera.quaternion));
  selRings.forEach(r=>r.quaternion.copy(camera.quaternion));

  renderer.render(scene,camera);
  labelRenderer.render(scene,camera);
}

// Resize
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
  labelRenderer.setSize(window.innerWidth,window.innerHeight);
});

// Help overlay
document.getElementById('help').addEventListener('click',function(){this.style.display='none';});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOBILE TOUCH CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initMobile(){
  const isMob = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  if (!isMob) return;

  // Toggle controls panel
  document.getElementById('mobile-toggle').addEventListener('click', () => {
    document.getElementById('controls').classList.toggle('mob-open');
  });

  // Touch movement buttons
  const actions = {fwd:'moveF',back:'moveB',left:'moveL',right:'moveR',up:'moveU',down:'moveD'};
  document.querySelectorAll('.touch-btn').forEach(btn => {
    const act = btn.dataset.act;
    if (actions[act]) {
      const setMove = (val) => {
        switch(act){
          case'fwd':moveF=val;break;case'back':moveB=val;break;
          case'left':moveL=val;break;case'right':moveR=val;break;
          case'up':moveU=val;break;case'down':moveD=val;break;
        }
      };
      btn.addEventListener('touchstart', e => { e.preventDefault(); setMove(true); }, {passive:false});
      btn.addEventListener('touchend', e => { e.preventDefault(); setMove(false); }, {passive:false});
      btn.addEventListener('touchcancel', e => { setMove(false); });
    }
    if (act === 'solar') {
      btn.addEventListener('click', () => { solarMode ? exitSolar() : enterSolar(); });
    }
    if (act === 'fast') {
      btn.addEventListener('touchstart', e => { e.preventDefault(); speed *= 3; }, {passive:false});
      btn.addEventListener('touchend', e => { e.preventDefault(); speed /= 3; }, {passive:false});
    }
  });

  // Double-tap to fly to star
  let lastTap = 0;
  document.addEventListener('touchend', e => {
    const now = Date.now();
    if (now - lastTap < 300) {
      const touch = e.changedTouches[0];
      if (touch && !e.target.closest('.panel,.modal-panel,.touch-btn,#mobile-toggle,#mobile-controls')) {
        const idx = pickStar(touch.clientX, touch.clientY, 40);
        if (idx !== -1) {
          flyTo(starData[idx].position, 50);
          player.currentSystem = idx; updateHUD();
        }
      }
    }
    lastTap = now;
  });
})();

// Launch
init().catch(console.error);
</script>

<!-- Parent frame communication -->
<script>
window._gs=null;
window.addEventListener('message',e=>{if(e.data&&e.data.type==='game_state')window._gs=e.data.state;});
if(window.parent!==window)window.parent.postMessage({type:'get_state'},'*');
window.hubMsg=function(msg){if(window.parent!==window)window.parent.postMessage(msg,'*');};
</script>
</body>
</html>
