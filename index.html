<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite: Dark Frontier v4.0</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
<style>
:root {
  --amber: #ffaa00;
  --gold: #ffdd99;
  --dark: #03010a;
  --panel: rgba(0,0,0,0.92);
  --glow: 0 0 10px #cc8800, inset 0 0 5px #442200;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: var(--dark);
  font-family: 'VT323', monospace;
  color: var(--gold);
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
#crt-overlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  pointer-events: none;
  background: repeating-linear-gradient(0deg, rgba(255,200,100,0.03) 0px, rgba(0,0,0,0.15) 2px, transparent 3px);
  z-index: 99999; mix-blend-mode: multiply;
}

/* --- NAV BAR --- */
#nav-bar {
  height: 48px; min-height: 48px;
  background: rgba(0,0,0,0.95);
  border-bottom: 3px solid var(--amber);
  display: flex; align-items: center; gap: 4px;
  padding: 0 12px; z-index: 10000;
  box-shadow: 0 2px 20px rgba(255,170,0,0.3);
  overflow-x: auto;
}
.nav-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 11px; color: #ffff88;
  margin-right: 16px;
  text-shadow: 0 0 10px #ffaa00, 0 0 20px #cc6600;
  white-space: nowrap;
  cursor: pointer;
}
.nav-btn {
  background: transparent;
  border: 1px solid #443311;
  color: var(--gold);
  padding: 6px 14px;
  cursor: pointer;
  font-family: 'VT323', monospace;
  font-size: 15px;
  transition: all .15s;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.nav-btn:hover {
  background: #332211;
  border-color: var(--amber);
  text-shadow: 0 0 8px var(--amber);
}
.nav-btn.active {
  background: #664422;
  border-color: var(--amber);
  text-shadow: 0 0 8px var(--amber);
  box-shadow: 0 0 8px rgba(255,170,0,0.4);
}
.nav-spacer { flex: 1; }

/* --- HUD CREDITS BAR --- */
#hud-bar {
  display: flex; align-items: center; gap: 12px;
  font-size: 14px;
  margin-left: auto;
  padding-left: 12px;
  border-left: 1px solid #443311;
}
.hud-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
.hud-label { color: #cc8800; font-size: 12px; }
.hud-val { color: #ffff88; font-weight: bold; font-size: 15px; }

/* --- MODULE FRAME --- */
#module-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}
#module-frame {
  width: 100%; height: 100%;
  border: none;
  background: var(--dark);
}

/* --- WELCOME SCREEN --- */
#welcome-screen {
  position: absolute; top:0; left:0; right:0; bottom:0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: radial-gradient(ellipse at center, #0a0800 0%, #03010a 70%);
  z-index: 5000;
  padding: 40px;
}
#welcome-screen.hidden { display: none; }
.welcome-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 28px; color: #ffff88;
  text-shadow: 0 0 30px #ffaa00, 0 0 60px #cc6600;
  margin-bottom: 30px;
  text-align: center;
  line-height: 1.4;
}
.welcome-sub {
  font-size: 22px; color: var(--gold);
  text-align: center; max-width: 700px;
  line-height: 1.6; margin-bottom: 40px;
}
.welcome-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  max-width: 900px;
  width: 100%;
  margin-bottom: 30px;
}
.welcome-card {
  border: 2px solid #443311;
  background: rgba(0,0,0,0.8);
  padding: 16px;
  cursor: pointer;
  transition: all .2s;
  text-align: center;
}
.welcome-card:hover {
  border-color: var(--amber);
  box-shadow: 0 0 20px rgba(255,170,0,0.3);
  transform: translateY(-2px);
}
.welcome-card .icon { font-size: 36px; margin-bottom: 8px; }
.welcome-card .name {
  font-family: 'Press Start 2P', cursive;
  font-size: 9px; color: #ffff88; margin-bottom: 6px;
}
.welcome-card .desc { font-size: 14px; color: #cc8800; }

/* --- NEWS TICKER on welcome --- */
.news-ticker-wrap {
  width: 100%; max-width: 900px;
  border: 1px solid #443311;
  background: rgba(0,0,0,0.7);
  overflow: hidden; height: 34px;
  display: flex; align-items: center;
}
.news-label {
  background: var(--amber); color: #000;
  font-family: 'Press Start 2P', cursive;
  font-size: 7px; padding: 4px 10px;
  white-space: nowrap; flex-shrink: 0;
  letter-spacing: 1px;
}
.news-scroll { flex: 1; overflow: hidden; position: relative; }
.news-content {
  white-space: nowrap; color: #ffdd88; font-size: 15px;
  position: absolute; animation: ntick 50s linear infinite;
}
@keyframes ntick { from{transform:translateX(100%)} to{transform:translateX(-100%)} }

/* --- PROFILE PANEL (slide-in) --- */
#profile-panel {
  position: fixed; top: 48px; right: -420px;
  width: 400px; height: calc(100vh - 48px);
  background: rgba(0,0,0,0.97);
  border-left: 3px solid var(--amber);
  box-shadow: -5px 0 30px rgba(255,170,0,0.2);
  z-index: 9000;
  padding: 20px;
  overflow-y: auto;
  transition: right .3s ease;
  font-size: 16px;
}
#profile-panel.open { right: 0; }
#profile-panel h2 {
  font-family: 'Press Start 2P', cursive;
  font-size: 13px; color: #ffff88;
  text-align: center; margin-bottom: 16px;
  border-bottom: 2px solid var(--amber);
  padding-bottom: 10px;
}
.prof-row {
  display: flex; justify-content: space-between;
  padding: 6px 0; border-bottom: 1px dotted rgba(255,170,0,0.2);
}
.prof-label { color: #cc8800; }
.prof-val { color: #ffff88; font-weight: bold; }
.prof-bar-wrap { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
.prof-bar-bg { flex:1; height:14px; background:#221100; border:1px solid var(--amber); }
.prof-bar-fill { height:100%; background: linear-gradient(90deg, #ffaa00, #ffff88); transition: width .3s; }
.prof-section {
  margin-top: 16px;
  border: 1px solid #443311;
  padding: 12px;
}
.prof-section-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px; color: #ffff88;
  margin-bottom: 8px;
  border-bottom: 1px dashed var(--amber);
  padding-bottom: 4px;
}
.prof-close {
  position: absolute; top: 10px; right: 10px;
  background: #664422; border: 1px solid var(--amber);
  color: var(--gold); width: 32px; height: 32px;
  cursor: pointer; font-size: 20px;
  display: flex; align-items: center; justify-content: center;
}
.prof-close:hover { background: #aa6633; }

/* --- STATUS BAR (bottom) --- */
#status-bar {
  height: 28px; min-height: 28px;
  background: rgba(0,0,0,0.95);
  border-top: 1px solid #443311;
  display: flex; align-items: center;
  padding: 0 12px;
  font-size: 13px;
  color: #886622;
  z-index: 10000;
  gap: 20px;
}
#status-msg { flex: 1; }
#status-loc { color: #cc8800; }
</style>
</head>
<body>

<div id="crt-overlay"></div>

<!-- NAVIGATION BAR -->
<div id="nav-bar">
  <span class="nav-title" id="logo-btn">ELITE: DARK FRONTIER</span>
  <button class="nav-btn active" data-module="welcome">–ì–õ–ê–í–ù–ê–Ø</button>
  <button class="nav-btn" data-module="modules/starmap.html">–ö–ê–†–¢–ê –ù–ï–ë–ê</button>
  <button class="nav-btn" data-module="modules/constructors.html">–í–ï–†–§–¨</button>
  <button class="nav-btn" data-module="modules/mining.html">–î–û–ë–´–ß–ê</button>
  <button class="nav-btn" data-module="modules/asteroid.html">–ê–°–¢–ï–†–û–ò–î</button>
  <button class="nav-btn" data-module="modules/planetarium.html">–ü–õ–ê–ù–ï–¢–ê–†–ò–ô</button>
  <button class="nav-btn" data-module="modules/rover.html">–†–û–í–ï–†</button>
  <button class="nav-btn" data-module="modules/terraforming.html">–°–ö–ê–ù–ï–†</button>
  <button class="nav-btn" data-module="modules/market.html">–†–´–ù–û–ö</button>
  <div id="hud-bar">
    <div class="hud-item"><span class="hud-label">CR:</span><span class="hud-val" id="hud-credits">50,000</span></div>
    <div class="hud-item"><span class="hud-label">FUEL:</span><span class="hud-val" id="hud-fuel">7.0</span></div>
    <div class="hud-item"><span class="hud-label">CARGO:</span><span class="hud-val" id="hud-cargo">0/20</span></div>
    <button class="nav-btn" id="profile-btn" style="margin-left:8px;">–ü–ò–õ–û–¢</button>
  </div>
</div>

<!-- MODULE FRAME (iframes) -->
<div id="module-container">
  <div id="welcome-screen">
    <div class="welcome-title">ELITE: DARK FRONTIER</div>
    <div class="welcome-sub">
      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ö–æ–º–∞–Ω–¥–æ—Ä.<br>
      –í–∞—à –∫–æ—Ä–∞–±–ª—å –∑–∞–ø—Ä–∞–≤–ª–µ–Ω, –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã.<br>
      –ì–∞–ª–∞–∫—Ç–∏–∫–∞ –∂–¥—ë—Ç.
    </div>
    <div class="welcome-grid">
      <div class="welcome-card" data-module="modules/starmap.html">
        <div class="icon">üåå</div>
        <div class="name">–ö–ê–†–¢–ê –ù–ï–ë–ê</div>
        <div class="desc">–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ 5000+ –∑–≤—ë–∑–¥, —Ç–æ—Ä–≥–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã, —Å–æ–ª–Ω–µ—á–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</div>
      </div>
      <div class="welcome-card" data-module="modules/constructors.html">
        <div class="icon">üöÄ</div>
        <div class="name">–í–ï–†–§–¨</div>
        <div class="desc">14 –∫–æ—Ä–∞–±–ª–µ–π, 7 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤, 14 —Å—Ç–∞–Ω—Ü–∏–π ‚Äî wireframe –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</div>
      </div>
      <div class="welcome-card" data-module="modules/mining.html">
        <div class="icon">‚õèÔ∏è</div>
        <div class="name">–î–û–ë–´–ß–ê</div>
        <div class="desc">–ü–æ–ª—ë—Ç –Ω–∞ –∫–æ—Ä–∞–±–ª–µ, –ª–∞–∑–µ—Ä–Ω–∞—è —Å—Ç—Ä–µ–ª—å–±–∞ –ø–æ –∞—Å—Ç–µ—Ä–æ–∏–¥–∞–º, —Å–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤</div>
      </div>
      <div class="welcome-card" data-module="modules/asteroid.html">
        <div class="icon">ü™®</div>
        <div class="name">–ê–°–¢–ï–†–û–ò–î</div>
        <div class="desc">7 —Å—Ç–∞–¥–∏–π —Å–∫—É–ª—å–ø—Ç–∏–Ω–≥–∞ —Å 10 –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏</div>
      </div>
      <div class="welcome-card" data-module="modules/planetarium.html">
        <div class="icon">ü™ê</div>
        <div class="name">–ü–õ–ê–ù–ï–¢–ê–†–ò–ô</div>
        <div class="desc">Perlin-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–µ—Ç, 84 —Ä–µ—Å—É—Ä—Å–∞, –æ—Ä–±–∏—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏</div>
      </div>
      <div class="welcome-card" data-module="modules/rover.html">
        <div class="icon">ü§ñ</div>
        <div class="name">–†–û–í–ï–†</div>
        <div class="desc">6-–∫–æ–ª—ë—Å–Ω—ã–π —Ä–æ–≤–µ—Ä –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–º —Ç–µ—Ä—Ä–µ–Ωe, —Ä–∞–∑–≤–µ–¥–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</div>
      </div>
      <div class="welcome-card" data-module="modules/terraforming.html">
        <div class="icon">üõ∞Ô∏è</div>
        <div class="name">–°–ö–ê–ù–ï–†</div>
        <div class="desc">–°–ø—É—Ç–Ω–∏–∫–æ–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Ä—Ä–µ–Ω–æ–≤, 8 –ø–∞–ª–∏—Ç—Ä, WebGL —à–µ–π–¥–µ—Ä—ã</div>
      </div>
      <div class="welcome-card" data-module="modules/market.html">
        <div class="icon">üìà</div>
        <div class="name">–†–´–ù–û–ö</div>
        <div class="desc">5 —Å–µ–∫—Ç–æ—Ä–æ–≤, CoinGecko API, —Å–ø–∞—Ä–∫–ª–∞–π–Ω—ã, –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏</div>
      </div>
      <div class="welcome-card" id="card-profile">
        <div class="icon">üë®‚ÄçüöÄ</div>
        <div class="name">–ö–ê–ë–ò–ù–ï–¢ –ü–ò–õ–û–¢–ê</div>
        <div class="desc">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, —Ä–µ–ø—É—Ç–∞—Ü–∏—è, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      </div>
    </div>
    <div class="news-ticker-wrap">
      <div class="news-label">–ù–û–í–û–°–¢–ò</div>
      <div class="news-scroll">
        <div class="news-content" id="welcome-news"></div>
      </div>
    </div>
  </div>
  <iframe id="module-frame" class="hidden-frame"></iframe>
</div>

<!-- PROFILE PANEL -->
<div id="profile-panel">
  <button class="prof-close" id="profile-close">‚úï</button>
  <h2>–ö–ê–ë–ò–ù–ï–¢ –ö–û–ú–ê–ù–î–û–†–ê</h2>
  <div id="profile-content"></div>
</div>

<!-- STATUS BAR -->
<div id="status-bar">
  <span id="status-msg">–°–∏—Å—Ç–µ–º—ã –∞–∫—Ç–∏–≤–Ω—ã. –ì–æ—Ç–æ–≤ –∫ –≤—ã–ª–µ—Ç—É.</span>
  <span id="status-loc">–°–ï–ö: Sol | –°–ò–°–¢–ï–ú–ê: ‚Äî</span>
</div>

<script>
// ============================================================
// GAME STATE ‚Äî –µ–¥–∏–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
// ============================================================
const DEFAULT_STATE = {
  pilot: { name: '–ö–æ–º–∞–Ω–¥–æ—Ä', rank: '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü', faction: '–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ' },
  credits: 50000,
  fuel: 7.0,
  maxFuel: 7.0,
  cargo: [],
  maxCargo: 20,
  ships: [{ name: '–ö–û–ë–†–ê MK-I', level: 1 }],
  currentShip: 0,
  stations: [],
  transporters: [],
  location: { system: 'Sol', body: null },
  stats: {
    jumps: 0,
    trades: 0,
    mined: 0,
    sculpted: 0,
    planetsScanned: 0,
    roversDeployed: 0,
    stockTrades: 0,
    totalProfit: 0,
    distanceLY: 0
  },
  achievements: [],
  portfolio: {},
  reputation: { traders: 0, miners: 0, explorers: 0, military: 0 },
  savedAt: null
};

function loadGameState() {
  try {
    const raw = localStorage.getItem('elite_df_state');
    if (raw) {
      const s = JSON.parse(raw);
      return { ...DEFAULT_STATE, ...s, stats: { ...DEFAULT_STATE.stats, ...s.stats }, reputation: { ...DEFAULT_STATE.reputation, ...s.reputation } };
    }
  } catch(e) {}
  return { ...DEFAULT_STATE };
}

function saveGameState() {
  gameState.savedAt = Date.now();
  localStorage.setItem('elite_df_state', JSON.stringify(gameState));
}

let gameState = loadGameState();

function updateHUD() {
  document.getElementById('hud-credits').textContent = gameState.credits.toLocaleString('ru-RU');
  document.getElementById('hud-fuel').textContent = gameState.fuel.toFixed(1);
  document.getElementById('hud-cargo').textContent = `${gameState.cargo.length}/${gameState.maxCargo}`;
}
updateHUD();

// News content
const GAME_NEWS = [
  '‚ö° –ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è AXIOM –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ –∑–∞–ª–µ–∂–∏ He-3 –≤ —Å–µ–∫—Ç–æ—Ä–µ Delta-7 ‚Äî –∞–∫—Ü–∏–∏ –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ 340%',
  'üõ∞Ô∏è –°–∫–∞–Ω–µ—Ä Mk.IV –∑–∞–≤–µ—Ä—à–∏–ª –∫–∞—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã Kepler-442b ‚Äî 18 –Ω–æ–≤—ã—Ö –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π',
  'üíé –ê–ª–º–∞–∑–Ω–∞—è –ø–ª–∞–Ω–µ—Ç–∞ HD 131399Ab –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚Äî —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è —Å—Ç–∞—Ä—Ç—É–µ—Ç —á–µ—Ä–µ–∑ 3 —Ü–∏–∫–ª–∞',
  '‚ö†Ô∏è –í—É–ª–∫–∞–Ω–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ Io-7 —É–Ω–∏—á—Ç–æ–∂–∏–ª–∞ 3 —Å—Ç–∞–Ω—Ü–∏–∏ ‚Äî —É–±—ã—Ç–∫–∏ 2.4B CR',
  'üöÄ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∏–∫ –õ–ï–í–ò–ê–§–ê–ù –¥–æ—Å—Ç–∞–≤–∏–ª 450 000 —Ç–æ–Ω–Ω —Ä—É–¥—ã –Ω–∞ Proxima Hub',
  'üìä –ò—Ä–∏–¥–∏–π –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º—É–º–∞ ‚Äî 89 000 CR/—Ç–æ–Ω–Ω–∞. –®–∞—Ö—Ç—ë—Ä—ã –≤ –ø–ª—é—Å–µ.',
  'üî¨ –¢–µ—Ä—Ä–∞—Ñ–æ—Ä–º–∏–Ω–≥ –ú–∞—Ä—Å–∞: —ç—Ç–∞–ø 3/7 –∑–∞–≤–µ—Ä—à—ë–Ω, –¥–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ç—ë—Ç',
  'ü§ñ –†–æ–≤–µ—Ä—ã —Å–µ—Ä–∏–∏ –ö–∏—Ä–∏–ª–ª –Ω–∞—à–ª–∏ –ø–æ–¥–∑–µ–º–Ω—ã–π –æ–∫–µ–∞–Ω –Ω–∞ –ï–≤—Ä–æ–ø–µ-9',
  '‚õèÔ∏è –®–∞—Ö—Ç–∞ –ì–ª—É–±–æ–∫–∏–π –ì–æ—Ä–∏–∑–æ–Ω—Ç: –≥–ª—É–±–∏–Ω–∞ 47 –∫–º ‚Äî –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥',
  'üì° –ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º –≤ —Å–µ–∫—Ç–æ—Ä–µ Omega ‚Äî —Å–æ–ª–Ω–µ—á–Ω—ã–π —à—Ç–æ—Ä–º X4',
  'üåç Gliese 667Cc –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞–∫ –¢–µ—Ä—Ä–∞ ‚Äî –∫–æ–ª–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞—Ç–∞',
  'üí∞ –ò–Ω–¥–µ–∫—Å DEEP SPACE +12.7% –∑–∞ –Ω–µ–¥–µ–ª—é. –†—ã–Ω–æ–∫ –Ω–∞ –º–∞–∫—Å–∏–º—É–º–∞—Ö.',
  'üî¥ –ê—Å—Ç–µ—Ä–æ–∏–¥ –∫–ª–∞—Å—Å–∞ S –Ω–∞ –≤—Å—Ç—Ä–µ—á–Ω–æ–º –∫—É—Ä—Å–µ —Å –∫–æ–Ω–≤–æ–µ–º –û—Ä–∏–æ–Ω ‚Äî —ç–≤–∞–∫—É–∞—Ü–∏—è',
  'üßä Trappist-1f: –ø–æ–¥ 200–º –ª—å–¥–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
  'üè≠ –°—Ç–∞–Ω—Ü–∏—è Olympus –ø–µ—Ä–µ—à–ª–∞ –Ω–∞ –ø–æ–ª–Ω–æ–µ —Å–∞–º–æ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ ‚Äî 14 –º–æ–¥—É–ª–µ–π –∞–∫—Ç–∏–≤–Ω—ã',
  'üõ∏ –í —Å–µ–∫—Ç–æ—Ä–µ Barnard –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è',
];
const newsEl = document.getElementById('welcome-news');
if (newsEl) newsEl.textContent = GAME_NEWS.join('   ‚óè   ');

// Auto-save every 30s
setInterval(() => { saveGameState(); }, 30000);

// ============================================================
// NAVIGATION
// ============================================================
const navBtns = document.querySelectorAll('.nav-btn[data-module]');
const welcomeCards = document.querySelectorAll('.welcome-card[data-module]');
const welcomeScreen = document.getElementById('welcome-screen');
const moduleFrame = document.getElementById('module-frame');
let currentModule = 'welcome';

function navigateTo(module) {
  navBtns.forEach(b => b.classList.remove('active'));
  const target = document.querySelector(`.nav-btn[data-module="${module}"]`);
  if (target) target.classList.add('active');

  if (module === 'welcome') {
    welcomeScreen.classList.remove('hidden');
    moduleFrame.style.display = 'none';
    moduleFrame.src = 'about:blank';
    currentModule = 'welcome';
    document.getElementById('status-msg').textContent = '–°–∏—Å—Ç–µ–º—ã –∞–∫—Ç–∏–≤–Ω—ã. –ì–æ—Ç–æ–≤ –∫ –≤—ã–ª–µ—Ç—É.';
    return;
  }

  welcomeScreen.classList.add('hidden');
  moduleFrame.style.display = 'block';
  moduleFrame.src = module;
  currentModule = module;

  const names = {
    'modules/starmap.html': '–ö–ê–†–¢–ê –ù–ï–ë–ê',
    'modules/constructors.html': '–í–ï–†–§–¨',
    'modules/mining.html': '–î–û–ë–´–ß–ê',
    'modules/asteroid.html': '–ê–°–¢–ï–†–û–ò–î',
    'modules/planetarium.html': '–ü–õ–ê–ù–ï–¢–ê–†–ò–ô',
    'modules/rover.html': '–†–û–í–ï–†',
    'modules/terraforming.html': '–°–ö–ê–ù–ï–†',
    'modules/market.html': '–†–´–ù–û–ö'
  };
  document.getElementById('status-msg').textContent = `–ú–æ–¥—É–ª—å: ${names[module] || module}`;
}

navBtns.forEach(btn => {
  btn.addEventListener('click', () => navigateTo(btn.dataset.module));
});
welcomeCards.forEach(card => {
  card.addEventListener('click', () => navigateTo(card.dataset.module));
});
document.getElementById('logo-btn').addEventListener('click', () => navigateTo('welcome'));

// ============================================================
// PROFILE PANEL
// ============================================================
const profilePanel = document.getElementById('profile-panel');
const profileContent = document.getElementById('profile-content');

document.getElementById('profile-btn').addEventListener('click', () => {
  profilePanel.classList.toggle('open');
  if (profilePanel.classList.contains('open')) renderProfile();
});
document.getElementById('profile-close').addEventListener('click', () => {
  profilePanel.classList.remove('open');
});
document.getElementById('card-profile').addEventListener('click', () => {
  profilePanel.classList.add('open');
  renderProfile();
});

function renderProfile() {
  const s = gameState;
  const cargoWeight = s.cargo.reduce((sum, c) => sum + (c.qty || 1), 0);
  const ranks = ['–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü','–ü–∏–ª–æ—Ç','–ù–∞–≤–∏–≥–∞—Ç–æ—Ä','–ö–∞–ø–∏—Ç–∞–Ω','–ö–æ–º–º–∞–Ω–¥–µ—Ä','–ê–¥–º–∏—Ä–∞–ª','–≠–ª–∏—Ç–∞'];
  const xp = s.stats.jumps + s.stats.trades * 2 + s.stats.mined * 3 + s.stats.planetsScanned * 5;
  const rankIdx = Math.min(ranks.length - 1, Math.floor(xp / 50));
  s.pilot.rank = ranks[rankIdx];
  const nextRankXP = (rankIdx + 1) * 50;
  const pct = Math.min(100, (xp / nextRankXP) * 100);

  let html = `
    <div class="prof-row"><span class="prof-label">–ò–ú–Ø:</span><span class="prof-val">${s.pilot.name}</span></div>
    <div class="prof-row"><span class="prof-label">–†–ê–ù–ì:</span><span class="prof-val">${s.pilot.rank}</span></div>
    <div class="prof-row"><span class="prof-label">–§–†–ê–ö–¶–ò–Ø:</span><span class="prof-val">${s.pilot.faction}</span></div>
    <div class="prof-bar-wrap"><span class="prof-label" style="width:60px">XP:</span><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${pct}%"></div></div><span class="prof-val">${xp}/${nextRankXP}</span></div>

    <div class="prof-section">
      <div class="prof-section-title">–§–ò–ù–ê–ù–°–´</div>
      <div class="prof-row"><span class="prof-label">–ö—Ä–µ–¥–∏—Ç—ã:</span><span class="prof-val">${s.credits.toLocaleString('ru-RU')} CR</span></div>
      <div class="prof-row"><span class="prof-label">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å:</span><span class="prof-val">${s.stats.totalProfit.toLocaleString('ru-RU')} CR</span></div>
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–ö–û–†–ê–ë–õ–¨</div>
      <div class="prof-row"><span class="prof-label">–ú–æ–¥–µ–ª—å:</span><span class="prof-val">${s.ships[s.currentShip]?.name || '‚Äî'}</span></div>
      <div class="prof-row"><span class="prof-label">–¢–æ–ø–ª–∏–≤–æ:</span><span class="prof-val">${s.fuel.toFixed(1)} / ${s.maxFuel.toFixed(1)}</span></div>
      <div class="prof-bar-wrap"><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${(s.fuel/s.maxFuel*100).toFixed(0)}%; background: linear-gradient(90deg, #ff4444, #ffaa00, #88ff88)"></div></div></div>
      <div class="prof-row"><span class="prof-label">–ì—Ä—É–∑:</span><span class="prof-val">${cargoWeight} / ${s.maxCargo} —Ç</span></div>
      <div class="prof-bar-wrap"><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${(cargoWeight/s.maxCargo*100).toFixed(0)}%"></div></div></div>
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
      <div class="prof-row"><span class="prof-label">–ü—Ä—ã–∂–∫–æ–≤:</span><span class="prof-val">${s.stats.jumps}</span></div>
      <div class="prof-row"><span class="prof-label">–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</span><span class="prof-val">${s.stats.distanceLY.toFixed(1)} LY</span></div>
      <div class="prof-row"><span class="prof-label">–¢–æ—Ä–≥–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫:</span><span class="prof-val">${s.stats.trades}</span></div>
      <div class="prof-row"><span class="prof-label">–î–æ–±—ã—Ç–æ —Ä—É–¥—ã:</span><span class="prof-val">${s.stats.mined}</span></div>
      <div class="prof-row"><span class="prof-label">–ü–ª–∞–Ω–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:</span><span class="prof-val">${s.stats.planetsScanned}</span></div>
      <div class="prof-row"><span class="prof-label">–†–æ–≤–µ—Ä–æ–≤ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ:</span><span class="prof-val">${s.stats.roversDeployed}</span></div>
      <div class="prof-row"><span class="prof-label">–°–¥–µ–ª–æ–∫ –Ω–∞ –±–∏—Ä–∂–µ:</span><span class="prof-val">${s.stats.stockTrades}</span></div>
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–†–ï–ü–£–¢–ê–¶–ò–Ø</div>
      ${Object.entries(s.reputation).map(([k, v]) => {
        const names = { traders:'–¢–æ—Ä–≥–æ–≤—Ü—ã', miners:'–®–∞—Ö—Ç—ë—Ä—ã', explorers:'–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏', military:'–í–æ–µ–Ω–Ω—ã–µ' };
        const pct = Math.min(100, Math.max(0, v));
        return `<div class="prof-row"><span class="prof-label">${names[k]||k}:</span><span class="prof-val">${v}</span></div>
        <div class="prof-bar-wrap"><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${pct}%"></div></div></div>`;
      }).join('')}
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–ì–†–£–ó</div>
      ${s.cargo.length === 0 ? '<div style="color:#886622;text-align:center;">–¢—Ä—é–º –ø—É—Å—Ç</div>' :
        s.cargo.map(c => `<div class="prof-row"><span class="prof-label">${c.name}:</span><span class="prof-val">${c.qty || 1} —Ç</span></div>`).join('')}
    </div>
  `;
  profileContent.innerHTML = html;
}

// ============================================================
// CROSS-MODULE COMMUNICATION (postMessage)
// ============================================================
window.addEventListener('message', (e) => {
  if (!e.data || !e.data.type) return;
  const msg = e.data;

  switch (msg.type) {
    case 'credits_change':
      gameState.credits += msg.amount;
      if (msg.amount > 0) gameState.stats.totalProfit += msg.amount;
      updateHUD(); saveGameState();
      break;
    case 'fuel_change':
      gameState.fuel = Math.max(0, Math.min(gameState.maxFuel, gameState.fuel + msg.amount));
      updateHUD(); saveGameState();
      break;
    case 'cargo_add':
      if (gameState.cargo.length < gameState.maxCargo) {
        gameState.cargo.push({ name: msg.name, qty: msg.qty || 1, price: msg.price || 0 });
        updateHUD(); saveGameState();
      }
      break;
    case 'cargo_sell':
      const idx = gameState.cargo.findIndex(c => c.name === msg.name);
      if (idx >= 0) {
        const item = gameState.cargo.splice(idx, 1)[0];
        gameState.credits += msg.price || item.price || 0;
        gameState.stats.trades++;
        gameState.stats.totalProfit += msg.price || item.price || 0;
        updateHUD(); saveGameState();
      }
      break;
    case 'stat_increment':
      if (gameState.stats[msg.stat] !== undefined) {
        gameState.stats[msg.stat] += msg.amount || 1;
        saveGameState();
      }
      break;
    case 'ship_upgrade':
      if (msg.shipName) {
        gameState.ships[gameState.currentShip].name = msg.shipName;
        gameState.ships[gameState.currentShip].level = msg.level || 1;
        saveGameState();
      }
      break;
    case 'location_update':
      gameState.location.system = msg.system || gameState.location.system;
      gameState.location.body = msg.body || null;
      document.getElementById('status-loc').textContent = `–°–ï–ö: ${gameState.location.system} | ${msg.body || '‚Äî'}`;
      saveGameState();
      break;
    case 'get_state':
      moduleFrame.contentWindow.postMessage({ type: 'game_state', state: gameState }, '*');
      break;
    case 'status_msg':
      document.getElementById('status-msg').textContent = msg.text;
      break;
  }
});

// Send state to iframe when it loads
moduleFrame.addEventListener('load', () => {
  if (moduleFrame.src && moduleFrame.src !== 'about:blank') {
    setTimeout(() => {
      try {
        moduleFrame.contentWindow.postMessage({ type: 'game_state', state: gameState }, '*');
      } catch(e) {}
    }, 500);
  }
});

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (profilePanel.classList.contains('open')) {
      profilePanel.classList.remove('open');
    } else if (currentModule !== 'welcome') {
      navigateTo('welcome');
    }
  }
});
</script>
</body>
</html>
