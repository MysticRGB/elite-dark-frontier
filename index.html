<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite: Dark Frontier v4.0</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
<style>
:root {
  --amber: #ffaa00;
  --gold: #ffdd99;
  --dark: #03010a;
  --panel: rgba(0,0,0,0.92);
  --glow: 0 0 10px #cc8800, inset 0 0 5px #442200;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: var(--dark);
  font-family: 'VT323', monospace;
  color: var(--gold);
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
#crt-overlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  pointer-events: none;
  background: repeating-linear-gradient(0deg, rgba(255,200,100,0.03) 0px, rgba(0,0,0,0.15) 2px, transparent 3px);
  z-index: 99999; mix-blend-mode: multiply;
}

/* --- NAV BAR --- */
#nav-bar {
  height: 48px; min-height: 48px;
  background: rgba(0,0,0,0.95);
  border-bottom: 3px solid var(--amber);
  display: flex; align-items: center; gap: 4px;
  padding: 0 12px; z-index: 10000;
  box-shadow: 0 2px 20px rgba(255,170,0,0.3);
  overflow-x: auto;
}
.nav-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 11px; color: #ffff88;
  margin-right: 16px;
  text-shadow: 0 0 10px #ffaa00, 0 0 20px #cc6600;
  white-space: nowrap;
  cursor: pointer;
}
.nav-btn {
  background: transparent;
  border: 1px solid #443311;
  color: var(--gold);
  padding: 6px 14px;
  cursor: pointer;
  font-family: 'VT323', monospace;
  font-size: 15px;
  transition: all .15s;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.nav-btn:hover {
  background: #332211;
  border-color: var(--amber);
  text-shadow: 0 0 8px var(--amber);
}
.nav-btn.active {
  background: #664422;
  border-color: var(--amber);
  text-shadow: 0 0 8px var(--amber);
  box-shadow: 0 0 8px rgba(255,170,0,0.4);
}
.nav-spacer { flex: 1; }

/* --- HUD CREDITS BAR --- */
#hud-bar {
  display: flex; align-items: center; gap: 12px;
  font-size: 14px;
  margin-left: auto;
  padding-left: 12px;
  border-left: 1px solid #443311;
}
.hud-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
.hud-label { color: #cc8800; font-size: 12px; }
.hud-val { color: #ffff88; font-weight: bold; font-size: 15px; }

/* --- MODULE FRAME --- */
#module-container {
  flex: 1;
  position: relative;
  overflow: hidden;
}
#module-frame {
  width: 100%; height: 100%;
  border: none;
  background: var(--dark);
}

/* --- WELCOME SCREEN --- */
#welcome-screen {
  position: absolute; top:0; left:0; right:0; bottom:0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: radial-gradient(ellipse at center, #0a0800 0%, #03010a 70%);
  z-index: 5000;
  padding: 40px;
}
#welcome-screen.hidden { display: none; }
.welcome-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 28px; color: #ffff88;
  text-shadow: 0 0 30px #ffaa00, 0 0 60px #cc6600;
  margin-bottom: 30px;
  text-align: center;
  line-height: 1.4;
}
.welcome-sub {
  font-size: 22px; color: var(--gold);
  text-align: center; max-width: 700px;
  line-height: 1.6; margin-bottom: 40px;
}
.welcome-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  max-width: 900px;
  width: 100%;
  margin-bottom: 30px;
}
.welcome-card {
  border: 2px solid #443311;
  background: rgba(0,0,0,0.8);
  padding: 16px;
  cursor: pointer;
  transition: all .2s;
  text-align: center;
}
.welcome-card:hover {
  border-color: var(--amber);
  box-shadow: 0 0 20px rgba(255,170,0,0.3);
  transform: translateY(-2px);
}
.welcome-card .icon { font-size: 36px; margin-bottom: 8px; }
.welcome-card .name {
  font-family: 'Press Start 2P', cursive;
  font-size: 9px; color: #ffff88; margin-bottom: 6px;
}
.welcome-card .desc { font-size: 14px; color: #cc8800; }

/* --- TOOLTIPS --- */
.game-tooltip {
  position: fixed; z-index: 99000; pointer-events: none;
  background: rgba(0,0,0,0.95); border: 2px solid #ffaa00;
  color: #ffdd88; padding: 8px 14px; font-size: 15px;
  max-width: 280px; opacity: 0; transition: opacity .2s;
  box-shadow: 0 0 15px rgba(255,170,0,0.3);
  font-family: 'VT323', monospace;
}
.game-tooltip.visible { opacity: 1; }

/* --- ANIMATIONS --- */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 5px rgba(255,170,0,0.2); }
  50% { box-shadow: 0 0 20px rgba(255,170,0,0.5); }
}
@keyframes scanline-move {
  from { background-position: 0 0; }
  to { background-position: 0 4px; }
}
.welcome-card { animation: fadeInUp 0.4s ease both; }
.welcome-card:nth-child(1) { animation-delay: 0.05s; }
.welcome-card:nth-child(2) { animation-delay: 0.1s; }
.welcome-card:nth-child(3) { animation-delay: 0.15s; }
.welcome-card:nth-child(4) { animation-delay: 0.2s; }
.welcome-card:nth-child(5) { animation-delay: 0.25s; }
.welcome-card:nth-child(6) { animation-delay: 0.3s; }
.welcome-card:nth-child(7) { animation-delay: 0.35s; }
.welcome-card:nth-child(8) { animation-delay: 0.4s; }
.welcome-card:nth-child(9) { animation-delay: 0.45s; }
.nav-btn { transition: all .15s, box-shadow .3s; }
.nav-btn:active { transform: scale(0.95); }
.nav-btn.active { animation: pulse-glow 2s ease-in-out infinite; }
.hud-val { transition: color .3s; }

/* --- LEVEL BADGES --- */
.level-badge {
  display: inline-block; padding: 2px 8px;
  border: 1px solid #ffaa00; background: rgba(255,170,0,0.1);
  font-family: 'Press Start 2P', cursive; font-size: 8px;
  color: #ffff88; margin-left: 6px;
}
.skill-tree { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
.skill-item {
  border: 1px solid #443311; padding: 8px; text-align: center;
  transition: all .2s; cursor: default;
}
.skill-item.unlocked { border-color: #ffaa00; background: rgba(255,170,0,0.1); }
.skill-item .skill-name { font-size: 12px; color: #cc8800; }
.skill-item .skill-level { font-size: 18px; color: #ffff88; font-weight: bold; }
.skill-item .skill-bar { height: 4px; background: #221100; margin-top: 4px; }
.skill-item .skill-fill { height: 100%; background: #ffaa00; transition: width .3s; }

/* HUD flash effect */
@keyframes hud-flash {
  0% { color: #88ff88; text-shadow: 0 0 10px #88ff88; }
  100% { color: #ffff88; text-shadow: none; }
}
.hud-val.flash { animation: hud-flash 0.6s ease; }

/* --- NEWS TICKER on welcome --- */
.news-ticker-wrap {
  width: 100%; max-width: 900px;
  border: 1px solid #443311;
  background: rgba(0,0,0,0.7);
  overflow: hidden; height: 34px;
  display: flex; align-items: center;
}
.news-label {
  background: var(--amber); color: #000;
  font-family: 'Press Start 2P', cursive;
  font-size: 7px; padding: 4px 10px;
  white-space: nowrap; flex-shrink: 0;
  letter-spacing: 1px;
}
.news-scroll { flex: 1; overflow: hidden; position: relative; height: 100%; }
.news-content {
  white-space: nowrap; color: #ffdd88; font-size: 15px;
  position: absolute; top: 50%; transform: translateY(-50%);
  left: 100%;
  will-change: transform;
}

/* --- PROFILE PANEL (slide-in) --- */
#profile-panel {
  position: fixed; top: 48px; right: -420px;
  width: 400px; height: calc(100vh - 48px);
  background: rgba(0,0,0,0.97);
  border-left: 3px solid var(--amber);
  box-shadow: -5px 0 30px rgba(255,170,0,0.2);
  z-index: 9000;
  padding: 20px;
  overflow-y: auto;
  transition: right .3s ease;
  font-size: 16px;
}
#profile-panel.open { right: 0; }
#profile-panel h2 {
  font-family: 'Press Start 2P', cursive;
  font-size: 13px; color: #ffff88;
  text-align: center; margin-bottom: 16px;
  border-bottom: 2px solid var(--amber);
  padding-bottom: 10px;
}
.prof-row {
  display: flex; justify-content: space-between;
  padding: 6px 0; border-bottom: 1px dotted rgba(255,170,0,0.2);
}
.prof-label { color: #cc8800; }
.prof-val { color: #ffff88; font-weight: bold; }
.prof-bar-wrap { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
.prof-bar-bg { flex:1; height:14px; background:#221100; border:1px solid var(--amber); }
.prof-bar-fill { height:100%; background: linear-gradient(90deg, #ffaa00, #ffff88); transition: width .3s; }
.prof-section {
  margin-top: 16px;
  border: 1px solid #443311;
  padding: 12px;
}
.prof-section-title {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px; color: #ffff88;
  margin-bottom: 8px;
  border-bottom: 1px dashed var(--amber);
  padding-bottom: 4px;
}
.prof-close {
  position: absolute; top: 10px; right: 10px;
  background: #664422; border: 1px solid var(--amber);
  color: var(--gold); width: 32px; height: 32px;
  cursor: pointer; font-size: 20px;
  display: flex; align-items: center; justify-content: center;
}
.prof-close:hover { background: #aa6633; }

/* --- STATUS BAR (bottom) --- */
#status-bar {
  height: 28px; min-height: 28px;
  background: rgba(0,0,0,0.95);
  border-top: 1px solid #443311;
  display: flex; align-items: center;
  padding: 0 12px;
  font-size: 13px;
  color: #886622;
  z-index: 10000;
  gap: 20px;
}
#status-msg { flex: 1; transition: color .3s; }
#status-loc { color: #cc8800; }
@keyframes status-flash {
  0% { color: #88ff88; text-shadow: 0 0 8px #88ff88; }
  100% { color: #886622; text-shadow: none; }
}
#status-msg.flash { animation: status-flash 1s ease; }
</style>
</head>
<body>

<div id="crt-overlay"></div>

<!-- NAVIGATION BAR -->
<div id="nav-bar">
  <span class="nav-title" id="logo-btn">ELITE: DARK FRONTIER</span>
  <button class="nav-btn active" data-module="welcome">–ì–õ–ê–í–ù–ê–Ø</button>
  <button class="nav-btn" data-module="modules/starmap.html">–ö–ê–†–¢–ê –ù–ï–ë–ê</button>
  <button class="nav-btn" data-module="modules/constructors.html">–í–ï–†–§–¨</button>
  <button class="nav-btn" data-module="modules/mining.html">–î–û–ë–´–ß–ê</button>
  <button class="nav-btn" data-module="modules/asteroid.html">–ê–°–¢–ï–†–û–ò–î</button>
  <button class="nav-btn" data-module="modules/planetarium.html">–ü–õ–ê–ù–ï–¢–ê–†–ò–ô</button>
  <button class="nav-btn" data-module="modules/rover.html">–†–û–í–ï–†</button>
  <button class="nav-btn" data-module="modules/terraforming.html">–°–ö–ê–ù–ï–†</button>
  <button class="nav-btn" data-module="modules/market.html">–†–´–ù–û–ö</button>
  <div id="hud-bar">
    <div class="hud-item"><span class="hud-label">CR:</span><span class="hud-val" id="hud-credits">50,000</span></div>
    <div class="hud-item"><span class="hud-label">FUEL:</span><span class="hud-val" id="hud-fuel">7.0</span></div>
    <div class="hud-item"><span class="hud-label">CARGO:</span><span class="hud-val" id="hud-cargo">0/20</span></div>
    <button class="nav-btn" id="profile-btn" style="margin-left:8px;">–ü–ò–õ–û–¢</button>
  </div>
</div>

<!-- MODULE FRAME (iframes) -->
<div id="module-container">
  <div id="welcome-screen">
    <div class="welcome-title">ELITE: DARK FRONTIER</div>
    <div class="welcome-sub">
      2847 –≥–æ–¥. –¢—ë–º–Ω—ã–π –§—Ä–æ–Ω—Ç–∏—Ä ‚Äî —Ä—É–±–µ–∂ –æ—Å–≤–æ–µ–Ω–Ω–æ–≥–æ –∫–æ—Å–º–æ—Å–∞.<br>
      –í–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π ‚âà2 —Ç—Ä–ª–Ω –≥–∞–ª–∞–∫—Ç–∏–∫ –∏ ‚âà200 –º–ª—Ä–¥ —Ç—Ä–ª–Ω –∑–≤—ë–∑–¥ (2√ó10¬≤¬≥).<br>
      –¢–æ–ª—å–∫–æ –≤ –ú–ª–µ—á–Ω–æ–º –ü—É—Ç–∏ ‚Äî 100‚Äì400 –º–ª—Ä–¥ –∑–≤—ë–∑–¥ –∏ ~1 —Ç—Ä–ª–Ω –ø–ª–∞–Ω–µ—Ç.<br>
      –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ 5 700+ —ç–∫–∑–æ–ø–ª–∞–Ω–µ—Ç (NASA, 2024). –¢—ã ‚Äî –≤–æ–ª—å–Ω—ã–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫ –¢—ë–º–Ω–æ–≥–æ –§—Ä–æ–Ω—Ç–∏—Ä–∞.<br>
      –î–æ–±—ã–≤–∞–π, —Ç–æ—Ä–≥—É–π, –∏—Å—Å–ª–µ–¥—É–π. –ö–∞–∂–¥–∞—è –∑–≤–µ–∑–¥–∞ –∑–¥–µ—Å—å ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ HIP.
    </div>
    <div class="welcome-grid">
      <div class="welcome-card" data-module="modules/starmap.html">
        <div class="icon">üåå</div>
        <div class="name">–ö–ê–†–¢–ê –ù–ï–ë–ê</div>
        <div class="desc">5000+ –∑–≤—ë–∑–¥ ¬∑ –ü–æ–ª—ë—Ç ¬∑ –¢–æ—Ä–≥–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã ¬∑ –°–æ–ª–Ω–µ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ ¬∑ –ü–ª–∞–Ω–µ—Ç—ã</div>
      </div>
      <div class="welcome-card" data-module="modules/constructors.html">
        <div class="icon">üöÄ</div>
        <div class="name">–í–ï–†–§–¨</div>
        <div class="desc">14 –∫–æ—Ä–∞–±–ª–µ–π, 7 —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤, 14 —Å—Ç–∞–Ω—Ü–∏–π ‚Äî wireframe –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</div>
      </div>
      <div class="welcome-card" data-module="modules/mining.html">
        <div class="icon">‚õèÔ∏è</div>
        <div class="name">–î–û–ë–´–ß–ê</div>
        <div class="desc">–ü–æ–ª—ë—Ç –Ω–∞ –∫–æ—Ä–∞–±–ª–µ, –ª–∞–∑–µ—Ä–Ω–∞—è —Å—Ç—Ä–µ–ª—å–±–∞ –ø–æ –∞—Å—Ç–µ—Ä–æ–∏–¥–∞–º, —Å–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤</div>
      </div>
      <div class="welcome-card" data-module="modules/asteroid.html">
        <div class="icon">ü™®</div>
        <div class="name">–ê–°–¢–ï–†–û–ò–î</div>
        <div class="desc">7 —Å—Ç–∞–¥–∏–π —Å–∫—É–ª—å–ø—Ç–∏–Ω–≥–∞ —Å 10 –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏</div>
      </div>
      <div class="welcome-card" data-module="modules/planetarium.html">
        <div class="icon">ü™ê</div>
        <div class="name">–ü–õ–ê–ù–ï–¢–ê–†–ò–ô</div>
        <div class="desc">Perlin-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–µ—Ç, 84 —Ä–µ—Å—É—Ä—Å–∞, –æ—Ä–±–∏—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏</div>
      </div>
      <div class="welcome-card" data-module="modules/rover.html">
        <div class="icon">ü§ñ</div>
        <div class="name">–†–û–í–ï–†</div>
        <div class="desc">6-–∫–æ–ª—ë—Å–Ω—ã–π —Ä–æ–≤–µ—Ä –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–º —Ç–µ—Ä—Ä–µ–Ωe, —Ä–∞–∑–≤–µ–¥–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</div>
      </div>
      <div class="welcome-card" data-module="modules/terraforming.html">
        <div class="icon">üõ∞Ô∏è</div>
        <div class="name">–°–ö–ê–ù–ï–†</div>
        <div class="desc">–°–ø—É—Ç–Ω–∏–∫–æ–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Ä—Ä–µ–Ω–æ–≤, 8 –ø–∞–ª–∏—Ç—Ä, WebGL —à–µ–π–¥–µ—Ä—ã</div>
      </div>
      <div class="welcome-card" data-module="modules/market.html">
        <div class="icon">üìà</div>
        <div class="name">–†–´–ù–û–ö</div>
        <div class="desc">5 —Å–µ–∫—Ç–æ—Ä–æ–≤, CoinGecko API, —Å–ø–∞—Ä–∫–ª–∞–π–Ω—ã, –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏</div>
      </div>
      <div class="welcome-card" id="card-profile">
        <div class="icon">üë®‚ÄçüöÄ</div>
        <div class="name">–ö–ê–ë–ò–ù–ï–¢ –ü–ò–õ–û–¢–ê</div>
        <div class="desc">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, —Ä–µ–ø—É—Ç–∞—Ü–∏—è, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      </div>
    </div>
    <div class="news-ticker-wrap">
      <div class="news-label">–ù–û–í–û–°–¢–ò</div>
      <div class="news-scroll">
        <div class="news-content" id="welcome-news"></div>
      </div>
    </div>
  </div>
  <iframe id="module-frame" class="hidden-frame"></iframe>
</div>

<!-- PROFILE PANEL -->
<div id="profile-panel">
  <button class="prof-close" id="profile-close">‚úï</button>
  <h2>–ö–ê–ë–ò–ù–ï–¢ –ö–û–ú–ê–ù–î–û–†–ê</h2>
  <div id="profile-content"></div>
</div>

<!-- TOOLTIP -->
<div class="game-tooltip" id="game-tooltip"></div>

<!-- STATUS BAR -->
<div id="status-bar">
  <span id="status-msg">–°–∏—Å—Ç–µ–º—ã –∞–∫—Ç–∏–≤–Ω—ã. –ì–æ—Ç–æ–≤ –∫ –≤—ã–ª–µ—Ç—É.</span>
  <span id="status-loc">–°–ï–ö: Sol | –°–ò–°–¢–ï–ú–ê: ‚Äî</span>
</div>

<script>
// ============================================================
// GAME STATE ‚Äî –µ–¥–∏–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
// ============================================================
const DEFAULT_STATE = {
  pilot: { name: '–î—Ä—É–∂–∏–Ω–∏–Ω –ï–≤–≥–µ–Ω–∏–π', rank: '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü', faction: '–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ' },
  credits: 50000,
  fuel: 7.0,
  maxFuel: 7.0,
  cargo: [],
  maxCargo: 20,
  ships: [{ name: '–ö–û–ë–†–ê MK-I', level: 1 }],
  currentShip: 0,
  stations: [],
  transporters: [],
  location: { system: 'Sol', body: null },
  stats: {
    jumps: 0,
    trades: 0,
    mined: 0,
    sculpted: 0,
    planetsScanned: 0,
    roversDeployed: 0,
    stockTrades: 0,
    totalProfit: 0,
    distanceLY: 0
  },
  achievements: [],
  portfolio: {},
  reputation: { traders: 0, miners: 0, explorers: 0, military: 0 },
  savedAt: null
};

function loadGameState() {
  try {
    const raw = localStorage.getItem('elite_df_state');
    if (raw) {
      const s = JSON.parse(raw);
      return { ...DEFAULT_STATE, ...s, stats: { ...DEFAULT_STATE.stats, ...s.stats }, reputation: { ...DEFAULT_STATE.reputation, ...s.reputation } };
    }
  } catch(e) {}
  return { ...DEFAULT_STATE };
}

function saveGameState() {
  gameState.savedAt = Date.now();
  localStorage.setItem('elite_df_state', JSON.stringify(gameState));
}

let gameState = loadGameState();

function updateHUD() {
  document.getElementById('hud-credits').textContent = gameState.credits.toLocaleString('ru-RU');
  document.getElementById('hud-fuel').textContent = gameState.fuel.toFixed(1);
  document.getElementById('hud-cargo').textContent = `${gameState.cargo.length}/${gameState.maxCargo}`;
}
updateHUD();

// News content
const GAME_NEWS = [
  'üìú [–õ–û–†] 2847 –≥–æ–¥. –ß–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–æ 47 –∑–≤—ë–∑–¥–Ω—ã—Ö —Å–∏—Å—Ç–µ–º. 3 –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–∏ –¥–µ–ª—è—Ç –¢—ë–º–Ω—ã–π –§—Ä–æ–Ω—Ç–∏—Ä.',
  'üî≠ [–§–ê–ö–¢] –í–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π ‚âà2 —Ç—Ä–ª–Ω –≥–∞–ª–∞–∫—Ç–∏–∫ (Conselice et al., 2016). –ù–∞–±–ª—é–¥–∞–µ–º–∞—è –í—Å–µ–ª–µ–Ω–Ω–∞—è: 93 –º–ª—Ä–¥ —Å–≤–µ—Ç–æ–≤—ã—Ö –ª–µ—Ç –≤ –¥–∏–∞–º–µ—Ç—Ä–µ.',
  '‚ö° [–õ–û–†] AXIOM Corp –∑–∞—Ö–≤–∞—Ç–∏–ª–∞ —Å–µ–∫—Ç–æ—Ä Delta-7 ‚Äî –∑–∞–ª–µ–∂–∏ He-3 –æ–±–µ—Å–ø–µ—á–∞—Ç —Ñ–ª–æ—Ç –Ω–∞ 200 –ª–µ—Ç.',
  'üåü [–§–ê–ö–¢] –í –ú–ª–µ—á–Ω–æ–º –ü—É—Ç–∏ 100‚Äì400 –º–ª—Ä–¥ –∑–≤—ë–∑–¥. –ë–ª–∏–∂–∞–π—à–∞—è ‚Äî –ü—Ä–æ–∫—Å–∏–º–∞ –¶–µ–Ω—Ç–∞–≤—Ä–∞ (4.24 —Å–≤. –≥–æ–¥–∞).',
  'ü™ê [–§–ê–ö–¢] NASA –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–æ 5 700+ —ç–∫–∑–æ–ø–ª–∞–Ω–µ—Ç (2024). TRAPPIST-1 –∏–º–µ–µ—Ç 7 –ø–ª–∞–Ω–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–º —Å –ó–µ–º–ª—é.',
  'üõ∞Ô∏è [–õ–û–†] –°–ø—É—Ç–Ω–∏–∫ ¬´–ó–æ—Ä–∫–∏–π-14¬ª –∑–∞–≤–µ—Ä—à–∏–ª –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—é Kepler-442b. 18 –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π —Ä–µ–¥–∫–æ–∑–µ–º–æ–≤.',
  'üåç [–§–ê–ö–¢] –í –æ–±–∏—Ç–∞–µ–º–æ–π –∑–æ–Ω–µ –ú–ª–µ—á–Ω–æ–≥–æ –ü—É—Ç–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ 40 –º–ª—Ä–¥ –ø–ª–∞–Ω–µ—Ç –∑–µ–º–Ω–æ–≥–æ —Ç–∏–ø–∞ (Petigura, 2013).',
  'üíé [–§–ê–ö–¢] –ü–ª–∞–Ω–µ—Ç–∞ 55 Cancri e ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π ¬´–∞–ª–º–∞–∑–Ω—ã–π –º–∏—Ä¬ª. –ú–∞—Å—Å–∞ 8.6 –º–∞—Å—Å –ó–µ–º–ª–∏, 40 —Å–≤. –ª–µ—Ç –æ—Ç –Ω–∞—Å.',
  '‚òÄÔ∏è [–§–ê–ö–¢] –°–æ–ª–Ω—Ü–µ ‚Äî –∂—ë–ª—Ç—ã–π –∫–∞—Ä–ª–∏–∫ G2V, –≤–æ–∑—Ä–∞—Å—Ç 4.6 –º–ª—Ä–¥ –ª–µ—Ç. –ß–µ—Ä–µ–∑ 5 –º–ª—Ä–¥ –ª–µ—Ç —Å—Ç–∞–Ω–µ—Ç –∫—Ä–∞—Å–Ω—ã–º –≥–∏–≥–∞–Ω—Ç–æ–º.',
  'ü§ñ [–õ–û–†] –†–æ–≤–µ—Ä—ã ¬´–ö–∏—Ä–∏–ª–ª¬ª –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ø–æ–¥–∑–µ–º–Ω—ã–π –æ–∫–µ–∞–Ω –Ω–∞ –ï–≤—Ä–æ–ø–µ-9. –ù–∞ —Ä–µ–∞–ª—å–Ω–æ–π –ï–≤—Ä–æ–ø–µ ‚Äî 100 –∫–º –ª—å–¥–∞.',
  'üßä [–§–ê–ö–¢] –°–ø—É—Ç–Ω–∏–∫ –Æ–ø–∏—Ç–µ—Ä–∞ –ï–≤—Ä–æ–ø–∞: –ø–æ–¥–ª—ë–¥–Ω—ã–π –æ–∫–µ–∞–Ω –≥–ª—É–±–∏–Ω–æ–π –¥–æ 100 –∫–º. –í–æ–∑–º–æ–∂–Ω–∞ –∂–∏–∑–Ω—å.',
  '‚õèÔ∏è [–§–ê–ö–¢] –ê—Å—Ç–µ—Ä–æ–∏–¥ –ü—Å–∏—Ö–µ—è (16 Psyche) —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–ª–ª–æ–≤ –Ω–∞ ~$10 –∫–≤–∏–Ω—Ç–∏–ª–ª–∏–æ–Ω–æ–≤. –ú–∏—Å—Å–∏—è NASA: 2029.',
  'üìä [–§–ê–ö–¢] –ù–µ–π—Ç—Ä–æ–Ω–Ω—ã–µ –∑–≤—ë–∑–¥—ã: –ø–ª–æ—Ç–Ω–æ—Å—Ç—å 10¬π‚Å∑ –∫–≥/–º¬≥. –ß–∞–π–Ω–∞—è –ª–æ–∂–∫–∞ –≤–µ—Å–∏—Ç ~6 –º–ª—Ä–¥ —Ç–æ–Ω–Ω.',
  'üî¨ [–§–ê–ö–¢] –í–æ–¥–æ—Ä–æ–¥ ‚Äî 73% –º–∞—Å—Å—ã –í—Å–µ–ª–µ–Ω–Ω–æ–π, –≥–µ–ª–∏–π ‚Äî 25%. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –ª–∏—à—å 2%.',
  'üåå [–§–ê–ö–¢] –ú–ª–µ—á–Ω—ã–π –ü—É—Ç—å ‚Äî —Å–ø–∏—Ä–∞–ª—å–Ω–∞—è –≥–∞–ª–∞–∫—Ç–∏–∫–∞, –¥–∏–∞–º–µ—Ç—Ä ~100 000 —Å–≤. –ª–µ—Ç. –°–æ–ª–Ω—Ü–µ ‚Äî –≤ 27 000 —Å–≤. –ª–µ—Ç –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.',
  'üî¥ [–õ–û–†] –ê—Å—Ç–µ—Ä–æ–∏–¥ S-47 –Ω–∞ –≤—Å—Ç—Ä–µ—á–Ω–æ–º –∫—É—Ä—Å–µ —Å –∫–æ–Ω–≤–æ–µ–º ¬´–û—Ä–∏–æ–Ω¬ª. –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ 1.1 –º–ª–Ω –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤ –∏–∑–≤–µ—Å—Ç–Ω–æ.',
  'üè≠ [–õ–û–†] –°—Ç–∞–Ω—Ü–∏—è ¬´–û–ª–∏–º–ø¬ª ‚Äî 14 –º–æ–¥—É–ª–µ–π, 3000 –∂–∏—Ç–µ–ª–µ–π. –ú–ö–° —Ä–µ–∞–ª—å–Ω–æ –≤–µ—Å–∏—Ç 420 —Ç–æ–Ω–Ω –∏ –≤–º–µ—â–∞–µ—Ç 6 —á–µ–ª–æ–≤–µ–∫.',
  'üöÄ [–§–ê–ö–¢] –°–∫–æ—Ä–æ—Å—Ç—å —Å–≤–µ—Ç–∞ ‚Äî 299 792 –∫–º/—Å. –î–æ –ü—Ä–æ–∫—Å–∏–º—ã –¶–µ–Ω—Ç–∞–≤—Ä–∞ —Å–≤–µ—Ç –ª–µ—Ç–∏—Ç 4.24 –≥–æ–¥–∞.',
  '‚öîÔ∏è [–õ–û–†] –ü–∏—Ä–∞—Ç—Å–∫–∏–π —Ñ–ª–æ—Ç ¬´–¢—ë–º–Ω—ã–π –ö–æ–≥–æ—Ç—å¬ª –∞—Ç–∞–∫–æ–≤–∞–ª –∫–æ–Ω–≤–æ–π —É Wolf 359 (7.86 —Å–≤. –ª–µ—Ç –æ—Ç –°–æ–ª–Ω—Ü–∞ ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è –∑–≤–µ–∑–¥–∞).',
  'üèóÔ∏è [–§–ê–ö–¢] –í –°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ 8 –ø–ª–∞–Ω–µ—Ç, 5 –∫–∞—Ä–ª–∏–∫–æ–≤—ã—Ö –ø–ª–∞–Ω–µ—Ç, 290+ —Å–ø—É—Ç–Ω–∏–∫–æ–≤, 1.1 –º–ª–Ω –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤.',
];
const newsEl = document.getElementById('welcome-news');
if (newsEl) {
  newsEl.textContent = GAME_NEWS.join('   ‚óè   ');
  const newsScroll = newsEl.parentElement;
  let newsOffset = newsScroll ? newsScroll.clientWidth || 900 : 900;
  function tickNews() {
    const tw = newsEl.scrollWidth || 3000;
    const sw = newsScroll ? newsScroll.clientWidth || 900 : 900;
    newsOffset -= 1.2;
    if (newsOffset < -tw) newsOffset = sw;
    newsEl.style.left = 'auto';
    newsEl.style.transform = 'translateY(-50%) translateX(' + newsOffset + 'px)';
    requestAnimationFrame(tickNews);
  }
  tickNews();
}

// Auto-save every 30s
setInterval(() => { saveGameState(); }, 30000);

// ============================================================
// NAVIGATION
// ============================================================
const navBtns = document.querySelectorAll('.nav-btn[data-module]');
const welcomeCards = document.querySelectorAll('.welcome-card[data-module]');
const welcomeScreen = document.getElementById('welcome-screen');
const moduleFrame = document.getElementById('module-frame');
let currentModule = 'welcome';

function navigateTo(module) {
  navBtns.forEach(b => b.classList.remove('active'));
  const target = document.querySelector(`.nav-btn[data-module="${module}"]`);
  if (target) target.classList.add('active');

  if (module === 'welcome') {
    welcomeScreen.classList.remove('hidden');
    moduleFrame.style.display = 'none';
    moduleFrame.src = 'about:blank';
    currentModule = 'welcome';
    document.getElementById('status-msg').textContent = '–°–∏—Å—Ç–µ–º—ã –∞–∫—Ç–∏–≤–Ω—ã. –ì–æ—Ç–æ–≤ –∫ –≤—ã–ª–µ—Ç—É.';
    return;
  }

  welcomeScreen.classList.add('hidden');
  moduleFrame.style.display = 'block';
  moduleFrame.src = module;
  currentModule = module;

  const names = {
    'modules/starmap.html': '–ö–ê–†–¢–ê –ù–ï–ë–ê',
    'modules/constructors.html': '–í–ï–†–§–¨',
    'modules/mining.html': '–î–û–ë–´–ß–ê',
    'modules/asteroid.html': '–ê–°–¢–ï–†–û–ò–î',
    'modules/planetarium.html': '–ü–õ–ê–ù–ï–¢–ê–†–ò–ô',
    'modules/rover.html': '–†–û–í–ï–†',
    'modules/terraforming.html': '–°–ö–ê–ù–ï–†',
    'modules/market.html': '–†–´–ù–û–ö'
  };
  document.getElementById('status-msg').textContent = `–ú–æ–¥—É–ª—å: ${names[module] || module}`;
}

navBtns.forEach(btn => {
  btn.addEventListener('click', () => navigateTo(btn.dataset.module));
});
welcomeCards.forEach(card => {
  card.addEventListener('click', () => navigateTo(card.dataset.module));
});
document.getElementById('logo-btn').addEventListener('click', () => navigateTo('welcome'));

// ============================================================
// PROFILE PANEL
// ============================================================
const profilePanel = document.getElementById('profile-panel');
const profileContent = document.getElementById('profile-content');

document.getElementById('profile-btn').addEventListener('click', () => {
  profilePanel.classList.toggle('open');
  if (profilePanel.classList.contains('open')) renderProfile();
});
document.getElementById('profile-close').addEventListener('click', () => {
  profilePanel.classList.remove('open');
});
document.getElementById('card-profile').addEventListener('click', () => {
  profilePanel.classList.add('open');
  renderProfile();
});

function calcSkills(s) {
  const skills = {
    navigation: { name: '–ù–∞–≤–∏–≥–∞—Ü–∏—è', icon: 'üß≠', xp: s.stats.jumps * 10 + s.stats.distanceLY * 2 },
    trade: { name: '–¢–æ—Ä–≥–æ–≤–ª—è', icon: 'üí∞', xp: s.stats.trades * 15 + s.stats.stockTrades * 10 },
    mining: { name: '–î–æ–±—ã—á–∞', icon: '‚õèÔ∏è', xp: s.stats.mined * 12 + (s.stats.sculpted || 0) * 5 },
    exploration: { name: '–†–∞–∑–≤–µ–¥–∫–∞', icon: 'üî≠', xp: s.stats.planetsScanned * 20 + s.stats.roversDeployed * 15 },
    engineering: { name: '–ò–Ω–∂–µ–Ω–µ—Ä–∏—è', icon: 'üîß', xp: Math.floor(s.credits / 1000) + s.cargo.length * 5 },
    combat: { name: '–ë–æ–µ–≤—ã–µ', icon: '‚öîÔ∏è', xp: s.stats.mined * 3 + s.stats.jumps * 2 },
  };
  Object.values(skills).forEach(sk => {
    sk.level = Math.min(50, Math.floor(Math.sqrt(sk.xp / 10)));
    sk.nextXP = Math.pow(sk.level + 1, 2) * 10;
    sk.pct = sk.nextXP > 0 ? Math.min(100, (sk.xp / sk.nextXP) * 100) : 100;
  });
  return skills;
}

function renderProfile() {
  const s = gameState;
  const cargoWeight = s.cargo.reduce((sum, c) => sum + (c.qty || 1), 0);
  const ranks = ['–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü','–ü–∏–ª–æ—Ç','–ù–∞–≤–∏–≥–∞—Ç–æ—Ä','–ö–∞–ø–∏—Ç–∞–Ω','–ö–æ–º–º–∞–Ω–¥–µ—Ä','–ê–¥–º–∏—Ä–∞–ª','–≠–ª–∏—Ç–∞'];
  const skills = calcSkills(s);
  const totalLevel = Object.values(skills).reduce((sum, sk) => sum + sk.level, 0);
  const rankIdx = Math.min(ranks.length - 1, Math.floor(totalLevel / 10));
  s.pilot.rank = ranks[rankIdx];
  const xp = Object.values(skills).reduce((sum, sk) => sum + sk.xp, 0);
  const nextRankXP = (rankIdx + 1) * 600;
  const pct = Math.min(100, (xp / nextRankXP) * 100);

  let html = `
    <div class="prof-row"><span class="prof-label">–ò–ú–Ø:</span><span class="prof-val">${s.pilot.name}</span></div>
    <div class="prof-row"><span class="prof-label">–†–ê–ù–ì:</span><span class="prof-val">${s.pilot.rank} <span class="level-badge">LV ${totalLevel}</span></span></div>
    <div class="prof-row"><span class="prof-label">–§–†–ê–ö–¶–ò–Ø:</span><span class="prof-val">${s.pilot.faction}</span></div>
    <div class="prof-bar-wrap"><span class="prof-label" style="width:60px">XP:</span><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${pct}%"></div></div><span class="prof-val">${xp}/${nextRankXP}</span></div>

    <div class="prof-section">
      <div class="prof-section-title">–ù–ê–í–´–ö–ò</div>
      <div class="skill-tree">
        ${Object.entries(skills).map(([k, sk]) => `
          <div class="skill-item ${sk.level > 0 ? 'unlocked' : ''}">
            <div style="font-size:20px;">${sk.icon}</div>
            <div class="skill-name">${sk.name}</div>
            <div class="skill-level">LV ${sk.level}</div>
            <div class="skill-bar"><div class="skill-fill" style="width:${sk.pct}%"></div></div>
            <div style="font-size:11px;color:#886622;">${sk.xp}/${sk.nextXP} XP</div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–§–ò–ù–ê–ù–°–´</div>
      <div class="prof-row"><span class="prof-label">–ö—Ä–µ–¥–∏—Ç—ã:</span><span class="prof-val">${s.credits.toLocaleString('ru-RU')} CR</span></div>
      <div class="prof-row"><span class="prof-label">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å:</span><span class="prof-val">${s.stats.totalProfit.toLocaleString('ru-RU')} CR</span></div>
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–ö–û–†–ê–ë–õ–¨</div>
      <div class="prof-row"><span class="prof-label">–ú–æ–¥–µ–ª—å:</span><span class="prof-val">${s.ships[s.currentShip]?.name || '‚Äî'}</span></div>
      <div class="prof-row"><span class="prof-label">–¢–æ–ø–ª–∏–≤–æ:</span><span class="prof-val">${s.fuel.toFixed(1)} / ${s.maxFuel.toFixed(1)}</span></div>
      <div class="prof-bar-wrap"><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${(s.fuel/s.maxFuel*100).toFixed(0)}%; background: linear-gradient(90deg, #ff4444, #ffaa00, #88ff88)"></div></div></div>
      <div class="prof-row"><span class="prof-label">–ì—Ä—É–∑:</span><span class="prof-val">${cargoWeight} / ${s.maxCargo} —Ç</span></div>
      <div class="prof-bar-wrap"><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${(cargoWeight/s.maxCargo*100).toFixed(0)}%"></div></div></div>
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
      <div class="prof-row"><span class="prof-label">–ü—Ä—ã–∂–∫–æ–≤:</span><span class="prof-val">${s.stats.jumps}</span></div>
      <div class="prof-row"><span class="prof-label">–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</span><span class="prof-val">${s.stats.distanceLY.toFixed(1)} LY</span></div>
      <div class="prof-row"><span class="prof-label">–¢–æ—Ä–≥–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫:</span><span class="prof-val">${s.stats.trades}</span></div>
      <div class="prof-row"><span class="prof-label">–î–æ–±—ã—Ç–æ —Ä—É–¥—ã:</span><span class="prof-val">${s.stats.mined}</span></div>
      <div class="prof-row"><span class="prof-label">–ü–ª–∞–Ω–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:</span><span class="prof-val">${s.stats.planetsScanned}</span></div>
      <div class="prof-row"><span class="prof-label">–†–æ–≤–µ—Ä–æ–≤ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ:</span><span class="prof-val">${s.stats.roversDeployed}</span></div>
      <div class="prof-row"><span class="prof-label">–°–¥–µ–ª–æ–∫ –Ω–∞ –±–∏—Ä–∂–µ:</span><span class="prof-val">${s.stats.stockTrades}</span></div>
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–†–ï–ü–£–¢–ê–¶–ò–Ø</div>
      ${Object.entries(s.reputation).map(([k, v]) => {
        const names = { traders:'–¢–æ—Ä–≥–æ–≤—Ü—ã', miners:'–®–∞—Ö—Ç—ë—Ä—ã', explorers:'–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏', military:'–í–æ–µ–Ω–Ω—ã–µ' };
        const rpct = Math.min(100, Math.max(0, v));
        return `<div class="prof-row"><span class="prof-label">${names[k]||k}:</span><span class="prof-val">${v}</span></div>
        <div class="prof-bar-wrap"><div class="prof-bar-bg"><div class="prof-bar-fill" style="width:${rpct}%"></div></div></div>`;
      }).join('')}
    </div>

    <div class="prof-section">
      <div class="prof-section-title">–ì–†–£–ó</div>
      ${s.cargo.length === 0 ? '<div style="color:#886622;text-align:center;">–¢—Ä—é–º –ø—É—Å—Ç</div>' :
        s.cargo.map(c => `<div class="prof-row"><span class="prof-label">${c.name}:</span><span class="prof-val">${c.qty || 1} —Ç</span></div>`).join('')}
    </div>
  `;
  profileContent.innerHTML = html;
}

// ============================================================
// CROSS-MODULE COMMUNICATION (postMessage)
// ============================================================
window.addEventListener('message', (e) => {
  if (!e.data || !e.data.type) return;
  const msg = e.data;

  switch (msg.type) {
    case 'credits_change':
      gameState.credits += msg.amount;
      if (msg.amount > 0) gameState.stats.totalProfit += msg.amount;
      updateHUD(); saveGameState();
      flashHUD('hud-credits');
      break;
    case 'fuel_change':
      gameState.fuel = Math.max(0, Math.min(gameState.maxFuel, gameState.fuel + msg.amount));
      updateHUD(); saveGameState();
      flashHUD('hud-fuel');
      break;
    case 'cargo_add':
      if (gameState.cargo.length < gameState.maxCargo) {
        gameState.cargo.push({ name: msg.name, qty: msg.qty || 1, price: msg.price || 0 });
        updateHUD(); saveGameState();
        flashHUD('hud-cargo');
      }
      break;
    case 'cargo_sell':
      const idx = gameState.cargo.findIndex(c => c.name === msg.name);
      if (idx >= 0) {
        const item = gameState.cargo.splice(idx, 1)[0];
        gameState.credits += msg.price || item.price || 0;
        gameState.stats.trades++;
        gameState.stats.totalProfit += msg.price || item.price || 0;
        updateHUD(); saveGameState();
      }
      break;
    case 'stat_increment':
      if (gameState.stats[msg.stat] !== undefined) {
        gameState.stats[msg.stat] += msg.amount || 1;
        saveGameState();
      }
      break;
    case 'ship_upgrade':
      if (msg.shipName) {
        gameState.ships[gameState.currentShip].name = msg.shipName;
        gameState.ships[gameState.currentShip].level = msg.level || 1;
        saveGameState();
      }
      break;
    case 'location_update':
      gameState.location.system = msg.system || gameState.location.system;
      gameState.location.body = msg.body || null;
      document.getElementById('status-loc').textContent = `–°–ï–ö: ${gameState.location.system} | ${msg.body || '‚Äî'}`;
      saveGameState();
      break;
    case 'get_state':
      moduleFrame.contentWindow.postMessage({ type: 'game_state', state: gameState }, '*');
      break;
    case 'status_msg':
      const smEl = document.getElementById('status-msg');
      smEl.textContent = msg.text;
      smEl.classList.remove('flash');
      void smEl.offsetWidth;
      smEl.classList.add('flash');
      break;
  }
});

// Send state to iframe when it loads
moduleFrame.addEventListener('load', () => {
  if (moduleFrame.src && moduleFrame.src !== 'about:blank') {
    setTimeout(() => {
      try {
        moduleFrame.contentWindow.postMessage({ type: 'game_state', state: gameState }, '*');
      } catch(e) {}
    }, 500);
  }
});

// ============================================================
// HUD FLASH
// ============================================================
function flashHUD(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('flash');
  void el.offsetWidth;
  el.classList.add('flash');
  setTimeout(() => el.classList.remove('flash'), 600);
}

// ============================================================
// TOOLTIP SYSTEM
// ============================================================
const tooltipEl = document.getElementById('game-tooltip');
const TIPS = {
  'modules/starmap.html': '–ö–∞—Ä—Ç–∞ 5000+ –∑–≤—ë–∑–¥. –õ–ö–ú-—Ç—è–Ω—É—Ç—å ‚Äî –≤—Ä–∞—â–µ–Ω–∏–µ, –ü–ö–ú-—Ç—è–Ω—É—Ç—å ‚Äî –ø–∞–Ω, –∫–æ–ª–µ—Å–æ ‚Äî –∑—É–º. WASD ‚Äî –ø–æ–ª—ë—Ç. 2x–∫–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–µ ‚Äî –ø–µ—Ä–µ–ª—ë—Ç. –ö–ª–∏–∫ –ø–æ –ø–ª–∞–Ω–µ—Ç–µ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è. –°–ø—Ä–∞–≤–∞: —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ, –º–∏—Å—Å–∏–∏, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è.',
  'modules/constructors.html': '–í–µ—Ä—Ñ—å: 3 –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ (–∫–æ—Ä–∞–±–ª—å, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —Å—Ç–∞–Ω—Ü–∏—è). ‚ûï ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å (–¥–æ 14), ‚úñ ‚Äî —Å–±—Ä–æ—Å. –¢—è–Ω—É—Ç—å –º—ã—à—å—é ‚Äî –≤—Ä–∞—â–∞—Ç—å. –ú–æ–¥–µ–ª–∏ –∫—Ä—É—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –¥–∞—ë—Ç —Å—Ç–∞—Ç—ã.',
  'modules/mining.html': '–î–æ–±—ã—á–∞: ‚ûï ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å –∫–æ—Ä–∞–±–ª—é, ‚õè ‚Äî —Ä–µ–∂–∏–º —Å—Ç—Ä–µ–ª—å–±—ã (–∫–ª–∏–∫–∞–π –ø–æ –∞—Å—Ç–µ—Ä–æ–∏–¥–∞–º). ‚úñ ‚Äî —Å–±—Ä–æ—Å. 14 —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω—ã—Ö = —Ä—É–¥–∞ –≤ —Ç—Ä—é–º. –†–µ—Å—É—Ä—Å—ã –∏–¥—É—Ç –Ω–∞ —Ä—ã–Ω–æ–∫.',
  'modules/asteroid.html': '–°–∫—É–ª—å–ø—Ç–∏–Ω–≥: –õ–ö–ú ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ (7 —Å—Ç–∞–¥–∏–π), Ctrl+–º—ã—à—å ‚Äî –∫–∏—Å—Ç—å 150px. –°–ø—Ä–∞–≤–∞ ‚Äî 10 –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤. 2x–∫–ª–∏–∫ –ø–æ —Å–æ—Å–µ–¥–Ω–µ–º—É –∞—Å—Ç–µ—Ä–æ–∏–¥—É ‚Äî –≤—ã–±—Ä–∞—Ç—å. –ö–ª–∏–∫ ¬´—É—Ä–æ–≤–µ–Ω—å¬ª ‚Äî —Å–ª–µ–¥—É—é—â–∏–π.',
  'modules/planetarium.html': '–ü–ª–∞–Ω–µ—Ç–∞—Ä–∏–π: 8 —Ç–∏–ø–æ–≤ –ø–ª–∞–Ω–µ—Ç (–≤–Ω–∏–∑—É). –ö–∞–∂–¥–∞—è —Å –∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π, –∫–æ–ª—å—Ü–∞–º–∏, —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞—è. –î–æ–±—ã—á–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —ç–∫–æ–Ω–æ–º–∏–∫–µ.',
  'modules/rover.html': '–†–æ–≤–µ—Ä –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–π –ø–ª–∞–Ω–µ—Ç–µ. WASD ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ. ‚ûï ‚Äî –Ω–æ–≤—ã–π —Ä–æ–≤–µ—Ä, ‚ûñ ‚Äî —É–¥–∞–ª–∏—Ç—å, üöÄ ‚Äî –∑–∞–ø—É—Å–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –æ—Ä–±–∏—Ç—É, üé≤ ‚Äî –Ω–æ–≤—ã–π –º–∏—Ä. –†–µ—Å—É—Ä—Å—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏.',
  'modules/terraforming.html': '–°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Å–∫–∞–Ω–µ—Ä: —Ç—è–Ω—É—Ç—å –º—ã—à—å—é ‚Äî –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫–∞—Ä—Ç—ã, –∫–æ–ª–µ—Å–æ ‚Äî –∑—É–º. üé≤ ‚Äî –Ω–æ–≤—ã–π —Å–∫–∞–Ω –ø–ª–∞–Ω–µ—Ç—ã. ‚õè ‚Äî —Ä–∞–∑–≤–µ–¥–∫–∞ (–¥–æ–±—ã—Ç—å —Ä–µ—Å—É—Ä—Å –≤ —Ç—Ä—é–º). 8 –±–∏–æ–º–æ–≤.',
  'modules/market.html': '–ë–∏—Ä–∂–∞: 5 —Å–µ–∫—Ç–æ—Ä–æ–≤ (–¥–æ–±—ã—á–∞, —ç–Ω–µ—Ä–≥–∏—è, –±–∏–æ, —Ö–∞–π—Ç–µ–∫, —Ä–æ—Å–∫–æ—à—å). –°–ø–∞—Ä–∫–ª–∞–π–Ω—ã ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω. –ü–æ–∫—É–ø–∞–π/–ø—Ä–æ–¥–∞–≤–∞–π –∞–∫—Ü–∏–∏. –¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è. –°–≤—è–∑–∞–Ω–æ —Å –¥–æ–±—ã—á–µ–π.'
};

document.querySelectorAll('.nav-btn[data-module], .welcome-card[data-module]').forEach(el => {
  el.addEventListener('mouseenter', (e) => {
    const mod = el.dataset.module;
    if (!TIPS[mod]) return;
    tooltipEl.textContent = TIPS[mod];
    tooltipEl.classList.add('visible');
    const rect = el.getBoundingClientRect();
    tooltipEl.style.left = Math.min(rect.left, window.innerWidth - 290) + 'px';
    tooltipEl.style.top = (rect.bottom + 8) + 'px';
  });
  el.addEventListener('mouseleave', () => {
    tooltipEl.classList.remove('visible');
  });
});

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (profilePanel.classList.contains('open')) {
      profilePanel.classList.remove('open');
    } else if (currentModule !== 'welcome') {
      navigateTo('welcome');
    }
  }
});
</script>
</body>
</html>
